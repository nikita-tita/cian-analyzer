# Deployment Workflow Template
#
# IMPORTANT: This is a TEMPLATE file. To use it:
# 1. Rename to deploy.yml
# 2. Configure GitHub Secrets (Settings -> Secrets and variables -> Actions):
#    - SSH_HOST: your server IP or hostname
#    - SSH_USERNAME: server username
#    - SSH_PRIVATE_KEY: SSH private key for authentication
#    - SSH_PORT: SSH port (default: 22)
# 3. Update deployment commands for your infrastructure
# 4. Uncomment and customize as needed

name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: production  # Requires approval for production deploys

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # Option 1: Direct SSH Deployment
    - name: Deploy via SSH
      run: |
        ssh -p ${{ secrets.SSH_PORT }} \
          ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'

          # Navigate to app directory
          cd /var/www/housler

          # Pull latest code
          git pull origin main

          # Activate virtual environment
          source venv/bin/activate

          # Install/update dependencies
          pip install -r requirements.txt

          # Run database migrations (if any)
          # flask db upgrade

          # Restart application
          sudo systemctl restart housler

          # Health check
          sleep 5
          curl -f http://localhost:5000/health || exit 1

          echo "Deployment successful!"
        EOF

    # Option 2: Docker Deployment
    # - name: Build and push Docker image
    #   run: |
    #     docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
    #     docker build -t housler:${{ github.sha }} .
    #     docker tag housler:${{ github.sha }} housler:latest
    #     docker push housler:${{ github.sha }}
    #     docker push housler:latest

    # - name: Deploy to Docker host
    #   run: |
    #     ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
    #       docker pull housler:latest
    #       docker stop housler || true
    #       docker rm housler || true
    #       docker run -d \
    #         --name housler \
    #         -p 5000:5000 \
    #         --env-file /etc/housler/.env \
    #         --restart unless-stopped \
    #         housler:latest
    #     EOF

    # Option 3: Deploy to Cloud Platform (Railway, Heroku, etc.)
    # - name: Deploy to Railway
    #   uses: railwayapp/railway-deploy-action@v1
    #   with:
    #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
    #     service: housler

    - name: Verify deployment
      run: |
        # Wait for application to start
        sleep 10

        # Health check
        response=$(curl -s -o /dev/null -w "%{http_code}" https://your-domain.com/health)
        if [ $response -eq 200 ]; then
          echo "âœ… Deployment successful - health check passed"
        else
          echo "âŒ Health check failed with status $response"
          exit 1
        fi

    - name: Notify on success
      if: success()
      run: |
        echo "ðŸš€ Deployment completed successfully!"
        # Add notification logic (Slack, Telegram, etc.)

    - name: Rollback on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed, initiating rollback..."
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /var/www/housler
          git reset --hard HEAD~1
          sudo systemctl restart housler
        EOF
        # Add failure notification

    - name: Create deployment summary
      if: always()
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY

  # Optional: Database backup before deploy
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    if: false  # Enable if you have a database

    steps:
    - name: Backup database
      run: |
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
          # Backup PostgreSQL
          pg_dump -U housler housler_db > /backups/housler_$(date +%Y%m%d_%H%M%S).sql

          # Or backup Redis
          redis-cli --rdb /backups/redis_$(date +%Y%m%d_%H%M%S).rdb
        EOF

  # Optional: Run smoke tests after deploy
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Run smoke tests
      run: |
        # Test critical endpoints
        curl -f https://your-domain.com/health || exit 1
        curl -f https://your-domain.com/ || exit 1
        curl -f https://your-domain.com/api/csrf-token || exit 1

        echo "âœ… All smoke tests passed"
