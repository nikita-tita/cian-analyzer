name: Auto Deploy on Push

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - production
          - staging

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-server
        sudo systemctl start redis-server

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m playwright install chromium

    - name: Run tests
      run: |
        python -m pytest tests/ \
          --ignore=tests/test_e2e_full_flow.py \
          -v \
          --cov=src \
          --cov-report=term-missing

    - name: Check code quality
      continue-on-error: true
      run: |
        pip install flake8 black
        flake8 src/ --max-line-length=120 --extend-ignore=E203,W503 || true
        black --check src/ || true

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t housler-app:${{ github.sha }} .
        docker tag housler-app:${{ github.sha }} housler-app:latest

    - name: Test Docker image
      run: |
        docker run --rm housler-app:latest python --version
        docker images housler-app

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH (if secrets configured)
      if: ${{ secrets.SSH_PRIVATE_KEY != '' }}
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy via SSH
      if: ${{ secrets.SSH_HOST != '' && secrets.SSH_PRIVATE_KEY != '' }}
      run: |
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
          cd /var/www/housler || cd ~/housler || exit 1

          # Pull latest code
          git pull origin main || git pull origin master

          # Run deployment script
          bash scripts/auto-deploy.sh production true

          # Health check
          sleep 10
          curl -f http://localhost:5000/health || exit 1

          echo "‚úÖ Deployment successful!"
        ENDSSH

    - name: Deploy notification (if no SSH configured)
      if: ${{ secrets.SSH_HOST == '' || secrets.SSH_PRIVATE_KEY == '' }}
      run: |
        echo "‚ö†Ô∏è  SSH deployment not configured"
        echo ""
        echo "To enable automatic deployment, add these secrets to your repository:"
        echo "  - SSH_HOST: Your server IP or hostname"
        echo "  - SSH_USERNAME: SSH username"
        echo "  - SSH_PRIVATE_KEY: SSH private key"
        echo ""
        echo "For now, you can deploy manually with:"
        echo "  bash scripts/auto-deploy.sh"

    - name: Create deployment summary
      if: always()
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ secrets.SSH_HOST }}" != "" ]; then
          echo "‚úÖ Deployed to: ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è  Manual deployment required" >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
    - name: Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ Deployment completed successfully!"
        else
          echo "‚ùå Deployment failed or was skipped"
        fi
