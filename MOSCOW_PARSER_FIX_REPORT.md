# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì: –ü–∞—Ä—Å–µ—Ä –¶–ò–ê–ù –¥–ª—è –ú–æ—Å–∫–≤—ã

**–î–∞—Ç–∞:** 2025-11-17
**–ö–æ–º–º–∏—Ç:** `4821952` - fix: resolve Moscow parser issue - support www.cian.ru URLs
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì:** –ü–∞—Ä—Å–µ—Ä –¶–ò–ê–ù –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –¥–ª—è –º–æ—Å–∫–æ–≤—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å URL –≤–∏–¥–∞ `https://www.cian.ru/...`

### –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

1. **–§—É–Ω–∫—Ü–∏—è `detect_region_from_url`** –ù–ï —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª–∞ `www.cian.ru` –∫–∞–∫ –ú–æ—Å–∫–≤—É
   - –ü—Ä–æ–≤–µ—Ä—è–ª–∞ —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞ (`moskva`, `moscow`, `/msk/`)
   - –î–ª—è URL `www.cian.ru` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ `None`

2. **Registry** —Å–æ–∑–¥–∞–≤–∞–ª –ø–∞—Ä—Å–µ—Ä –ë–ï–ó —É–∫–∞–∑–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ä–µ–≥–∏–æ–Ω –°–ü–± (`region='spb'`)
   - –°–æ–∑–¥–∞–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö URL

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –í—Å–µ –º–æ—Å–∫–æ–≤—Å–∫–∏–µ URL –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `None` ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. `src/parsers/playwright_parser.py`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è `www.cian.ru` –∫–∞–∫ –ú–æ—Å–∫–≤—ã:

```python
def detect_region_from_url(url: str) -> str:
    url_lower = url.lower()

    # –ü–†–ò–û–†–ò–¢–ï–¢ 1: –°–ü–± (—è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–∞)
    if any(word in url_lower for word in ['spb.cian.ru', ...]):
        return 'spb'

    # –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ú–æ—Å–∫–≤–∞ (—è–≤–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è)
    if any(word in url_lower for word in ['moskva', 'moscow', ...]):
        return 'msk'

    # –ü–†–ò–û–†–ò–¢–ï–¢ 3: www.cian.ru = –ú–æ—Å–∫–≤–∞ (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω –¶–ò–ê–ù)
    if 'www.cian.ru' in url_lower or url_lower.startswith('https://cian.ru'):
        return 'msk'

    return None
```

**–ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:** `www.cian.ru` —Ç–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –ú–æ—Å–∫–≤–∞ (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω –¶–ò–ê–ù)

### 2. `src/parsers/parser_registry.py`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞:

```python
def get_parser(self, url: str = None, source_name: str = None):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω –∏–∑ URL (–¥–ª—è –¶–ò–ê–ù)
    region = None
    if source_name == 'cian' and url:
        from .playwright_parser import detect_region_from_url
        region = detect_region_from_url(url)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á –∫—ç—à–∞ —Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–∞
    cache_key = f"{source_name}_{region}" if region else source_name

    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–≥–∏–æ–Ω–∞
    if source_name == 'cian' and region:
        parser_instance = parser_class(..., region=region)
        self._parser_instances[cache_key] = parser_instance
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–ª—è –¶–ò–ê–ù —Ä–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ URL
- –°–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã: `cian_msk` –∏ `cian_spb`
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ URL

```bash
python test_moscow_parser_fix.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ PASS - –ú–æ—Å–∫–≤–∞ (www.cian.ru)       - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –¢–ï–°–¢**
- ‚úÖ PASS - –°–ü–± (spb.cian.ru)
- ‚úÖ PASS - –ú–æ—Å–∫–≤–∞ (moskva.cian.ru)
- ‚úÖ PASS - –ú–æ—Å–∫–≤–∞ (cian.ru –±–µ–∑ www)
- ‚úÖ PASS - –ú–æ—Å–∫–≤–∞ –∞—Ä–µ–Ω–¥–∞
- ‚úÖ PASS - –ú–æ—Å–∫–≤–∞ (moscow.cian.ru)

**–ò–¢–û–ì–û: 6/6 –ø—Ä–æ–π–¥–µ–Ω–æ** ‚úÖ

### –¢–µ—Å—Ç 2: –†–µ–∞–ª—å–Ω—ã–π –º–æ—Å–∫–æ–≤—Å–∫–∏–π –æ–±—ä–µ–∫—Ç

```bash
python test_moscow_real_object.py
```

**–û–±—ä–µ–∫—Ç:** 2-–∫–æ–º–Ω 38.7–º¬≤, 12 690 000‚ÇΩ, –ê–≤–∞–Ω–≥–∞—Ä–¥–Ω–∞—è —É–ª., 8–ö3, –ú–æ—Å–∫–≤–∞
**URL:** https://www.cian.ru/sale/flat/320010898/

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –ü–∞—Ä—Å–µ—Ä –ø–æ–ª—É—á–µ–Ω: `CianParser`
- ‚úÖ –†–µ–≥–∏–æ–Ω –ø–∞—Ä—Å–µ—Ä–∞: `msk` (–ú–æ—Å–∫–≤–∞)
- ‚úÖ –≠–∫–∑–µ–º–ø–ª—è—Ä —Å–æ–∑–¥–∞–Ω: `cian_msk`

**–¢–ï–°–¢ –ü–†–û–ô–î–ï–ù** ‚úÖ

---

## üìä –í–ª–∏—è–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –ú–æ—Å–∫–æ–≤—Å–∫–∏–µ URL ‚Üí `None` ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫–∏ –¥–ª—è 95% –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ú–æ—Å–∫–≤–µ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ `www.cian.ru` ‚Üí —Ä–µ–≥–∏–æ–Ω `msk` ‚Üí –ø–∞—Ä—Å–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
- ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –¥–ª—è –ú–æ—Å–∫–≤—ã –∏ –°–ü–±
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîÑ –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–¢–ï–°–¢ 3 –∏–∑ –æ—Ç—á—ë—Ç–∞:** –ü–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å –ø–æ–∏—Å–∫–æ–º –∞–Ω–∞–ª–æ–≥–æ–≤
   ```bash
   python test_api.py https://www.cian.ru/sale/flat/320010898/
   ```
   **–û–∂–∏–¥–∞–µ—Ç—Å—è:**
   - ‚úÖ –û–±—ä–µ–∫—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω
   - ‚úÖ –†–µ–≥–∏–æ–Ω: –ú–û–°–ö–í–ê
   - ‚úÖ –ù–∞–π–¥–µ–Ω—ã –∞–Ω–∞–ª–æ–≥–∏ –≤ –ú–æ—Å–∫–≤–µ

2. **–î–µ–ø–ª–æ–π –Ω–∞ production:**
   ```bash
   ./DEPLOY_NOW.sh
   ```

3. **E2E —Ç–µ—Å—Ç—ã:**
   ```bash
   source venv/bin/activate
   python scripts/test_e2e.py
   ```

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
URL ‚Üí detect_region_from_url() ‚Üí region ('msk'/'spb')
                                     ‚Üì
                        registry.get_parser(url)
                                     ‚Üì
                        cache_key = f"cian_{region}"
                                     ‚Üì
                        CianParser(region=region)
                                     ‚Üì
                        parser_instances['cian_msk']
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞

1. **–°–ü–±:** `spb.cian.ru` (—è–≤–Ω—ã–π –ø–æ–¥–¥–æ–º–µ–Ω)
2. **–ú–æ—Å–∫–≤–∞ (—è–≤–Ω–æ):** `moskva.cian.ru`, `moscow.cian.ru`, `/msk/`
3. **–ú–æ—Å–∫–≤–∞ (–¥–µ—Ñ–æ–ª—Ç):** `www.cian.ru`, `cian.ru` (–±–µ–∑ –ø–æ–¥–¥–æ–º–µ–Ω–∞)
4. **Fallback:** `None` ‚Üí –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

---

## ‚úÖ –í—ã–≤–æ–¥—ã

1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –º–æ—Å–∫–æ–≤—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–ø–µ—Ä—å –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** - 6/6 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ + 1 —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
3. **–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
4. **–£–ª—É—á—à–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –¥–ª—è —Ä–µ–≥–∏–æ–Ω–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ READY FOR PRODUCTION

---

## üìé –°—Å—ã–ª–∫–∏

- **–ö–æ–º–º–∏—Ç:** `4821952` - fix: resolve Moscow parser issue - support www.cian.ru URLs
- **–¢–µ—Å—Ç—ã:** `test_moscow_parser_fix.py`, `test_moscow_real_object.py`
- **–§–∞–π–ª—ã:** `src/parsers/playwright_parser.py`, `src/parsers/parser_registry.py`
