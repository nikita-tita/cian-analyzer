# Vercel Deployment - Troubleshooting Guide

## Проблемы с деплоем на Vercel и их решения

### Основные проблемы, которые были решены:

---

## 1. ❌ Проблема: Redis зависимость

### Симптомы:
- Деплой падает с ошибкой установки зависимостей
- В requirements.txt был указан `redis>=5.0.0`

### Причина:
Redis был добавлен как обязательная зависимость, но на Vercel он не нужен (используется in-memory хранилище)

### ✅ Решение:
Redis зависимость удалена из [requirements.txt](requirements.txt). Session storage автоматически использует in-memory хранилище, если Redis недоступен.

```python
# src/utils/session_storage.py - автоматический fallback
if not redis_url:
    logger.info("No REDIS_URL found, using in-memory storage")
```

---

## 2. ❌ Проблема: Ограничения Vercel Serverless

### Симптомы:
- Таймауты при парсинге
- 502 Bad Gateway
- Out of memory

### Причина:
Vercel имеет жесткие лимиты для serverless функций:
- **Время выполнения**: 10-60 секунд (в зависимости от плана)
- **Память**: до 3008 MB
- **Нет поддержки Playwright/Chrome**

### ✅ Решение:

#### Обновлен [vercel.json](vercel.json):
```json
{
  "functions": {
    "index.py": {
      "memory": 3008,        // Максимальная память
      "maxDuration": 60      // Максимальный таймаут (60 сек на Pro плане)
    }
  }
}
```

#### Используется SimpleParser вместо Playwright:
- [index.py](index.py) автоматически использует SimpleParser
- SimpleParser не требует браузера
- Работает через requests + BeautifulSoup

---

## 3. ❌ Проблема: Static files не работают

### Симптомы:
- CSS/JS файлы не загружаются
- 404 ошибки для /static/*

### Причина:
Неправильный маршрут в vercel.json

### ✅ Решение:

Обновлен маршрут в [vercel.json](vercel.json:9-13):
```json
{
  "routes": [
    {
      "src": "/static/(.*)",
      "dest": "/static/$1"      // Исправлено с /src/static/$1
    }
  ]
}
```

---

## 4. ⚠️ Ограничение: Упрощенный парсинг

### Что работает ограниченно:
- **Парсинг целевого объекта**: Базовые данные (цена, адрес, площадь)
- **Поиск аналогов**: Возвращает демо-данные (5 тестовых объектов)
- **Анализ**: Полностью работает на демо-данных

### Почему:
Vercel - это serverless платформа, не поддерживающая браузеры и долгие процессы

### ✅ Решение:

**Для ПОЛНОГО функционала используйте Railway или локальный запуск!**

Railway поддерживает:
- ✅ Playwright + реальный Chrome
- ✅ Долгие процессы (без таймаутов)
- ✅ Полноценный парсинг Cian.ru
- ✅ Реальный поиск аналогов

---

## Текущий статус деплоя

### ✅ Что работает на Vercel:
- Веб-интерфейс (3 экрана)
- API endpoints
- Базовый парсинг (цена, площадь, адрес)
- Полный аналитический движок
- In-memory хранилище сессий

### ❌ Что НЕ работает на Vercel:
- Полноценный парсинг через Playwright
- Реальный поиск аналогов на Cian.ru
- Парсинг деталей (photos, characteristics)

---

## Рекомендации по выбору платформы

### Используйте Vercel если:
- ✅ Нужна быстрая демо-версия
- ✅ Тестируете UI/UX
- ✅ Нужен простой деплой без настроек
- ✅ Работаете с демо-данными

### Используйте Railway если:
- ✅ Нужен полноценный парсинг
- ✅ Реальные данные с Cian.ru
- ✅ Поиск аналогов
- ✅ Production-ready приложение

### Используйте локальный запуск если:
- ✅ Разработка
- ✅ Тестирование парсера
- ✅ Нужен полный контроль

---

## Как задеплоить на Vercel

### Через Web UI (рекомендуется):

1. Откройте [Vercel Dashboard](https://vercel.com/dashboard)
2. Нажмите **"Add New... → Project"**
3. Импортируйте репозиторий: `nikita-tita/cian-analyzer`
4. Vercel автоматически обнаружит конфигурацию
5. Нажмите **"Deploy"**

### Через CLI:

```bash
# Установите Vercel CLI
npm i -g vercel

# Войдите
vercel login

# Задеплойте
vercel --prod
```

---

## Проверка деплоя

После успешного деплоя проверьте:

1. **Главная страница** - должен загрузиться wizard UI
2. **Тест парсинга** - попробуйте ввести любой URL Cian.ru
   - Появится предупреждение о SimpleParser
   - Базовые данные должны отобразиться
3. **Поиск аналогов** - нажмите "Найти аналоги"
   - Появится 5 демо-аналогов
4. **Анализ** - нажмите "Рассчитать"
   - Должен показать полный анализ на демо-данных

---

## Логи и отладка

### Просмотр логов:
1. Откройте проект в Vercel Dashboard
2. Перейдите на вкладку **"Logs"**
3. Выберите нужный deployment
4. Смотрите real-time логи

### Частые ошибки в логах:

**Error: Module not found**
- Проверьте requirements.txt
- Убедитесь, что все зависимости установлены

**Error: Timeout**
- Проверьте maxDuration в vercel.json
- На Free плане лимит 10 секунд
- На Pro плане лимит 60 секунд

**502 Bad Gateway**
- Приложение упало при запуске
- Проверьте логи на Python ошибки
- Убедитесь, что index.py корректен

---

## Миграция с Vercel на Railway

Если вам нужен полный функционал:

1. Используйте уже созданную конфигурацию Railway
2. Следуйте инструкциям в [RAILWAY_DEPLOY.md](RAILWAY_DEPLOY.md)
3. Railway автоматически подтянет тот же код из GitHub

**Оба деплоя могут работать одновременно!**
- Vercel - для демо и UI тестов
- Railway - для production с полным парсингом

---

## FAQ

### Q: Почему SimpleParser возвращает демо-данные?
**A:** Vercel не поддерживает браузеры. Для реального парсинга используйте Railway.

### Q: Можно ли увеличить таймаут на Vercel?
**A:** Максимум 60 секунд на Pro плане. Для длительных операций используйте Railway.

### Q: Работает ли Redis на Vercel?
**A:** Можно подключить внешний Redis (Upstash, Railway), но для этого проекта достаточно in-memory.

### Q: Стоит ли вообще деплоить на Vercel?
**A:** Да, для UI демо и тестирования. Для production используйте Railway.

---

## Полезные ссылки

- [Vercel Docs](https://vercel.com/docs)
- [Vercel Python Runtime](https://vercel.com/docs/functions/runtimes/python)
- [Railway Deployment Guide](RAILWAY_DEPLOY.md)
- [Project README](README.md)
