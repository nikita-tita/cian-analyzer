# Рефакторинг сравнительного анализа

**Дата:** 06.11.2025  
**Статус:** ✅ Завершено

## Проблема

Старая система применяла коэффициенты ко ВСЕМ параметрам, даже если они были одинаковыми у всех аналогов. Это приводило к неправильной оценке.

### Пример проблемы

```
Все аналоги: монолит + охрана
Старая система: +5% за монолит + 3% за охрану = +8%
Проблема: ЭТО НЕПРАВИЛЬНО! Если все аналоги монолитные с охраной,
          то эти параметры уже учтены в их ценах!
```

## Решение

Разделили параметры на **ФИКСИРОВАННЫЕ** и **ПЕРЕМЕННЫЕ**:

### Фиксированные параметры (7)

Используются для **фильтрации** аналогов. Коэффициенты за них **НЕ применяются**.

- `district_type` — район
- `house_type` — тип дома (монолит/кирпич/панель)
- `house_condition` — состояние дома
- `security_level` — уровень охраны
- `parking_type` — тип парковки
- `sports_amenities` — спортивная инфраструктура
- `transport_accessibility` — транспортная доступность

### Переменные параметры (16)

**ОТЛИЧАЮТСЯ** между аналогами. Коэффициенты применяются **ТОЛЬКО за отличия от медианы**.

- `repair_level` — уровень отделки
- `ceiling_height` — высота потолков
- `bathrooms` — количество ванных
- `window_type` — тип окон
- `elevator_count` — количество лифтов
- `living_area` — жилая площадь (%)
- `total_area` — общая площадь
- `floor` — этаж
- `metro_distance_min` — расстояние до метро
- `parking_spaces` — количество машиномест
- `view_type` — вид из окна
- `noise_level` — уровень шума
- `crowded_level` — людность
- `photo_type` — тип фотографий
- `object_status` — статус объекта
- `build_year` — год постройки

## Алгоритм

### ШАГ 1: Выбор аналогов

Фильтруем по **фиксированным** параметрам:

```python
# Пример: целевой объект в монолитном доме с охраной
target.house_type = "монолит"
target.security_level = "24/7"

# Выбираем ТОЛЬКО монолитные с охраной
comparables = filter_by_fixed_params(
    house_type="монолит",
    security_level="24/7"
)
```

Результат: 8-10 однородных аналогов

### ШАГ 2: Расчет медиан

Для каждого **переменного** параметра рассчитываем медиану:

```python
medians = {
    'repair_level': 'стандартная',  # мода среди аналогов
    'view_type': 'улица',            # мода
    'floor': 4,                       # медиана
    'living_area_percent': 33,        # медиана
    'total_area': 175,                # медиана
    'price_per_sqm': 914286           # медиана
}
```

### ШАГ 3: Сравнение

Сравниваем целевой с медианами:

```python
target.repair_level = 'улучшенная'   # медиана: 'стандартная' → ЛУЧШЕ
target.view_type = 'вода'            # медиана: 'улица' → ЛУЧШЕ
target.floor = 6                     # медиана: 4 → ВЫШЕ
target.living_area_percent = 22      # медиана: 33 → ХУЖЕ
target.total_area = 180              # медиана: 175 → БОЛЬШЕ
```

### ШАГ 4: Применение коэффициентов

Применяем коэффициенты **ТОЛЬКО за отличия**:

```python
multiplier = 1.0

# Ремонт: улучшенная vs стандартная
target_coef = 1.03   # коэфф для улучшенной
median_coef = 1.00   # коэфф для стандартной
multiplier *= target_coef / median_coef  # = 1.03

# Вид: вода vs улица
target_coef = 1.07   # коэфф для воды
median_coef = 1.00   # коэфф для улицы
multiplier *= target_coef / median_coef  # = 1.07

# И так далее для всех отличающихся параметров...

# ВАЖНО: если параметр = медиане → коэфф = 1.0 (без изменений)
```

### ШАГ 5: Справедливая цена

```python
base_price_per_sqm = 914_286  # медиана из аналогов
fair_price_per_sqm = base_price_per_sqm * multiplier
fair_price_total = fair_price_per_sqm * target.total_area
```

## Созданные файлы

### 1. `src/analytics/parameter_classifier.py`

Классификация параметров на фиксированные и переменные.

**Ключевые функции:**

```python
classify_parameter(param_name) -> ParameterType
get_fixed_parameters() -> Set[str]
get_variable_parameters() -> Set[str]
should_apply_coefficient(param_name) -> bool
explain_parameter_classification() -> Dict
```

### 2. `src/analytics/median_calculator.py`

Расчет медиан по переменным параметрам.

**Ключевые функции:**

```python
calculate_medians_from_comparables(comparables) -> Dict
compare_target_with_medians(target, medians) -> Dict
get_readable_comparison_summary(comparison) -> str
```

### 3. `src/analytics/fair_price_calculator.py`

Правильный расчет справедливой цены с учетом медиан.

**Ключевые функции:**

```python
calculate_fair_price_with_medians(
    target, comparables, base_price_per_sqm, method
) -> Dict
```

### 4. `src/analytics/analyzer.py` (обновлен)

Главный анализатор теперь использует новую логику:

- `calculate_fair_price()` — **НОВАЯ** версия с медианами
- `calculate_fair_price_old()` — **СТАРАЯ** версия (для совместимости)

## Тестирование

### Запуск тестов

```bash
# Упрощенный тест (классификация параметров)
source venv/bin/activate
python test_simple.py

# Полный тест (с примером из документа)
python test_new_logic.py
```

### Результаты тестов

```
✅ ФИКСИРОВАННЫЕ параметры (7): правильно определены
✅ ПЕРЕМЕННЫЕ параметры (16): правильно определены
✅ Медианы рассчитываются корректно
✅ Сравнение с медианами работает
✅ Коэффициенты применяются только за отличия
```

## Преимущества новой логики

### 1. Правильная оценка

```
БЫЛО: +5% монолит + 3% охрана (даже если все аналоги такие же)
СТАЛО: 0% (если все аналоги монолитные с охраной)
```

### 2. Честное сравнение

Коэффициенты применяются ТОЛЬКО за реальные отличия от среднего аналога (медианы).

### 3. Прозрачность

В результате видно:
- Какие параметры = медиане (коэфф не применен)
- Какие параметры отличаются (коэфф применен)
- Обоснование каждого коэффициента

## Пример вывода

```
МЕДИАНЫ:
  repair_level: стандартная
  view_type: улица
  floor: 4

СРАВНЕНИЕ:
  ✓ repair_level: улучшенная vs стандартная → +3%
  ✓ view_type: вода vs улица → +7%
  ✓ floor: 6 vs 4 → +2%
  = house_type: монолит = монолит → 0% (не применяется)
  = security_level: 24/7 = 24/7 → 0% (не применяется)

ИТОГОВЫЙ MULTIPLIER: 1.12
```

## Обратная совместимость

Старая версия сохранена как `calculate_fair_price_old()` для совместимости.

При необходимости можно переключиться обратно на старую логику.

## Следующие шаги

1. ✅ Протестировать на реальных данных
2. ⬜ Добавить UI для отображения сравнения с медианами
3. ⬜ Создать визуализацию (графики медиан vs целевой)
4. ⬜ Добавить автоматическую фильтрацию аналогов по фиксированным параметрам

## Автор

**Claude Code** (Anthropic)  
Дата: 06.11.2025
