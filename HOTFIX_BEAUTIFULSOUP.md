# üî• HOTFIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã BeautifulSoup

**–î–∞—Ç–∞:** 12 –Ω–æ—è–±—Ä—è 2025
**–í—Ä–µ–º—è:** 17:25 MSK
**–ö–æ–º–º–∏—Ç:** eac2c2e
**–¢–∏–ø:** Critical hotfix
**–°–µ—Ä–≤–µ—Ä:** 91.229.8.221 (housler.ru)
**PID:** 265759 (gunicorn —Å 4 –≤–æ—Ä–∫–µ—Ä–∞–º–∏)

---

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã
- –ü–∞—Ä—Å–∏–Ω–≥ URL –ø–∞–¥–∞–ª –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ
- –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è `adaptive_selectors.py`
- –õ—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã–∑—ã–≤–∞–ª–∞ runtime –æ—à–∏–±–∫—É

### –ü—Ä–∏—á–∏–Ω–∞
```python
# ‚ùå –ë–´–õ–û (–ª–æ–º–∞–ª–æ—Å—å)
from bs4 import BeautifulSoup, Tag

def __init__(self, soup: BeautifulSoup):
    self.soup = soup

def extract_price_with_fallback(elem: Tag) -> Optional[float]:
    # BeautifulSoup –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
    ...
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò–º–ø–æ—Ä—Ç BeautifulSoup –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è
- –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ —Ç—Ä–µ–±–æ–≤–∞–ª–∏ –∏–º–ø–æ—Ä—Ç –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –í production –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

```python
# ‚úÖ –°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç)
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from bs4 import BeautifulSoup, Tag

def __init__(self, soup):  # –ë–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–∞
    """
    Args:
        soup: BeautifulSoup –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
    """
    self.soup = soup

def extract_price_with_fallback(elem) -> Optional[float]:
    """–ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—É —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π

    Args:
        elem: –≠–ª–µ–º–µ–Ω—Ç BeautifulSoup (Tag)
    """
    from bs4 import BeautifulSoup  # Lazy import –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    ...
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. **TYPE_CHECKING –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∏ 18-19)**
   ```python
   if TYPE_CHECKING:
       from bs4 import BeautifulSoup, Tag
   ```
   - –ò–º–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è type checker (mypy, pyright)
   - –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

2. **Lazy imports –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π**
   ```python
   def extract_price_with_fallback(elem):
       from bs4 import BeautifulSoup  # –ò–º–ø–æ—Ä—Ç –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω
       ...
   ```

3. **–£–±—Ä–∞–Ω—ã –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä**
   ```python
   # –ë—ã–ª–æ: def __init__(self, soup: BeautifulSoup)
   # –°—Ç–∞–ª–æ: def __init__(self, soup)
   ```

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
src/parsers/adaptive_selectors.py
+17 —Å—Ç—Ä–æ–∫
-7 —Å—Ç—Ä–æ–∫
```

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `AdaptiveSelector.__init__()` - —É–±—Ä–∞–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è `BeautifulSoup`
- `AdaptiveSelector.find_element()` - —É–±—Ä–∞–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è `Tag`
- `AdaptiveSelector.find_elements()` - —É–±—Ä–∞–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è `List[Tag]`
- `extract_price_with_fallback()` - lazy import, —É–±—Ä–∞–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è `Tag`
- `extract_area_with_fallback()` - lazy import, —É–±—Ä–∞–Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è `Tag`

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –î–æ hotfix
```bash
curl -X POST https://housler.ru/api/parse \
  -H "Content-Type: application/json" \
  -d '{"url": "https://spb.cian.ru/sale/flat/315831388/"}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚ùå ERROR: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ adaptive_selectors
# ‚ùå ModuleNotFoundError –∏–ª–∏ ImportError
```

### –ü–æ—Å–ª–µ hotfix
```bash
curl -X POST https://housler.ru/api/parse \
  -H "Content-Type: application/json" \
  -d '{"url": "https://spb.cian.ru/sale/flat/315831388/"}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ 200 OK
# ‚úÖ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
# ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

---

## üìù –õ–æ–≥–∏

### –£—Å–ø–µ—à–Ω—ã–π —Å—Ç–∞—Ä—Ç (–ø–æ—Å–ª–µ hotfix)

```
Nov 12 17:25:36 gunicorn[265759]: INFO:app_new:CSRF protection enabled
Nov 12 17:25:36 gunicorn[265759]: INFO:src.cache.redis_cache:‚úÖ Redis cache connected
Nov 12 17:25:36 gunicorn[265759]: INFO:src.parsers.browser_pool:‚úì Playwright started
Nov 12 17:25:36 gunicorn[265759]: INFO:app_new:Browser pool initialized with max_browsers=3
Nov 12 17:25:36 gunicorn[265759]: INFO:app_new:Rate limiting initialized
```

**–ö–ª—é—á–µ–≤–æ–µ:** –ù–µ—Ç –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ BeautifulSoup ‚úÖ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

| –°—Ç–∞—Ç—É—Å | –î–æ hotfix | –ü–æ—Å–ª–µ hotfix |
|--------|-----------|--------------|
| –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚ùå –ü–∞–¥–∞–µ—Ç | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è | ‚ùå –û—à–∏–±–∫–∞ | ‚úÖ OK |
| API /api/parse | ‚ùå 500 Error | ‚úÖ 200 OK |
| –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ | - | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É TYPE_CHECKING —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É?

```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    # –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∏–ø–æ–≤
    # –í runtime –æ–Ω –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
    from bs4 import BeautifulSoup, Tag
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. Type checker –≤–∏–¥–∏—Ç —Ç–∏–ø—ã (mypy happy ‚úÖ)
2. Runtime –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç BeautifulSoup –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ (production happy ‚úÖ)
3. Lazy import –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π (–∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω)

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è production?

**–î–æ hotfix:**
- BeautifulSoup –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è
- –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–∞–∂–¥–æ–≥–æ gunicorn –≤–æ—Ä–∫–µ—Ä–∞
- –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö —ç—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã/–æ—à–∏–±–∫–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –≤–æ–æ–±—â–µ

**–ü–æ—Å–ª–µ hotfix:**
- BeautifulSoup –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- Lazy import –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π
- TYPE_CHECKING –¥–ª—è type hints
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

---

## üì¶ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤

```
eac2c2e ‚Üê Hotfix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã BeautifulSoup (PROD) üî•
13c891f ‚Üê docs: –û—Ç—á–µ—Ç –æ –¥–µ–ø–ª–æ–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞
22545cd ‚Üê Merge: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–µ—Ä v2.1.0
f5ae650 ‚Üê fix: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ multiplier
```

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

**–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç:**
```bash
ssh -i ~/.ssh/id_housler root@91.229.8.221
cd /var/www/housler
git reset --hard 13c891f  # –î–æ hotfix
sudo systemctl restart housler
```

**–ù–û:** –û—Ç–∫–∞—Ç –≤–µ—Ä–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º! ‚ö†Ô∏è
–≠—Ç–æ—Ç hotfix –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞.

---

## ‚úÖ –ò—Ç–æ–≥–∏

‚úÖ **Hotfix –∑–∞–¥–µ–ø–ª–æ–µ–Ω** –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
‚úÖ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
‚úÖ **–ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç** –±–µ–∑ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞
‚úÖ **–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç** (4 –≤–æ—Ä–∫–µ—Ä–∞, PID 265759)
‚úÖ **–°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω** –ø–æ https://housler.ru

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–µ—Ä v2.1.0 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω!** üöÄ

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ URL –Ω–∞ https://housler.ru
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç 15-20 –∞–Ω–∞–ª–æ–≥–æ–≤
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:** 12 –Ω–æ—è–±—Ä—è 2025, 17:28 MSK
