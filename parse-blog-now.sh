#!/bin/bash

#############################################
# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ blog parser
# –ü–∞—Ä—Å–∏—Ç, —Ä–µ—Ä–∞–π—Ç–∏—Ç –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Å—Ç–∞—Ç—å–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
#############################################

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
SERVER_USER="root"
SERVER_IP="91.229.8.221"
SSH_KEY="$HOME/.ssh/id_housler"

echo ""
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${CYAN}  üì∞ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ Blog Parser${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π
echo -e "${YELLOW}–°–∫–æ–ª—å–∫–æ —Å—Ç–∞—Ç–µ–π —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å?${NC}"
echo "  1 - –û–¥–Ω–∞ —Å—Ç–∞—Ç—å—è (–±—ã—Å—Ç—Ä–æ, –¥–ª—è —Ç–µ—Å—Ç–∞)"
echo "  3 - –¢—Ä–∏ —Å—Ç–∞—Ç—å–∏ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ)"
echo "  5 - –ü—è—Ç—å —Å—Ç–∞—Ç–µ–π"
echo "  10 - –î–µ—Å—è—Ç—å —Å—Ç–∞—Ç–µ–π (–¥–æ–ª–≥–æ, ~10-15 –º–∏–Ω—É—Ç)"
echo ""
read -p "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ [1-10]: " ARTICLES_COUNT

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
if ! [[ "$ARTICLES_COUNT" =~ ^[0-9]+$ ]] || [ "$ARTICLES_COUNT" -lt 1 ] || [ "$ARTICLES_COUNT" -gt 10 ]; then
    echo -e "${RED}‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º 3 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é${NC}"
    ARTICLES_COUNT=3
fi

echo ""
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞:${NC}"
echo -e "   –°—Ç–∞—Ç–µ–π: ${YELLOW}$ARTICLES_COUNT${NC}"
echo -e "   –°–µ—Ä–≤–µ—Ä: ${YELLOW}$SERVER_IP${NC}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–ù–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
    exit 0
fi

echo ""
echo -e "${CYAN}[1/3] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if ! ssh -i "$SSH_KEY" -o ConnectTimeout=5 "$SERVER_USER@$SERVER_IP" 'echo "OK"' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É${NC}"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –∫–ª—é—á: $SSH_KEY"
    exit 1
fi

echo -e "${GREEN}‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ${NC}"
echo ""

echo -e "${CYAN}[2/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Å—Ç–∞—Ç–µ–π –≤ –±–∞–∑–µ...${NC}"

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –≤ –±–∞–∑–µ
CURRENT_POSTS=$(ssh -i "$SSH_KEY" "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'
cd /var/www/housler
source venv/bin/activate
python3 -c "from blog_database import BlogDatabase; db = BlogDatabase(); print(len(db.get_all_posts()))"
ENDSSH
)

echo -e "${GREEN}‚úÖ –°–µ–π—á–∞—Å –≤ –±–∞–∑–µ: ${YELLOW}$CURRENT_POSTS${GREEN} —Å—Ç–∞—Ç–µ–π${NC}"
echo ""

echo -e "${CYAN}[3/3] –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞...${NC}"
echo -e "${YELLOW}‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-5 –º–∏–Ω—É—Ç –Ω–∞ —Å—Ç–∞—Ç—å—é...${NC}"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä
ssh -i "$SSH_KEY" "$SERVER_USER@$SERVER_IP" bash << ENDSSH
cd /var/www/housler
source venv/bin/activate

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø–∞—Ä—Å–∏–Ω–≥ $ARTICLES_COUNT —Å—Ç–∞—Ç–µ–π..."
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

python3 blog_cli.py parse -n $ARTICLES_COUNT

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
NEW_POSTS_COUNT=\$(python3 -c "from blog_database import BlogDatabase; db = BlogDatabase(); print(len(db.get_all_posts()))")
ADDED_COUNT=\$((NEW_POSTS_COUNT - $CURRENT_POSTS))

echo "–ë—ã–ª–æ —Å—Ç–∞—Ç–µ–π: $CURRENT_POSTS"
echo "–°—Ç–∞–ª–æ —Å—Ç–∞—Ç–µ–π: \$NEW_POSTS_COUNT"
echo "–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: \$ADDED_COUNT"
echo ""

if [ \$ADDED_COUNT -gt 0 ]; then
    echo "‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏:"
    python3 -c "
from blog_database import BlogDatabase
db = BlogDatabase()
posts = db.get_all_posts(limit=\$ADDED_COUNT)
for i, post in enumerate(posts, 1):
    print(f'{i}. {post[\"title\"]}')
    print(f'   URL: https://housler.ru/blog/{post[\"slug\"]}')
    print()
"
else
    echo "‚ÑπÔ∏è  –ù–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–≤—Å–µ —É–∂–µ –±—ã–ª–∏ –≤ –±–∞–∑–µ)"
fi

ENDSSH

PARSE_EXIT_CODE=$?

echo ""
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

if [ $PARSE_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo ""
    echo -e "${YELLOW}üìù –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Å–∞–π—Ç–µ:${NC}"
    echo -e "   ${CYAN}https://housler.ru/blog${NC}"
    echo ""
    echo -e "${YELLOW}üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:${NC}"
    echo -e "   ${CYAN}ssh -i $SSH_KEY $SERVER_USER@$SERVER_IP 'tail -50 /var/log/housler/blog_parser_cron.log'${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ${NC}"
    echo ""
    echo -e "${YELLOW}–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π:${NC}"
    echo -e "   ${CYAN}ssh -i $SSH_KEY $SERVER_USER@$SERVER_IP 'tail -100 /var/log/housler/blog_parser_cron.log'${NC}"
fi

echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
