<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    {% include '_metrika.html' %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }} — HOUSLER</title>
    <meta name="description" content="{{ post.excerpt or post.content[:200] }}">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ post.title }}">
    <meta property="og:description" content="{{ post.excerpt or post.content[:200] }}">
    <meta property="og:url" content="https://housler.ru/blog/{{ post.slug }}">
    <meta property="og:site_name" content="HOUSLER — Агентство недвижимости">
    <meta property="article:published_time" content="{{ post.published_at }}">
    {% if post.cover_image %}
    <meta property="og:image" content="https://housler.ru{{ post.cover_image }}">
    <meta property="og:image:width" content="1920">
    <meta property="og:image:height" content="1080">
    {% endif %}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ post.title }}">
    <meta name="twitter:description" content="{{ post.excerpt or post.content[:200] }}">
    {% if post.cover_image %}
    <meta name="twitter:image" content="https://housler.ru{{ post.cover_image }}">
    {% endif %}

    <!-- Canonical URL -->
    <link rel="canonical" href="https://housler.ru/blog/{{ post.slug }}">

    <!-- Schema.org Article structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "{{ post.title }}",
        "description": "{{ post.excerpt or post.content[:200] | e }}",
        {% if post.cover_image %}
        "image": {
            "@type": "ImageObject",
            "url": "https://housler.ru{{ post.cover_image }}",
            "width": 1920,
            "height": 1080
        },
        {% endif %}
        "datePublished": "{{ post.published_at }}",
        "dateModified": "{{ post.updated_at or post.published_at }}",
        "author": {
            "@type": "Organization",
            "name": "HOUSLER",
            "url": "https://housler.ru"
        },
        "publisher": {
            "@type": "Organization",
            "name": "HOUSLER",
            "logo": {
                "@type": "ImageObject",
                "url": "https://housler.ru/static/images/favicon-512.png"
            }
        },
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://housler.ru/blog/{{ post.slug }}"
        },
        "articleSection": "Недвижимость",
        "inLanguage": "ru-RU"
    }
    </script>

    <!-- BreadcrumbList structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Главная",
                "item": "https://housler.ru"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Блог",
                "item": "https://housler.ru/blog"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "{{ post.title }}",
                "item": "https://housler.ru/blog/{{ post.slug }}"
            }
        ]
    }
    </script>

    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <link rel="stylesheet" href="/static/css/landing.css?v=20251211">
    <link rel="stylesheet" href="/static/css/blog-minimal.css?v=20251211">
    <link rel="stylesheet" href="/static/css/blog-post.css?v=20251211">
    <link rel="stylesheet" href="/static/css/request-form.css?v=20251126c">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-content">
                <a href="/" class="logo">HOUSLER</a>
                <div class="nav-links">
                    <a href="/#services">Услуги</a>
                    <a href="/#pricing">Стоимость</a>
                    <a href="/blog">Блог</a>
                    <a href="/#contact">Контакты</a>
                </div>
                <button class="mobile-menu-toggle" aria-label="Меню">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <a href="/">Главная</a>
        <a href="/#services">Услуги</a>
        <a href="/#pricing">Стоимость</a>
        <a href="/blog">Блог</a>
        <a href="/#contact">Контакты</a>
    </div>

    <!-- Blog Post -->
    <section class="section">
        <div class="container">
            <!-- Breadcrumbs -->
            <nav class="breadcrumbs" aria-label="Навигация">
                <a href="/">Главная</a>
                <span class="breadcrumb-sep">→</span>
                <a href="/blog">Блог</a>
                <span class="breadcrumb-sep">→</span>
                <span class="breadcrumb-current">{{ post.title[:50] }}{% if post.title|length > 50 %}...{% endif %}</span>
            </nav>

            <div class="blog-post-content">
                <div class="blog-post-header">
                    <div class="blog-post-meta">{{ post.published_at[:10] }}</div>
                    <h1 class="blog-post-title">{{ post.title }}</h1>
                    {% if post.excerpt %}
                    <div class="blog-post-excerpt">{{ post.excerpt }}</div>
                    {% endif %}
                    {% if post.cover_image %}
                    <div class="blog-post-cover">
                        <img src="{{ post.cover_image }}" alt="{{ post.title }}" loading="lazy">
                    </div>
                    {% endif %}
                    {% if post.gallery_images and post.gallery_images|length > 1 %}
                    <div class="blog-gallery">
                        {% for img in post.gallery_images[1:] %}
                        <div class="blog-gallery-item">
                            <img src="{{ img }}" alt="" loading="lazy" onclick="openLightbox(this.src)">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="blog-post-body">
                    {{ post.content_html | safe }}
                </div>

                <div class="blog-post-footer">
                    {% if post.original_url %}
                    <div class="blog-post-source">
                        <a href="{{ post.original_url }}" target="_blank" rel="noopener noreferrer nofollow" class="source-link">Ссылка на первоисточник публикации</a>
                    </div>
                    {% endif %}
                    <a href="/blog" class="back-to-blog">← Все статьи</a>
                </div>

                <!-- CTA Block for internal linking -->
                <div class="blog-cta-block">
                    <h3>Нужна помощь с недвижимостью?</h3>
                    <p>HOUSLER — агентство недвижимости в Москве и Санкт-Петербурге с полным сопровождением сделки</p>
                    <div class="blog-cta-links">
                        <a href="/" class="blog-cta-link">Узнать об услугах</a>
                        <a href="/calculator?reset=1" class="blog-cta-link">Оценить квартиру</a>
                        <button type="button" class="blog-cta-link" id="openRequestPopup" onclick="document.getElementById('requestPopup').classList.add('active'); document.body.style.overflow='hidden';">Связаться</button>
                    </div>
                </div>
            </div>

            {% if recent_posts %}
            <!-- Related Posts -->
            <div class="related-posts">
                <h2 class="related-posts-title">Читайте также</h2>
                <div class="related-posts-grid">
                    {% for related_post in recent_posts[:3] %}
                        {% if related_post.slug != post.slug %}
                        <a href="/blog/{{ related_post.slug }}" class="related-post-card">
                            <div class="related-post-meta">{{ related_post.published_at[:10] }}</div>
                            <h3 class="related-post-title">{{ related_post.title }}</h3>
                            {% if related_post.excerpt %}
                            <p class="related-post-excerpt">{{ related_post.excerpt[:120] }}...</p>
                            {% endif %}
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Request Popup -->
    <div class="request-popup-overlay" id="requestPopup">
        <div class="request-popup">
            <div class="request-popup-header">
                <h2>Оставить заявку</h2>
                <button class="request-popup-close" id="closeRequestPopup">&times;</button>
            </div>
            <div class="request-popup-body">
                <div class="request-steps">
                    <div class="request-step-dot active" data-step="1"></div>
                    <div class="request-step-dot" data-step="2"></div>
                    <div class="request-step-dot" data-step="3"></div>
                </div>
                <div class="request-error" id="requestError"></div>
                <div class="request-form-step active" data-step="1">
                    <div class="request-step-title">Что вас интересует?</div>
                    <div class="request-options">
                        <label class="request-option">
                            <input type="radio" name="operation" value="buy">
                            <span class="request-option-radio"></span>
                            <span class="request-option-content">
                                <span class="request-option-label">Купить</span>
                                <span class="request-option-desc">Ищу недвижимость для покупки</span>
                            </span>
                        </label>
                        <label class="request-option">
                            <input type="radio" name="operation" value="sell">
                            <span class="request-option-radio"></span>
                            <span class="request-option-content">
                                <span class="request-option-label">Продать</span>
                                <span class="request-option-desc">Хочу продать свою недвижимость</span>
                            </span>
                        </label>
                        <label class="request-option">
                            <input type="radio" name="operation" value="rent">
                            <span class="request-option-radio"></span>
                            <span class="request-option-content">
                                <span class="request-option-label">Сдать</span>
                                <span class="request-option-desc">Хочу сдать в аренду</span>
                            </span>
                        </label>
                    </div>
                    <div class="request-nav">
                        <button class="request-btn request-btn-next" id="toStep2" disabled>Далее</button>
                    </div>
                </div>
                <div class="request-form-step" data-step="2">
                    <div class="request-step-title">Тип недвижимости</div>
                    <div class="request-options">
                        <label class="request-option">
                            <input type="radio" name="property_type" value="residential">
                            <span class="request-option-radio"></span>
                            <span class="request-option-content">
                                <span class="request-option-label">Жилая</span>
                                <span class="request-option-desc">Квартира, дом, комната</span>
                            </span>
                        </label>
                        <label class="request-option">
                            <input type="radio" name="property_type" value="commercial">
                            <span class="request-option-radio"></span>
                            <span class="request-option-content">
                                <span class="request-option-label">Коммерческая</span>
                                <span class="request-option-desc">Офис, магазин, склад</span>
                            </span>
                        </label>
                    </div>
                    <div class="request-nav">
                        <button class="request-btn request-btn-back" data-to="1">Назад</button>
                        <button class="request-btn request-btn-next" id="toStep3" disabled>Далее</button>
                    </div>
                </div>
                <div class="request-form-step" data-step="3">
                    <div class="request-step-title">Ваши контакты</div>
                    <div class="request-input-group">
                        <label for="requestName">Имя</label>
                        <input type="text" id="requestName" name="name" placeholder="Как к вам обращаться?" autocomplete="name">
                    </div>
                    <div class="request-input-group">
                        <label for="requestPhone">Телефон</label>
                        <input type="tel" id="requestPhone" name="phone" placeholder="+7 (999) 123-45-67" autocomplete="tel">
                    </div>
                    <div class="request-step-title" style="margin-top: 24px;">Удобный способ связи</div>
                    <div class="request-contact-options">
                        <label class="request-contact-option">
                            <input type="radio" name="contact_method" value="call">
                            <div class="request-contact-label">Позвонить</div>
                        </label>
                        <label class="request-contact-option">
                            <input type="radio" name="contact_method" value="whatsapp">
                            <div class="request-contact-label">WhatsApp</div>
                        </label>
                        <label class="request-contact-option">
                            <input type="radio" name="contact_method" value="telegram">
                            <div class="request-contact-label">Telegram</div>
                        </label>
                    </div>
                    <div class="request-nav">
                        <button class="request-btn request-btn-back" data-to="2">Назад</button>
                        <button class="request-btn request-btn-next" id="submitRequest" disabled>Отправить</button>
                    </div>
                </div>
                <div class="request-success" id="requestSuccess">
                    <div class="request-success-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3>Заявка отправлена!</h3>
                    <p>Мы свяжемся с вами в ближайшее время выбранным способом.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox for gallery images -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="">
        </div>
    </div>

    {% include '_footer.html' %}

    <script>
        // Lightbox functions
        function openLightbox(src) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeLightbox();
        });

        // Mobile menu toggle
        const menuToggle = document.querySelector('.mobile-menu-toggle');
        const mobileMenu = document.querySelector('.mobile-menu');
        const menuOverlay = document.querySelector('.mobile-menu-overlay');
        const body = document.body;

        function toggleMenu() {
            menuToggle.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
        }

        menuToggle.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        // Close menu when clicking on a link
        mobileMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', toggleMenu);
        });

        // Request Form Logic
        (function() {
            const popup = document.getElementById('requestPopup');
            const closeBtn = document.getElementById('closeRequestPopup');
            const steps = document.querySelectorAll('.request-form-step');
            const stepDots = document.querySelectorAll('.request-step-dot');
            const successEl = document.getElementById('requestSuccess');
            const errorEl = document.getElementById('requestError');

            let currentStep = 1;
            const formData = {
                operation: null,
                property_type: null,
                name: '',
                phone: '',
                contact_method: null
            };

            function closePopup() {
                popup.classList.remove('active');
                document.body.style.overflow = '';
                setTimeout(resetForm, 300);
            }

            // Open popup button
            const openBtn = document.getElementById('openRequestPopup');
            if (openBtn) {
                openBtn.addEventListener('click', () => {
                    popup.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            }

            closeBtn.addEventListener('click', closePopup);
            popup.addEventListener('click', (e) => {
                if (e.target === popup) closePopup();
            });

            function resetForm() {
                currentStep = 1;
                formData.operation = null;
                formData.property_type = null;
                formData.name = '';
                formData.phone = '';
                formData.contact_method = null;

                document.querySelectorAll('.request-option, .request-contact-option').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelectorAll('input[type="radio"]').forEach(el => {
                    el.checked = false;
                });
                document.getElementById('requestName').value = '';
                document.getElementById('requestPhone').value = '';

                updateSteps();
                successEl.classList.remove('active');
                errorEl.classList.remove('active');
                document.querySelector('.request-steps').style.display = '';
            }

            function updateSteps() {
                steps.forEach(step => {
                    step.classList.remove('active');
                    if (parseInt(step.dataset.step) === currentStep) {
                        step.classList.add('active');
                    }
                });

                stepDots.forEach(dot => {
                    const dotStep = parseInt(dot.dataset.step);
                    dot.classList.remove('active', 'completed');
                    if (dotStep === currentStep) {
                        dot.classList.add('active');
                    } else if (dotStep < currentStep) {
                        dot.classList.add('completed');
                    }
                });

                updateButtons();
            }

            function updateButtons() {
                document.getElementById('toStep2').disabled = !formData.operation;
                document.getElementById('toStep3').disabled = !formData.property_type;

                const canSubmit = formData.name.trim() &&
                                  formData.phone.trim() &&
                                  formData.contact_method;
                document.getElementById('submitRequest').disabled = !canSubmit;
            }

            document.querySelectorAll('.request-option').forEach(option => {
                option.addEventListener('click', () => {
                    const input = option.querySelector('input');
                    const name = input.name;
                    const value = input.value;

                    option.closest('.request-options').querySelectorAll('.request-option').forEach(o => {
                        o.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    input.checked = true;

                    formData[name] = value;
                    updateButtons();
                });
            });

            document.querySelectorAll('.request-contact-option').forEach(option => {
                option.addEventListener('click', () => {
                    const input = option.querySelector('input');

                    document.querySelectorAll('.request-contact-option').forEach(o => {
                        o.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    input.checked = true;

                    formData.contact_method = input.value;
                    updateButtons();
                });
            });

            document.getElementById('requestName').addEventListener('input', (e) => {
                formData.name = e.target.value;
                updateButtons();
            });

            document.getElementById('requestPhone').addEventListener('input', (e) => {
                formData.phone = e.target.value;
                updateButtons();
            });

            document.getElementById('toStep2').addEventListener('click', () => {
                currentStep = 2;
                updateSteps();
            });

            document.getElementById('toStep3').addEventListener('click', () => {
                currentStep = 3;
                updateSteps();
            });

            document.querySelectorAll('.request-btn-back').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentStep = parseInt(btn.dataset.to);
                    updateSteps();
                });
            });

            document.getElementById('submitRequest').addEventListener('click', async () => {
                const submitBtn = document.getElementById('submitRequest');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                errorEl.classList.remove('active');

                try {
                    const response = await fetch('/api/client-request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        steps.forEach(s => s.classList.remove('active'));
                        document.querySelector('.request-steps').style.display = 'none';
                        successEl.classList.add('active');

                        setTimeout(closePopup, 3000);
                    } else {
                        throw new Error(result.error || 'Ошибка отправки');
                    }
                } catch (error) {
                    errorEl.textContent = error.message || 'Произошла ошибка. Попробуйте позже.';
                    errorEl.classList.add('active');
                } finally {
                    submitBtn.classList.remove('loading');
                    updateButtons();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && popup.classList.contains('active')) {
                    closePopup();
                }
            });

            // Intercept links with "заявк" in text and open popup instead
            document.querySelectorAll('.blog-post-body a').forEach(link => {
                const text = link.textContent.toLowerCase();
                if (text.includes('заявк') || text.includes('связат')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        popup.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    });
                }
            });
        })();
    </script>
</body>
</html>
