<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчет по недвижимости — Housler</title>

    <style>
        /* === Основные стили для PDF === */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #1A1A1A;
            background: #fff;
            padding: 0;
        }

        /* === Контроль разрывов страниц === */

        .section {
            page-break-inside: avoid;
            break-inside: avoid;
            margin-bottom: 30px;
        }

        .info-card {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .recommendation-card {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .info-row {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        table {
            page-break-inside: auto;
        }

        tr {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        thead {
            display: table-header-group;
        }

        /* Не разрывать заголовок и первый контент */
        .section-title {
            page-break-after: avoid;
            break-after: avoid;
        }

        .subsection-title {
            page-break-after: avoid;
            break-after: avoid;
        }

        /* Контроль сирот и вдов */
        p {
            orphans: 3;
            widows: 3;
        }

        /* Принудительный разрыв перед крупными секциями */
        .page-break-before {
            page-break-before: always;
            break-before: always;
        }

        /* === Контейнер отчета === */

        .report-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* === Шапка === */

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 2px solid #000;
        }

        .report-logo {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            color: #000;
        }

        .report-date {
            color: #666;
            font-size: 13px;
        }

        /* === Секции === */

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #E5E7EB;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .subsection-title {
            font-size: 15px;
            font-weight: 600;
            margin: 16px 0 12px 0;
            color: #333;
        }

        /* === Карточки информации === */

        .info-card {
            background: #F9FAFB;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #E5E7EB;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #6B7280;
        }

        .info-value {
            font-weight: 600;
            color: #1A1A1A;
            text-align: right;
        }

        /* === Статусы цены (монохромные) === */

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-overpriced {
            background: #1A1A1A;
            color: #fff;
        }

        .status-fair {
            background: #fff;
            color: #1A1A1A;
            border: 2px solid #1A1A1A;
        }

        .status-underpriced {
            background: #F3F4F6;
            color: #1A1A1A;
            border: 1px solid #1A1A1A;
        }

        /* === Карточки рекомендаций === */

        .recommendation-card {
            background: #fff;
            border-left: 4px solid #1A1A1A;
            padding: 14px 16px;
            margin-bottom: 12px;
            border-top: 1px solid #E5E7EB;
            border-right: 1px solid #E5E7EB;
            border-bottom: 1px solid #E5E7EB;
        }

        .recommendation-card.critical {
            border-left-color: #000;
            background: #F9FAFB;
        }

        .recommendation-card.high {
            border-left-color: #333;
        }

        .recommendation-card.medium {
            border-left-color: #666;
        }

        .recommendation-card.info {
            border-left-color: #999;
        }

        .recommendation-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #1A1A1A;
        }

        .recommendation-message {
            color: #4A4A4A;
            font-size: 13px;
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .recommendation-action {
            background: #F3F4F6;
            padding: 10px 12px;
            margin-top: 10px;
            font-size: 13px;
        }

        .recommendation-roi {
            margin-top: 8px;
            font-weight: 600;
            font-size: 13px;
        }

        /* === Таблицы === */

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 13px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        th {
            background: #F3F4F6;
            font-weight: 600;
            color: #1A1A1A;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
        }

        /* === Прогресс-бар (монохромный) === */

        .progress-container {
            background: #E5E7EB;
            height: 20px;
            margin: 12px 0;
        }

        .progress-bar {
            height: 100%;
            background: #1A1A1A;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-weight: 600;
            color: #fff;
            font-size: 11px;
        }

        /* === Блоки с акцентом === */

        .accent-block {
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #1A1A1A;
            background: #F9FAFB;
        }

        .accent-block-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1A1A1A;
        }

        .accent-block p {
            color: #4A4A4A;
            line-height: 1.6;
            margin: 0;
        }

        /* === Housler оффер === */

        .offer-section {
            page-break-inside: avoid;
            break-inside: avoid;
            margin-bottom: 20px;
        }

        .offer-block {
            background: #F9FAFB;
            padding: 16px;
            border: 1px solid #E5E7EB;
            margin-bottom: 16px;
        }

        .offer-block-dark {
            background: #1A1A1A;
            color: #fff;
            padding: 16px;
            margin-bottom: 16px;
        }

        .offer-block-dark .offer-block-title {
            color: #fff;
        }

        .offer-block-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1A1A1A;
        }

        .action-item {
            background: #fff;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #E5E7EB;
            display: flex;
            gap: 12px;
        }

        .action-number {
            font-weight: 700;
            font-size: 16px;
            color: #1A1A1A;
            min-width: 24px;
        }

        .action-content strong {
            display: block;
            margin-bottom: 4px;
        }

        .action-content p {
            margin: 0;
            color: #6B7280;
            font-size: 13px;
        }

        /* === Прайсинг === */

        .pricing-box {
            border: 2px solid #1A1A1A;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
        }

        .pricing-value {
            font-size: 40px;
            font-weight: 700;
            color: #1A1A1A;
        }

        .pricing-label {
            color: #6B7280;
            margin-top: 4px;
        }

        .pricing-note {
            font-weight: 500;
            margin-top: 10px;
            color: #333;
        }

        .pricing-features {
            text-align: left;
            margin: 16px 0;
            padding: 16px 0;
            border-top: 1px solid #E5E7EB;
        }

        .pricing-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .pricing-feature-check {
            font-weight: 700;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E5E7EB;
        }

        .pricing-grid-item {
            background: #F9FAFB;
            padding: 10px;
        }

        .pricing-grid-item strong {
            display: block;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .pricing-grid-item span {
            font-size: 12px;
            color: #6B7280;
        }

        /* === CTA блок === */

        .cta-block {
            background: #1A1A1A;
            color: #fff;
            padding: 24px;
            text-align: center;
            margin-top: 24px;
        }

        .cta-block h3 {
            font-size: 22px;
            margin-bottom: 12px;
        }

        .cta-block p {
            margin: 0 0 8px 0;
            opacity: 0.9;
        }

        .cta-block .brand {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.05em;
            margin-top: 16px;
        }

        /* === Футер === */

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #1A1A1A;
            text-align: center;
            color: #6B7280;
            font-size: 11px;
        }

        .footer p {
            margin: 4px 0;
        }

        /* === Блок Вердикт === */

        .verdict-card {
            border: 2px solid #1A1A1A;
            margin-bottom: 30px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .verdict-header {
            background: #F9FAFB;
            padding: 16px 20px;
            border-bottom: 1px solid #E5E7EB;
        }

        .verdict-header-icon {
            font-size: 20px;
            margin-right: 8px;
        }

        .verdict-header-title {
            font-weight: 600;
            font-size: 15px;
            color: #1A1A1A;
        }

        .verdict-header-subtitle {
            color: #6B7280;
            font-size: 13px;
            margin-top: 4px;
        }

        .verdict-body {
            padding: 20px;
        }

        .verdict-prices {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 16px;
        }

        .verdict-price-item {
            flex: 1;
        }

        .verdict-price-label {
            font-size: 12px;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .verdict-price-value {
            font-size: 22px;
            font-weight: 700;
            color: #1A1A1A;
        }

        .verdict-price-value.market {
            color: #1A1A1A;
        }

        .verdict-diff {
            background: #F3F4F6;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .verdict-diff-label {
            font-size: 13px;
            color: #6B7280;
        }

        .verdict-diff-value {
            font-weight: 700;
            font-size: 16px;
        }

        .verdict-diff-value.negative {
            color: #1A1A1A;
        }

        .verdict-diff-value.positive {
            color: #1A1A1A;
        }

        .verdict-status {
            padding: 16px;
            text-align: center;
            border-top: 1px solid #E5E7EB;
        }

        .verdict-status-badge {
            display: inline-block;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .verdict-status-badge.overpriced {
            background: #1A1A1A;
            color: #fff;
        }

        .verdict-status-badge.fair {
            background: #fff;
            color: #1A1A1A;
            border: 2px solid #1A1A1A;
        }

        .verdict-status-badge.underpriced {
            background: #F3F4F6;
            color: #1A1A1A;
            border: 1px solid #1A1A1A;
        }

        .verdict-recommendation {
            font-size: 13px;
            color: #4A4A4A;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
        }

        /* === Сценарии продажи === */

        .scenarios-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .scenario-card {
            border: 1px solid #E5E7EB;
            background: #fff;
            page-break-inside: avoid;
        }

        .scenario-card.recommended {
            border: 2px solid #1A1A1A;
        }

        .scenario-header {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #F9FAFB;
        }

        .scenario-card.recommended .scenario-header {
            background: #1A1A1A;
            color: #fff;
        }

        .scenario-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scenario-icon {
            font-size: 18px;
        }

        .scenario-name {
            font-weight: 600;
            font-size: 15px;
        }

        .scenario-badge {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            background: #fff;
            color: #1A1A1A;
            font-weight: 600;
        }

        .scenario-time {
            font-size: 13px;
            color: #6B7280;
        }

        .scenario-card.recommended .scenario-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .scenario-body {
            padding: 16px;
            display: none;
        }

        .scenario-card.expanded .scenario-body,
        .scenario-card.recommended .scenario-body {
            display: block;
        }

        .scenario-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 12px;
        }

        .scenario-price-box {
            text-align: center;
            flex: 1;
        }

        .scenario-price-label {
            font-size: 11px;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 4px;
        }

        .scenario-price-value {
            font-size: 16px;
            font-weight: 700;
            color: #1A1A1A;
        }

        .scenario-arrow {
            color: #9CA3AF;
            font-size: 16px;
        }

        .scenario-desc {
            font-size: 13px;
            color: #6B7280;
            line-height: 1.5;
            padding-top: 12px;
            border-top: 1px solid #E5E7EB;
        }

        /* === Алерты === */

        .alert {
            padding: 14px 16px;
            margin-bottom: 16px;
            border-left: 4px solid #1A1A1A;
            background: #F9FAFB;
        }

        .alert h5 {
            font-size: 14px;
            margin-bottom: 6px;
            color: #1A1A1A;
        }

        .alert p {
            margin: 0;
            font-size: 13px;
            color: #4A4A4A;
        }

        /* === Детали (expandable) - для PDF показываем открытым === */

        details {
            margin-top: 20px;
        }

        details summary {
            display: none;
        }

        details > div {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            padding: 16px;
        }

        details pre {
            font-family: "SF Mono", Monaco, "Courier New", monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #1A1A1A;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* === Список факторов === */

        .factors-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .factors-list li {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #F9FAFB;
            border-left: 3px solid #1A1A1A;
            font-size: 13px;
            line-height: 1.5;
        }

        /* === Print-specific === */

        @media print {
            body {
                padding: 0;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Шапка -->
        <div class="report-header">
            <div class="report-logo">HOUSLER</div>
            <div class="report-date">Отчет по анализу недвижимости<br>{{ date }}</div>
        </div>

        <!-- ВЕРДИКТ — главный вывод отчёта -->
        {% if property_info and fair_price_analysis and fair_price_analysis.get('status') != 'insufficient_data' %}
        <div class="verdict-card">
            <div class="verdict-header">
                <div>
                    <span class="verdict-header-icon"></span>
                    <span class="verdict-header-title">Ваша квартира</span>
                </div>
                <div class="verdict-header-subtitle">
                    {% if property_info.address %}{{ property_info.address }}{% endif %}
                    {% if property_info.total_area %} • {{ property_info.total_area }} м²{% endif %}
                    {% if property_info.rooms %} • {{ property_info.rooms }}-комн.{% endif %}
                </div>
            </div>

            <div class="verdict-body">
                <div class="verdict-prices">
                    <div class="verdict-price-item">
                        <div class="verdict-price-label">Цена продавца</div>
                        <div class="verdict-price-value">{{ "{:,.0f}".format(property_info.price).replace(",", " ") }} ₽</div>
                    </div>
                    <div class="verdict-price-item">
                        <div class="verdict-price-label">Рыночная цена</div>
                        <div class="verdict-price-value market">{{ "{:,.0f}".format(fair_price_analysis.fair_price_total).replace(",", " ") }} ₽</div>
                    </div>
                </div>

                <div class="verdict-diff">
                    <span class="verdict-diff-label">Разница</span>
                    <span class="verdict-diff-value {% if fair_price_analysis.price_diff_amount > 0 %}negative{% else %}positive{% endif %}">
                        {% if fair_price_analysis.price_diff_amount > 0 %}+{% endif %}{{ "{:,.0f}".format(fair_price_analysis.price_diff_amount).replace(",", " ") }} ₽
                        ({% if fair_price_analysis.price_diff_percent > 0 %}+{% endif %}{{ "%.0f"|format(fair_price_analysis.price_diff_percent) }}%)
                    </span>
                </div>
            </div>

            <div class="verdict-status">
                {% if fair_price_analysis.is_overpriced %}
                <div class="verdict-status-badge overpriced">ПЕРЕОЦЕНЕНА</div>
                <div class="verdict-recommendation">
                    Рекомендуем снизить цену для быстрой продажи или приготовиться к торгу
                </div>
                {% elif fair_price_analysis.is_underpriced %}
                <div class="verdict-status-badge underpriced">ВЫГОДНАЯ ЦЕНА</div>
                <div class="verdict-recommendation">
                    Цена ниже рынка — высокие шансы на быструю продажу или возможность поднять цену
                </div>
                {% else %}
                <div class="verdict-status-badge fair">В РЫНКЕ</div>
                <div class="verdict-recommendation">
                    Цена соответствует рынку — объект конкурентоспособен
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Информация об объекте -->
        <div class="section">
            <h2 class="section-title">Информация об объекте</h2>

            <div class="info-card">
                <h3 class="subsection-title">Ваш объект</h3>
                {% if property_info %}
                <div class="info-row">
                    <span class="info-label">Цена</span>
                    <span class="info-value">{{ "{:,.0f}".format(property_info.price) }} ₽</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Площадь</span>
                    <span class="info-value">{{ property_info.total_area }} м²</span>
                </div>
                {% if property_info.living_area %}
                <div class="info-row">
                    <span class="info-label">Жилая площадь</span>
                    <span class="info-value">{{ property_info.living_area }} м²</span>
                </div>
                {% endif %}
                <div class="info-row">
                    <span class="info-label">Комнат</span>
                    <span class="info-value">{{ property_info.rooms }}</span>
                </div>
                {% if property_info.floor and property_info.total_floors %}
                <div class="info-row">
                    <span class="info-label">Этаж</span>
                    <span class="info-value">{{ property_info.floor }}/{{ property_info.total_floors }}</span>
                </div>
                {% endif %}
                {% if property_info.address %}
                <div class="info-row">
                    <span class="info-label">Адрес</span>
                    <span class="info-value">{{ property_info.address }}</span>
                </div>
                {% endif %}
                {% if property_info.repair_level %}
                <div class="info-row">
                    <span class="info-label">Ремонт</span>
                    <span class="info-value">{{ property_info.repair_level }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>

            {% if comparables and comparables|length > 0 %}
            <h3 class="subsection-title">Аналоги для сравнения</h3>
            <p style="margin-bottom: 12px;">Найдено <strong>{{ comparables|length }} аналогичных объектов</strong> в том же районе.</p>

            <table>
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Характеристики</th>
                        <th>Цена</th>
                        <th>Цена за м²</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comp in comparables[:10] %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ comp.rooms }}-комн., {{ comp.total_area }} м², {{ comp.floor }}/{{ comp.total_floors }} эт.</td>
                        <td>{{ "{:,.0f}".format(comp.price) }} ₽</td>
                        <td>{{ "{:,.0f}".format(comp.price_per_sqm) }} ₽</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if comparables|length > 10 %}
            <p style="color: #6B7280; font-size: 12px;">... и еще {{ comparables|length - 10 }} объектов</p>
            {% endif %}
            {% endif %}
        </div>

        <!-- Главные выводы -->
        <div class="section">
            <h2 class="section-title">Главные выводы</h2>

            <div class="info-card">
                {% if fair_price_analysis and fair_price_analysis.get('status') != 'insufficient_data' %}
                <div class="info-row">
                    <span class="info-label">Статус цены</span>
                    <span class="info-value">
                        {% if fair_price_analysis.is_fair %}
                        <span class="status-badge status-fair">Справедливая</span>
                        {% elif fair_price_analysis.is_overpriced %}
                        <span class="status-badge status-overpriced">Выше рынка на {{ "{:,.0f}".format(fair_price_analysis.price_diff_amount|abs).replace(",", " ") }} ₽</span>
                        {% elif fair_price_analysis.is_underpriced %}
                        <span class="status-badge status-underpriced">Ниже рынка на {{ "{:,.0f}".format(fair_price_analysis.price_diff_amount|abs).replace(",", " ") }} ₽</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Справедливая цена</span>
                    <span class="info-value">{{ "{:,.0f}".format(fair_price_analysis.fair_price_total) }} ₽</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Текущая цена</span>
                    <span class="info-value">{{ "{:,.0f}".format(property_info.price) }} ₽</span>
                </div>
                {% elif fair_price_analysis and fair_price_analysis.get('status') == 'insufficient_data' %}
                <div class="alert">
                    <h5>Недостаточно данных для расчета</h5>
                    <p>{{ fair_price_analysis.detailed_report }}</p>
                </div>
                {% endif %}

                {% if time_forecast %}
                <div class="info-row">
                    <span class="info-label">Прогноз продажи</span>
                    <span class="info-value">{{ time_forecast.time_range_description }}</span>
                </div>
                {% endif %}

                {% if attractiveness_index %}
                <div class="info-row">
                    <span class="info-label">Привлекательность</span>
                    <span class="info-value">{{ "%.0f"|format(attractiveness_index.total_index) }}/100 ({{ attractiveness_index.category }})</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Уверенность в расчете -->
        {% if fair_price_analysis and fair_price_analysis.confidence %}
        <div class="section">
            <h2 class="section-title">Уверенность в расчете</h2>

            <div class="info-card">
                {% set confidence = fair_price_analysis.confidence %}

                <!-- Уровень уверенности -->
                <div style="margin-bottom: 20px;">
                    <div class="info-row" style="border-bottom: none; padding-bottom: 0;">
                        <span class="info-label" style="font-size: 15px;">Уровень уверенности</span>
                        <span class="info-value" style="font-size: 18px;">
                            {{ confidence.confidence_score }}/100 — {{ confidence.level }}
                        </span>
                    </div>

                    <!-- Прогресс-бар -->
                    <div class="progress-container">
                        <div class="progress-bar" style="width: {{ confidence.confidence_score }}%;">
                            {% if confidence.confidence_score > 15 %}{{ confidence.confidence_score }}%{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Рекомендация -->
                <div class="accent-block">
                    <div class="accent-block-title">Рекомендация</div>
                    <p>{{ confidence.recommendation }}</p>
                </div>

                <!-- Факторы уверенности -->
                <h3 class="subsection-title">Что влияет на уверенность:</h3>
                <ul class="factors-list">
                    {% for reason in confidence.reasons %}
                    <li>{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Детальный расчет -->
            {% if fair_price_analysis.detailed_report %}
            <details open style="margin-top: 20px;">
                <summary></summary>
                <div>
                    <h3 class="subsection-title" style="margin-top: 0;">Детальный расчет справедливой цены</h3>
                    <pre>{{ fair_price_analysis.detailed_report }}</pre>
                </div>
            </details>
            {% endif %}
        </div>
        {% endif %}

        <!-- Персональные рекомендации -->
        {% if recommendations and recommendations|length > 0 %}
        <div class="section page-break-before">
            <h2 class="section-title">Персональные рекомендации</h2>

            <p style="margin-bottom: 16px;">На основе глубокого анализа вашего объекта:</p>

            {% for rec in recommendations %}
            <div class="recommendation-card {% if rec.priority == 1 %}critical{% elif rec.priority == 2 %}high{% elif rec.priority == 3 %}medium{% else %}info{% endif %}">
                <div class="recommendation-title">
                    {{ rec.title }}
                </div>
                {% if rec.message %}
                <div class="recommendation-message">
                    {{ rec.message }}
                </div>
                {% endif %}
                {% if rec.action %}
                <div class="recommendation-action">
                    <strong>Действие:</strong> {{ rec.action }}
                </div>
                {% endif %}
                {% if rec.roi and rec.roi > 0 %}
                <div class="recommendation-roi">
                    Потенциальная выгода: {{ "{:,.0f}".format(rec.roi) }} ₽
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Рыночная статистика -->
        {% if market_statistics %}
        <div class="section">
            <h2 class="section-title">Рыночная статистика</h2>

            <div class="info-card">
                <div class="info-row">
                    <span class="info-label">Количество аналогов</span>
                    <span class="info-value">{{ market_statistics.all.count }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Типичная цена за м²</span>
                    <span class="info-value">{{ "{:,.0f}".format(market_statistics.all.median) }} ₽</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Среднее</span>
                    <span class="info-value">{{ "{:,.0f}".format(market_statistics.all.mean) }} ₽</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Минимум</span>
                    <span class="info-value">{{ "{:,.0f}".format(market_statistics.all.min) }} ₽</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Максимум</span>
                    <span class="info-value">{{ "{:,.0f}".format(market_statistics.all.max) }} ₽</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Сценарии продажи -->
        {% if price_scenarios and price_scenarios|length > 0 %}
        <div class="section">
            <h2 class="section-title">Сценарии продажи</h2>

            <div class="scenarios-grid">
                {% for scenario in price_scenarios %}
                <div class="scenario-card {% if scenario.is_recommended %}recommended{% endif %}">
                    <div class="scenario-header">
                        <div class="scenario-title">
                            <span class="scenario-icon">{{ scenario.icon or '' }}</span>
                            <span class="scenario-name">{{ scenario.name }}</span>
                            {% if scenario.is_recommended %}
                            <span class="scenario-badge">Рекомендуем</span>
                            {% endif %}
                        </div>
                        <span class="scenario-time">{{ scenario.time_months }} мес.</span>
                    </div>

                    <div class="scenario-body">
                        <div class="scenario-flow">
                            <div class="scenario-price-box">
                                <div class="scenario-price-label">Стартовая</div>
                                <div class="scenario-price-value">{{ "{:,.0f}".format(scenario.start_price).replace(",", " ") }} ₽</div>
                            </div>
                            <span class="scenario-arrow">→</span>
                            <div class="scenario-price-box">
                                <div class="scenario-price-label">Торг</div>
                                <div class="scenario-price-value">−{{ "{:,.0f}".format(scenario.start_price - scenario.expected_final_price).replace(",", " ") }} ₽</div>
                            </div>
                            <span class="scenario-arrow">→</span>
                            <div class="scenario-price-box">
                                <div class="scenario-price-label">Итого на руки</div>
                                <div class="scenario-price-value">{{ "{:,.0f}".format(scenario.expected_final_price).replace(",", " ") }} ₽</div>
                            </div>
                        </div>
                        <div class="scenario-desc">{{ scenario.description }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Персонализированный оффер Housler -->
        {% if housler_offer %}
        <div class="section page-break-before">
            <h2 class="section-title">Как мы поможем продать ваш объект</h2>

            <!-- Текущая ситуация -->
            <div class="offer-section">
                <div class="offer-block">
                    <div class="offer-block-title">Что показывает первичный анализ</div>
                    <p style="line-height: 1.6;">
                        {% if housler_offer.situation.price_status == 'overpriced' %}
                            Ваш объект оценен в <strong>{{ "%.2f"|format(housler_offer.situation.current_price / 1000000 if housler_offer.situation.current_price else 0) }} млн ₽</strong>.
                            По нашим расчётам, цена <strong>на {{ "%.0f"|format(housler_offer.situation.price_diff_percent if housler_offer.situation.price_diff_percent else 0) }}% выше</strong> рыночной.
                            {% if housler_offer.situation.has_critical %}
                            Также выявлены моменты, требующие внимания.
                            {% endif %}
                        {% elif housler_offer.situation.price_status == 'underpriced' %}
                            Ваш объект оценен в <strong>{{ "%.2f"|format(housler_offer.situation.current_price / 1000000 if housler_offer.situation.current_price else 0) }} млн ₽</strong>.
                            Цена <strong>на {{ "%.0f"|format(abs(housler_offer.situation.price_diff_percent) if housler_offer.situation.price_diff_percent else 0) }}% ниже</strong> рыночной —
                            это конкурентное преимущество для быстрой продажи.
                        {% else %}
                            Ваш объект оценен в <strong>{{ "%.2f"|format(housler_offer.situation.current_price / 1000000 if housler_offer.situation.current_price else 0) }} млн ₽</strong> —
                            цена соответствует рынку.
                            {% if housler_offer.situation.has_critical %}
                            Выявлены моменты, которые могут повлиять на скорость продажи.
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Наша цель -->
            <div class="offer-section">
                <div class="accent-block">
                    <div class="accent-block-title">Наша цель</div>
                    <p>{{ housler_offer.goal }}</p>
                </div>
            </div>

            <!-- План действий -->
            <div class="offer-section">
                <h3 class="subsection-title">Что мы сделаем</h3>
                {% for action in housler_offer.actions %}
                <div class="action-item">
                    <div class="action-number">{{ loop.index }}.</div>
                    <div class="action-content">
                        <strong>{{ action.title }}</strong>
                        <p>{{ action.description }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Прогноз результата -->
            <div class="offer-section">
                <div class="offer-block-dark">
                    <div class="offer-block-title">Наш прогноз</div>
                    <p style="margin: 0 0 8px 0;">
                        <strong>Целевой срок продажи:</strong> {{ housler_offer.result.timeline }}<br>
                        <strong>Целевой диапазон цены:</strong> {{ housler_offer.result.final_price_formatted }}<br>
                        <strong>Уровень уверенности:</strong> {{ housler_offer.result.confidence }}
                    </p>
                    <p style="margin: 12px 0 0 0; font-size: 13px; opacity: 0.85; font-style: italic;">
                        Точная стратегия и финальная цена будут определены после детальной диагностики.
                    </p>
                </div>
            </div>

            <!-- Стоимость услуг -->
            <div class="offer-section">
                <h3 class="subsection-title">Стоимость услуг</h3>

                <div class="pricing-box">
                    <div class="pricing-value">2%</div>
                    <div class="pricing-label">от стоимости продажи</div>
                    <div class="pricing-note">Эксклюзивный договор, оплата по результату</div>

                    <div class="pricing-features">
                        <div class="pricing-feature">
                            <span class="pricing-feature-check">+</span>
                            <span>Никаких авансов и предоплат</span>
                        </div>
                        <div class="pricing-feature">
                            <span class="pricing-feature-check">+</span>
                            <span>Оплата после успешной сделки</span>
                        </div>
                        <div class="pricing-feature">
                            <span class="pricing-feature-check">+</span>
                            <span>Полное сопровождение до ключей</span>
                        </div>
                    </div>

                    <div style="font-weight: 600; margin-bottom: 10px; text-align: left;">Что входит в стоимость</div>
                    <div class="pricing-grid">
                        <div class="pricing-grid-item">
                            <strong>Подготовка</strong>
                            <span>Фотосъёмка, видео, 3D-тур</span>
                        </div>
                        <div class="pricing-grid-item">
                            <strong>Аналитика</strong>
                            <span>Оценка, аналоги, цена</span>
                        </div>
                        <div class="pricing-grid-item">
                            <strong>Маркетинг</strong>
                            <span>Площадки, продвижение</span>
                        </div>
                        <div class="pricing-grid-item">
                            <strong>Сделка</strong>
                            <span>Показы, переговоры, оформление</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="cta-block">
                <h3>Готовы начать?</h3>
                <p>Свяжитесь с нами для бесплатной консультации.</p>
                <p>Обсудим ваш объект и составим индивидуальную стратегию продажи.</p>
                <div class="brand">HOUSLER — продаем быстро и выгодно</div>
            </div>
        </div>
        {% endif %}

        <!-- Методология расчёта -->
        <div class="section">
            <h2 class="section-title">Методология</h2>

            <div class="info-card">
                <h3 class="subsection-title" style="margin-top: 0;">Как рассчитана рыночная цена</h3>
                <p style="line-height: 1.6; margin-bottom: 12px;">
                    Мы проанализировали {% if comparables %}{{ comparables|length }}{% else %}десятки{% endif %} похожих квартир
                    в вашем районе и рассчитали типичную цену за метр. Затем учли особенности именно вашего объекта.
                </p>

                <h3 class="subsection-title">Что учитывается в расчёте</h3>
                <ul class="factors-list">
                    <li>Площадь квартиры и жилая площадь</li>
                    <li>Этаж и этажность дома</li>
                    <li>Тип и качество отделки</li>
                    <li>Год постройки дома</li>
                    <li>Высота потолков</li>
                    <li>Вид из окна</li>
                </ul>

                <div class="accent-block" style="margin-top: 16px;">
                    <div class="accent-block-title">Важно понимать</div>
                    <p>
                        Данный анализ основан на математической модели и базовых параметрах объекта.
                        Реальная рыночная стоимость может отличаться в зависимости от факторов,
                        которые сложно оценить автоматически: уникальность планировки, качество вида,
                        состояние подъезда, эмоциональная привлекательность объекта и текущая рыночная конъюнктура.
                    </p>
                </div>
            </div>
        </div>

        <!-- Футер -->
        <div class="footer">
            <p>Этот отчет создан системой <strong>HOUSLER</strong> — анализ недвижимости на основе рыночных данных.</p>
            <p>Отчет носит информационный характер и не является финансовой рекомендацией.</p>
            <p>© {{ date[:4] }} HOUSLER. Все права защищены.</p>
        </div>
    </div>
</body>
</html>
