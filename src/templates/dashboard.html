<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            max-width: 1400px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin-bottom: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 5px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-card .subvalue {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stat-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 5px;
        }

        .stat-badge.success {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .stat-badge.danger {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }

        .stat-badge.warning {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
            border: 2px solid var(--warning-color);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateX(5px);
        }

        .scenario-card h4 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .scenario-card .probability {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .progress-bar-custom {
            height: 30px;
            border-radius: 15px;
            background: #ecf0f1;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 1s ease;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: block;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
        }

        .comparison-table {
            width: 100%;
            margin-top: 20px;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .comparison-table tr:hover {
            background-color: #f8f9fa;
        }

        .alert-custom {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-custom.warning {
            background: rgba(243, 156, 18, 0.1);
            border-left: 5px solid var(--warning-color);
        }

        .alert-custom.success {
            background: rgba(39, 174, 96, 0.1);
            border-left: 5px solid var(--success-color);
        }

        .alert-custom.danger {
            background: rgba(231, 76, 60, 0.1);
            border-left: 5px solid var(--danger-color);
        }

        #results-section {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .comparable-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .comparable-item .remove-btn {
            color: #e74c3c;
            cursor: pointer;
            float: right;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header">
                <h1>üìä –î–∞—à–±–æ—Ä–¥ –ê–Ω–∞–ª–∏–∑–∞ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>
                <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –æ–±—ä–µ–∫—Ç–æ–≤</p>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
            <div class="section-title">üè† –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç</div>

            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" id="target-price" placeholder="195000000" value="195000000">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <label>–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                        <input type="number" id="target-total-area" placeholder="180.4" value="180.4" step="0.1">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <label>–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)</label>
                        <input type="number" id="target-living-area" placeholder="40.2" value="40.2" step="0.1">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="input-group">
                        <label>–ö–æ–º–Ω–∞—Ç</label>
                        <input type="number" id="target-rooms" placeholder="3" value="3">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <label>–≠—Ç–∞–∂</label>
                        <input type="text" id="target-floor" placeholder="6/7" value="6/7">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="target-design" checked>
                            –î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è –æ—Ç–¥–µ–ª–∫–∞
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="target-panoramic" checked>
                            –ü–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –≤–∏–¥—ã
                        </label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="target-premium" checked>
                            –ü—Ä–µ–º–∏—É–º –ª–æ–∫–∞—Ü–∏—è
                        </label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="target-renders" checked>
                            –¢–æ–ª—å–∫–æ —Ä–µ–Ω–¥–µ—Ä—ã (–Ω–µ—Ç —Ñ–æ—Ç–æ)
                        </label>
                    </div>
                </div>
            </div>

            <hr style="margin: 40px 0;">

            <!-- –ê–Ω–∞–ª–æ–≥–∏ -->
            <div class="section-title">üìã –ê–Ω–∞–ª–æ–≥–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</div>

            <div id="comparables-list"></div>

            <div class="row">
                <div class="col-md-3">
                    <input type="number" id="comp-price" placeholder="–¶–µ–Ω–∞" class="form-control">
                </div>
                <div class="col-md-2">
                    <input type="number" id="comp-area" placeholder="–ü–ª–æ—â–∞–¥—å –º¬≤" class="form-control" step="0.1">
                </div>
                <div class="col-md-2">
                    <input type="number" id="comp-rooms" placeholder="–ö–æ–º–Ω–∞—Ç" class="form-control">
                </div>
                <div class="col-md-2">
                    <input type="text" id="comp-floor" placeholder="–≠—Ç–∞–∂" class="form-control">
                </div>
                <div class="col-md-1">
                    <input type="checkbox" id="comp-design"> –î–∏–∑–∞–π–Ω
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary" onclick="addComparable()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn-analyze" onclick="analyzeProperty()">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p style="margin-top: 20px; color: #666;">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑...</p>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results-section">
            <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="main-card">
                <div class="section-title">üìà –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h3>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤</h3>
                            <div class="value" id="metric-current-price">-</div>
                            <div class="subvalue">–º–ª–Ω ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <h3>–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤</h3>
                            <div class="value" id="metric-fair-price">-</div>
                            <div class="subvalue">–º–ª–Ω ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <h3>–°—Ä–µ–¥–Ω—è—è –ø–æ —Ä—ã–Ω–∫—É</h3>
                            <div class="value" id="metric-market-avg">-</div>
                            <div class="subvalue">–º–ª–Ω ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <h3>–ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞</h3>
                            <div class="value" id="metric-overpricing">-</div>
                            <div class="subvalue">%</div>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top: 20px;">
                    <div class="col-md-4">
                        <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <h3>–ü—Ä–æ—Ü–µ–Ω—Ç –∂–∏–ª–æ–π –ø–ª–æ—â–∞–¥–∏</h3>
                            <div class="value" id="metric-living-percent">-</div>
                            <div class="subvalue">%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <h3>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞</h3>
                            <div class="value" id="metric-recommended">-</div>
                            <div class="subvalue">–º–ª–Ω ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <h3>–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏</h3>
                            <div class="value" id="metric-time">4-5</div>
                            <div class="subvalue">–º–µ—Å—è—Ü–µ–≤</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω -->
            <div class="main-card">
                <div class="section-title">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∑–∞ –º¬≤ —Å –∞–Ω–∞–ª–æ–≥–∞–º–∏</div>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂–∏ -->
            <div class="main-card">
                <div class="section-title">üíº –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂–∏</div>
                <div id="scenarios-container"></div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Ü–µ–Ω -->
            <div class="main-card">
                <div class="section-title">üìâ –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º</div>
                <div class="chart-container">
                    <canvas id="scenariosChart"></canvas>
                </div>
            </div>

            <!-- –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã -->
            <div class="main-card">
                <div class="section-title">‚öñÔ∏è –ê–Ω–∞–ª–∏–∑ —Å–∏–ª—å–Ω—ã—Ö –∏ —Å–ª–∞–±—ã—Ö —Å—Ç–æ—Ä–æ–Ω</div>

                <div class="row">
                    <div class="col-md-6">
                        <h4 style="color: var(--success-color); margin-bottom: 20px;">‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</h4>
                        <div id="strengths-list"></div>
                    </div>
                    <div class="col-md-6">
                        <h4 style="color: var(--danger-color); margin-bottom: 20px;">‚ùå –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</h4>
                        <div id="weaknesses-list"></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="alert-custom" id="net-adjustment-alert">
                        <div style="font-size: 2rem;">‚öñÔ∏è</div>
                        <div>
                            <strong>–ò—Ç–æ–≥–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞:</strong>
                            <div id="net-adjustment-text" style="font-size: 1.2rem; font-weight: 600;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω—ã -->
            <div class="main-card">
                <div class="section-title">üßÆ –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω—ã</div>
                <div id="fair-price-details"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        let comparables = [];

        // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏
        function loadDefaultComparables() {
            comparables = [
                {price: 150000000, area: 161.4, rooms: 3, floor: '3/9', has_design: true},
                {price: 107900000, area: 145, rooms: 3, floor: '3/9', has_design: true},
                {price: 130000000, area: 186, rooms: 5, floor: '3/9', has_design: true},
                {price: 87000000, area: 110, rooms: 3, floor: '5/9', has_design: true},
                {price: 75000000, area: 106.2, rooms: 3, floor: '5/9', has_design: true},
                {price: 70000000, area: 107.6, rooms: 3, floor: '9/9', has_design: false},
                {price: 72000000, area: 110, rooms: 3, floor: '5/9', has_design: false},
                {price: 58000000, area: 105.3, rooms: 2, floor: '4/9', has_design: false}
            ];
            updateComparablesList();
        }

        function addComparable() {
            const price = parseFloat(document.getElementById('comp-price').value);
            const area = parseFloat(document.getElementById('comp-area').value);
            const rooms = parseInt(document.getElementById('comp-rooms').value);
            const floor = document.getElementById('comp-floor').value;
            const hasDesign = document.getElementById('comp-design').checked;

            if (!price || !area) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º —Ü–µ–Ω—É –∏ –ø–ª–æ—â–∞–¥—å!');
                return;
            }

            comparables.push({
                price: price,
                area: area,
                rooms: rooms,
                floor: floor,
                has_design: hasDesign,
                price_per_sqm: price / area
            });

            // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
            document.getElementById('comp-price').value = '';
            document.getElementById('comp-area').value = '';
            document.getElementById('comp-rooms').value = '';
            document.getElementById('comp-floor').value = '';
            document.getElementById('comp-design').checked = false;

            updateComparablesList();
        }

        function removeComparable(index) {
            comparables.splice(index, 1);
            updateComparablesList();
        }

        function updateComparablesList() {
            const container = document.getElementById('comparables-list');

            if (comparables.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">–ê–Ω–∞–ª–æ–≥–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 3 –∞–Ω–∞–ª–æ–≥–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</p>';
                return;
            }

            let html = '';
            comparables.forEach((comp, index) => {
                const pricePerSqm = (comp.price / comp.area / 1000000).toFixed(3);
                html += `
                    <div class="comparable-item">
                        <span class="remove-btn" onclick="removeComparable(${index})">‚úï</span>
                        <strong>${comp.rooms || '?'}-–∫–æ–º–Ω</strong> ${comp.area}–º¬≤ ‚Ä¢
                        ${(comp.price / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ ‚Ä¢
                        ${pricePerSqm} –º–ª–Ω/–º¬≤ ‚Ä¢
                        ${comp.floor || '?'} ‚Ä¢
                        ${comp.has_design ? '‚ú® –î–∏–∑–∞–π–Ω' : 'üîß –ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞'}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function analyzeProperty() {
            // –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            const targetProperty = {
                price: parseFloat(document.getElementById('target-price').value),
                total_area: parseFloat(document.getElementById('target-total-area').value),
                living_area: parseFloat(document.getElementById('target-living-area').value),
                rooms: parseInt(document.getElementById('target-rooms').value),
                floor: document.getElementById('target-floor').value,
                has_design: document.getElementById('target-design').checked,
                panoramic_views: document.getElementById('target-panoramic').checked,
                premium_location: document.getElementById('target-premium').checked,
                renders_only: document.getElementById('target-renders').checked
            };

            // –î–æ–±–∞–≤–∏—Ç—å price_per_sqm
            targetProperty.price_per_sqm = targetProperty.price / targetProperty.total_area;

            // –î–æ–±–∞–≤–∏—Ç—å price_per_sqm –¥–ª—è –∞–Ω–∞–ª–æ–≥–æ–≤
            const comparablesWithPrice = comparables.map(comp => ({
                ...comp,
                price_per_sqm: comp.price / comp.area
            }));

            // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').style.display = 'block';

            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑
            fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target_property: targetProperty,
                    comparables: comparablesWithPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results-section').style.display = 'block';

                // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
                document.getElementById('loading').style.display = 'none';
            });
        }

        function displayResults(data) {
            // –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
            const currentPrice = data.target_property.price_per_sqm / 1000000;
            const fairPrice = data.fair_price_analysis.fair_price_per_sqm / 1000000;
            const marketAvg = data.market_statistics.all.mean / 1000000;
            const overpricing = data.fair_price_analysis.overpricing_percent;
            const livingPercent = data.target_property.living_area_percent;

            document.getElementById('metric-current-price').textContent = currentPrice.toFixed(3);
            document.getElementById('metric-fair-price').textContent = fairPrice.toFixed(3);
            document.getElementById('metric-market-avg').textContent = marketAvg.toFixed(3);
            document.getElementById('metric-overpricing').textContent = overpricing.toFixed(1);
            document.getElementById('metric-living-percent').textContent = livingPercent.toFixed(1);
            document.getElementById('metric-recommended').textContent =
                (data.fair_price_analysis.fair_price_total / 1000000).toFixed(1);

            // –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            displayComparisonChart(data.comparison_chart_data);

            // –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂–∏
            displayScenarios(data.price_scenarios);

            // –ì—Ä–∞—Ñ–∏–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
            displayScenariosChart(data.price_scenarios);

            // –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
            displayStrengthsWeaknesses(data.strengths_weaknesses);

            // –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
            displayFairPriceDetails(data.fair_price_analysis, data.market_statistics);
        }

        function displayComparisonChart(chartData) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (window.comparisonChart) {
                window.comparisonChart.destroy();
            }

            window.comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∑–∞ –º¬≤ (–º–ª–Ω ‚ÇΩ)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–¶–µ–Ω–∞ –∑–∞ –º¬≤ (–º–ª–Ω ‚ÇΩ)'
                            }
                        }
                    }
                }
            });
        }

        function displayScenarios(scenarios) {
            const container = document.getElementById('scenarios-container');
            let html = '';

            scenarios.forEach(scenario => {
                const finalPrice = (scenario.expected_final_price / 1000000).toFixed(1);
                const startPrice = (scenario.start_price / 1000000).toFixed(1);

                html += `
                    <div class="scenario-card">
                        <h4>${scenario.name}</h4>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">${scenario.description}</p>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <strong>–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ü–µ–Ω–∞:</strong> ${startPrice} –º–ª–Ω ‚ÇΩ
                            </div>
                            <div>
                                <strong>–û–∂–∏–¥–∞–µ–º–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è:</strong> ${finalPrice} –º–ª–Ω ‚ÇΩ
                            </div>
                            <span class="probability">${scenario.probability}% —É—Å–ø–µ—Ö–∞</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #7f8c8d;">
                            <div><strong>–°—Ä–æ–∫:</strong> ${scenario.time_months} –º–µ—Å.</div>
                            <div><strong>–°–∫–∏–¥–∫–∞:</strong> ${((1 - scenario.expected_final_price / scenario.start_price) * 100).toFixed(1)}%</div>
                        </div>

                        <div class="progress-bar-custom" style="margin-top: 15px;">
                            <div class="progress-fill" style="width: ${scenario.probability}%;">
                                ${scenario.probability}%
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayScenariosChart(scenarios) {
            const ctx = document.getElementById('scenariosChart').getContext('2d');

            if (window.scenariosChart) {
                window.scenariosChart.destroy();
            }

            const datasets = scenarios.map((scenario, index) => {
                const colors = [
                    'rgb(102, 126, 234)',
                    'rgb(118, 75, 162)',
                    'rgb(52, 152, 219)',
                    'rgb(231, 76, 60)'
                ];

                return {
                    label: scenario.name,
                    data: scenario.steps.map(step => ({
                        x: step.month,
                        y: step.price / 1000000
                    })),
                    borderColor: colors[index],
                    backgroundColor: colors[index],
                    tension: 0.3
                };
            });

            window.scenariosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '–î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω –ø–æ –º–µ—Å—è—Ü–∞–º',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: '–ú–µ—Å—è—Ü—ã'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '–¶–µ–Ω–∞ (–º–ª–Ω ‚ÇΩ)'
                            }
                        }
                    }
                }
            });
        }

        function displayStrengthsWeaknesses(data) {
            // –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
            let strengthsHtml = '';
            data.strengths.forEach(strength => {
                strengthsHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${strength.factor}</strong>
                            <span class="stat-badge success">+${strength.premium_percent}%</span>
                        </div>
                        <div class="progress-bar-custom" style="height: 20px;">
                            <div class="progress-fill" style="width: ${strength.impact * 10}%; background: var(--success-color);"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('strengths-list').innerHTML = strengthsHtml || '<p style="color: #999;">–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã</p>';

            // –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
            let weaknessesHtml = '';
            data.weaknesses.forEach(weakness => {
                weaknessesHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${weakness.factor}</strong>
                            <span class="stat-badge danger">-${weakness.discount_percent}%</span>
                        </div>
                        <div class="progress-bar-custom" style="height: 20px;">
                            <div class="progress-fill" style="width: ${weakness.impact * 10}%; background: var(--danger-color);"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('weaknesses-list').innerHTML = weaknessesHtml || '<p style="color: #999;">–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã</p>';

            // –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
            const netAdjustment = data.net_adjustment;
            const alertDiv = document.getElementById('net-adjustment-alert');

            if (netAdjustment > 0) {
                alertDiv.className = 'alert-custom success';
                document.getElementById('net-adjustment-text').innerHTML =
                    `+${netAdjustment.toFixed(1)}% (–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω)`;
            } else if (netAdjustment < 0) {
                alertDiv.className = 'alert-custom danger';
                document.getElementById('net-adjustment-text').innerHTML =
                    `${netAdjustment.toFixed(1)}% (–¥–æ–º–∏–Ω–∏—Ä—É—é—Ç —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã)`;
            } else {
                alertDiv.className = 'alert-custom warning';
                document.getElementById('net-adjustment-text').innerHTML =
                    `–ë–∞–ª–∞–Ω—Å (—Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω—ã)`;
            }
        }

        function displayFairPriceDetails(fairPrice, marketStats) {
            let html = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤</strong></td>
                            <td>${(fairPrice.base_price_per_sqm / 1000000).toFixed(3)} –º–ª–Ω ‚ÇΩ</td>
                            <td>–°—Ä–µ–¥–Ω—è—è –ø–æ –∞–Ω–∞–ª–æ–≥–∞–º —Å –¥–∏–∑–∞–π–Ω–æ–º</td>
                        </tr>
                        <tr>
                            <td><strong>–ò—Ç–æ–≥–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç</strong></td>
                            <td>${fairPrice.final_multiplier.toFixed(3)}</td>
                            <td>–£—á–µ—Ç –≤—Å–µ—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫</td>
                        </tr>
                        <tr>
                            <td><strong>–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤</strong></td>
                            <td>${(fairPrice.fair_price_per_sqm / 1000000).toFixed(3)} –º–ª–Ω ‚ÇΩ</td>
                            <td>–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫</td>
                        </tr>
                        <tr style="background: #f0f8ff;">
                            <td><strong>–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞</strong></td>
                            <td><strong>${(fairPrice.fair_price_total / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ</strong></td>
                            <td>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞</td>
                        </tr>
                        <tr>
                            <td><strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</strong></td>
                            <td>${(fairPrice.current_price / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ</td>
                            <td>–ó–∞—è–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–¥–∞–≤—Ü–æ–º</td>
                        </tr>
                        <tr style="background: ${fairPrice.overpricing_percent > 10 ? '#ffe0e0' : '#e0ffe0'};">
                            <td><strong>–ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞</strong></td>
                            <td><strong>${fairPrice.overpricing_percent.toFixed(1)}%</strong></td>
                            <td>${(fairPrice.overpricing_amount / 1000000).toFixed(1)} –º–ª–Ω ‚ÇΩ ${fairPrice.overpricing_percent > 10 ? '(–∑–∞–≤—ã—à–µ–Ω–∞)' : '(–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã)'}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert-custom ${fairPrice.overpricing_percent > 15 ? 'danger' : fairPrice.overpricing_percent > 5 ? 'warning' : 'success'}" style="margin-top: 20px;">
                    <div style="font-size: 2rem;">${fairPrice.overpricing_percent > 15 ? '‚ö†Ô∏è' : fairPrice.overpricing_percent > 5 ? '‚ö°' : '‚úÖ'}</div>
                    <div>
                        <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong>
                        ${fairPrice.overpricing_percent > 15 ?
                            '–¶–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–≤—ã—à–µ–Ω–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ ' + ((fairPrice.overpricing_amount / fairPrice.current_price) * 100).toFixed(0) + '% –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏.' :
                            fairPrice.overpricing_percent > 5 ?
                            '–¶–µ–Ω–∞ –∑–∞–≤—ã—à–µ–Ω–∞ —É–º–µ—Ä–µ–Ω–Ω–æ. –ù–µ–±–æ–ª—å—à–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —É–≤–µ–ª–∏—á–∏—Ç —à–∞–Ω—Å—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É.' :
                            '–¶–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ. –û–±—ä–µ–∫—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω –Ω–∞ —Ä—ã–Ω–∫–µ.'
                        }
                    </div>
                </div>
            `;

            document.getElementById('fair-price-details').innerHTML = html;
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadDefaultComparables();
        };
    </script>
</body>
</html>
