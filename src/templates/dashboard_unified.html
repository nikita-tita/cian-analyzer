<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Real Estate Analysis Dashboard v2.0</title>
    <link rel="stylesheet" href="/static/css/unified-dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1>üè† –ê–Ω–∞–ª–∏–∑ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ v2.0</h1>
                <p class="subtitle">–£–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏</p>
            </div>
            <div class="health-status" id="healthStatus">
                <span class="status-indicator"></span>
                <span class="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
        </header>

        <!-- Main Content -->
        <div class="dashboard-main">
            <!-- Input Form Section -->
            <section class="card input-section">
                <h2>üìã –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞</h2>
                <form id="analysisForm">
                    <div class="form-grid">
                        <!-- Target Property -->
                        <div class="form-section">
                            <h3>–¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç</h3>

                            <div class="form-group">
                                <label for="targetPrice">
                                    –¶–µ–Ω–∞ –∑–∞ –º¬≤ (‚ÇΩ)
                                    <span class="glossary-term" data-term="price_per_sqm">‚ÑπÔ∏è</span>
                                </label>
                                <input type="number" id="targetPrice" name="targetPrice"
                                       value="200000" required min="10000" step="1000">
                            </div>

                            <div class="form-group">
                                <label for="targetArea">–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
                                <input type="number" id="targetArea" name="targetArea"
                                       value="50" required min="10" step="0.1">
                            </div>

                            <div class="form-group">
                                <label for="targetLivingArea">
                                    –ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å (–º¬≤)
                                    <span class="glossary-term" data-term="living_area_percent">‚ÑπÔ∏è</span>
                                </label>
                                <input type="number" id="targetLivingArea" name="targetLivingArea"
                                       value="30" required min="5" step="0.1">
                            </div>

                            <div class="form-group">
                                <label for="targetFloor">–≠—Ç–∞–∂</label>
                                <input type="number" id="targetFloor" name="targetFloor"
                                       value="5" required min="1" max="100">
                            </div>

                            <div class="form-group">
                                <label for="targetTotalFloors">–≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ</label>
                                <input type="number" id="targetTotalFloors" name="targetTotalFloors"
                                       value="10" required min="1" max="100">
                            </div>

                            <div class="form-group">
                                <label for="targetRooms">–ö–æ–º–Ω–∞—Ç</label>
                                <input type="number" id="targetRooms" name="targetRooms"
                                       value="2" required min="1" max="20">
                            </div>

                            <div class="form-group">
                                <label for="repairLevel">
                                    –£—Ä–æ–≤–µ–Ω—å –æ—Ç–¥–µ–ª–∫–∏
                                    <span class="glossary-term" data-term="repair_level">‚ÑπÔ∏è</span>
                                </label>
                                <select id="repairLevel" name="repairLevel" required>
                                    <option value="—á–µ—Ä–Ω–æ–≤–∞—è">–ß–µ—Ä–Ω–æ–≤–∞—è (-25%)</option>
                                    <option value="—ç–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º (-15%)</option>
                                    <option value="—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è" selected>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (–±–∞–∑–∞)</option>
                                    <option value="–∫–∞–ø–∏—Ç–∞–ª—å–Ω–∞—è">–ö–∞–ø–∏—Ç–∞–ª—å–Ω–∞—è (+15%)</option>
                                    <option value="—É–ª—É—á—à–µ–Ω–Ω–∞—è">–£–ª—É—á—à–µ–Ω–Ω–∞—è (+25%)</option>
                                    <option value="–ø—Ä–µ–º–∏—É–º">–ü—Ä–µ–º–∏—É–º (+50%)</option>
                                    <option value="–ª—é–∫—Å">–õ—é–∫—Å (+80%)</option>
                                    <option value="–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è">–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è (+100%)</option>
                                </select>
                                <small>–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ü–µ–Ω—É: –æ—Ç -25% –¥–æ +100%</small>
                            </div>

                            <div class="form-group">
                                <label for="viewType">
                                    –í–∏–¥ –∏–∑ –æ–∫–Ω–∞
                                    <span class="glossary-term" data-term="view_type">‚ÑπÔ∏è</span>
                                </label>
                                <select id="viewType" name="viewType" required>
                                    <option value="—Ö—É–¥–æ–≥–æ–≤">–ü—Ä–æ–º–∑–æ–Ω–∞/–º—É—Å–æ—Ä–∫–∞ (-3%)</option>
                                    <option value="–¥–æ–º" selected>–î–≤–æ—Ä/–¥–æ–º (–±–∞–∑–∞)</option>
                                    <option value="—É–ª–∏—Ü–∞">–£–ª–∏—Ü–∞ (–±–∞–∑–∞)</option>
                                    <option value="–ø–∞—Ä–∫">–ü–∞—Ä–∫ (+3%)</option>
                                    <option value="–≥–æ—Ä–æ–¥">–ì–æ—Ä–æ–¥ (+4%)</option>
                                    <option value="–≤–æ–¥–∞">–í–æ–¥–∞ (+5%)</option>
                                    <option value="–∑–∞–∫–∞—Ç">–ó–∞–∫–∞—Ç (+5%)</option>
                                    <option value="–ø—Ä–µ–º–∏—É–º">–ü—Ä–µ–º–∏—É–º (+5%)</option>
                                </select>
                                <small>–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ü–µ–Ω—É: –¥–æ ¬±5%</small>
                            </div>
                        </div>

                        <!-- Analysis Options -->
                        <div class="form-section">
                            <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

                            <div class="form-group">
                                <label for="comparablesCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–æ–≥–æ–≤</label>
                                <input type="number" id="comparablesCount" name="comparablesCount"
                                       value="10" min="3" max="50">
                                <small>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 10-20 –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="filterOutliers" checked>
                                    –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–æ—Å—ã (¬±3œÉ)
                                    <span class="glossary-term" data-term="sigma">‚ÑπÔ∏è</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="useMedian" checked>
                                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–¥–∏–∞–Ω—É
                                    <span class="glossary-term" data-term="median">‚ÑπÔ∏è</span>
                                </label>
                            </div>

                        </div>
                    </div>
                </form>

                <!-- Floating Action Bar -->
                <div class="floating-action-bar">
                    <button type="submit" form="analysisForm" class="btn btn-primary btn-floating">
                        üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </section>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä—ã–Ω–æ–∫...</p>
            </div>

            <!-- Results Section -->
            <div id="resultsContainer" style="display: none;">

                <!-- Recommendations Panel -->
                <section class="card recommendations-section">
                    <h2>üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
                    <div id="recommendationsContainer" class="recommendations-grid">
                        <!-- Will be populated dynamically -->
                    </div>
                </section>

                <!-- Waterfall Chart -->
                <section class="card chart-section">
                    <h2>üìä –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω—ã</h2>
                    <p class="chart-description">
                        –ü–æ—à–∞–≥–æ–≤–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≥–æ, –∫–∞–∫ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –≤–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                    </p>
                    <div class="chart-container">
                        <canvas id="waterfallChart"></canvas>
                    </div>
                </section>

                <!-- Price Analysis Summary -->
                <section class="card summary-section">
                    <h2>üí∞ –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω—ã</h2>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                            <div class="summary-value" id="currentPrice">‚Äî</div>
                        </div>
                        <div class="summary-card highlight">
                            <div class="summary-label">–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞</div>
                            <div class="summary-value" id="fairPrice">‚Äî</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">
                                –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
                                <span class="glossary-term" data-term="overpricing">‚ÑπÔ∏è</span>
                            </div>
                            <div class="summary-value" id="priceDeviation">‚Äî</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</div>
                            <div class="summary-value" id="priceRecommendation">‚Äî</div>
                        </div>
                    </div>
                </section>

                <!-- Market Statistics -->
                <section class="card stats-section">
                    <h2>üìà –†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-label">
                                    –ú–µ–¥–∏–∞–Ω–∞ —Ä—ã–Ω–∫–∞
                                    <span class="glossary-term" data-term="median">‚ÑπÔ∏è</span>
                                </div>
                                <div class="stat-value" id="marketMedian">‚Äî</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìâ</div>
                            <div class="stat-content">
                                <div class="stat-label">–ú–∏–Ω–∏–º—É–º</div>
                                <div class="stat-value" id="marketMin">‚Äî</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <div class="stat-label">–ú–∞–∫—Å–∏–º—É–º</div>
                                <div class="stat-value" id="marketMax">‚Äî</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-label">–†–∞–∑–±—Ä–æ—Å (œÉ)</div>
                                <div class="stat-value" id="marketStd">‚Äî</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <div class="stat-label">–ê–Ω–∞–ª–æ–≥–æ–≤</div>
                                <div class="stat-value" id="comparablesCount">‚Äî</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üîç</div>
                            <div class="stat-content">
                                <div class="stat-label">–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</div>
                                <div class="stat-value" id="filteredCount">‚Äî</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Selling Scenarios -->
                <section class="card scenarios-section">
                    <h2>üé≤ –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂–∏</h2>
                    <div id="scenariosContainer" class="scenarios-grid">
                        <!-- Will be populated dynamically -->
                    </div>
                </section>

            </div>
        </div>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p>Unified Real Estate Analysis Dashboard v2.0 | Powered by Smart Analytics</p>
        </footer>
    </div>

    <!-- Glossary Tooltip Container -->
    <div id="glossaryTooltip" class="glossary-tooltip" style="display: none;"></div>

    <!-- Scripts -->
    <script src="/static/js/glossary.js"></script>
    <script>
        // Initialize glossary
        const glossary = new GlossaryTooltip();

        // Check health status
        async function checkHealth() {
            const statusEl = document.getElementById('healthStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (data.status === 'healthy') {
                    statusEl.innerHTML = '<span class="status-indicator status-healthy"></span><span class="status-text">–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</span>';
                } else {
                    statusEl.innerHTML = '<span class="status-indicator status-error"></span><span class="status-text">–û—à–∏–±–∫–∞</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span class="status-indicator status-error"></span><span class="status-text">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>';
            }
        }

        // Format price
        function formatPrice(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            const sign = value > 0 ? '+' : '';
            return `${sign}${value.toFixed(1)}%`;
        }

        // Render recommendations
        function renderRecommendations(recommendations) {
            const container = document.getElementById('recommendationsContainer');

            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<p class="empty-state">–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>';
                return;
            }

            container.innerHTML = recommendations.map(rec => {
                const priorityClass = `priority-${rec.priority}`;
                const priorityLabel = ['', '–ö–†–ò–¢–ò–ß–ù–û', '–í–ê–ñ–ù–û', '–°–†–ï–î–ù–ï', '–ò–ù–§–û'][rec.priority];
                const priorityIcon = ['', '‚ö†Ô∏è', 'üéØ', 'üí°', '‚ÑπÔ∏è'][rec.priority];

                let actionsHtml = '';
                if (rec.actions && rec.actions.length > 0) {
                    actionsHtml = `
                        <div class="recommendation-actions">
                            ${rec.actions.map(action => `
                                <div class="action-item">
                                    <strong>–î–µ–π—Å—Ç–≤–∏–µ:</strong> ${action.action}<br>
                                    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${action.result}
                                    ${action.value ? `<br><strong>–≠—Ñ—Ñ–µ–∫—Ç:</strong> ${action.value}` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                let roiHtml = '';
                if (rec.roi !== null && rec.roi !== undefined) {
                    roiHtml = `
                        <div class="roi-badge">
                            <div class="roi-circle">
                                <span class="roi-value">${rec.roi}%</span>
                            </div>
                            <span class="roi-label">ROI</span>
                        </div>
                    `;
                }

                return `
                    <div class="recommendation-card ${priorityClass}">
                        <div class="recommendation-header">
                            <span class="recommendation-priority">${priorityIcon} [${priorityLabel}]</span>
                            ${roiHtml}
                        </div>
                        <h3 class="recommendation-title">${rec.title}</h3>
                        <p class="recommendation-description">${rec.description}</p>
                        ${actionsHtml}
                    </div>
                `;
            }).join('');
        }

        // Render waterfall chart
        let waterfallChartInstance = null;

        function renderWaterfallChart(data) {
            const ctx = document.getElementById('waterfallChart').getContext('2d');

            if (waterfallChartInstance) {
                waterfallChartInstance.destroy();
            }

            const labels = data.steps.map(s => s.label);
            const values = data.steps.map(s => s.value);
            const colors = data.steps.map(s => {
                if (s.type === 'base' || s.type === 'total') return '#3b82f6';
                if (s.type === 'positive') return '#10b981';
                return '#ef4444';
            });

            // Calculate cumulative values for waterfall effect
            let cumulative = 0;
            const chartData = data.steps.map((step, idx) => {
                if (step.type === 'base') {
                    cumulative = step.value;
                    return [0, cumulative];
                } else if (step.type === 'total') {
                    return [0, cumulative];
                } else {
                    const start = cumulative;
                    cumulative += step.value;
                    return [start, cumulative];
                }
            });

            waterfallChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '–ü–æ—à–∞–≥–æ–≤–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω—ã',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const step = data.steps[context.dataIndex];
                                    const value = step.value;
                                    return [
                                        `–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${formatPrice(Math.abs(value))}`,
                                        step.explanation || ''
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatPrice(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render scenarios
        function renderScenarios(scenarios) {
            const container = document.getElementById('scenariosContainer');

            if (!scenarios || scenarios.length === 0) {
                container.innerHTML = '<p class="empty-state">–ù–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</p>';
                return;
            }

            container.innerHTML = scenarios.map((scenario, idx) => {
                const strategyIcons = {
                    'aggressive': 'üöÄ',
                    'moderate': '‚öñÔ∏è',
                    'conservative': 'üõ°Ô∏è',
                    'optimal': 'üéØ'
                };

                return `
                    <div class="scenario-card">
                        <div class="scenario-header">
                            <h3>${strategyIcons[scenario.strategy] || 'üìä'} ${scenario.strategy}</h3>
                            <span class="scenario-probability">${(scenario.success_probability * 100).toFixed(0)}%</span>
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-price">
                                <label>–¶–µ–Ω–∞:</label>
                                <span>${formatPrice(scenario.recommended_price_per_sqm)}/–º¬≤</span>
                            </div>
                            <div class="scenario-time">
                                <label>–í—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏:</label>
                                <span>${scenario.expected_sale_time_months} –º–µ—Å</span>
                            </div>
                            <div class="scenario-revenue">
                                <label>–ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥:</label>
                                <span>${formatPrice(scenario.net_revenue)}</span>
                            </div>
                        </div>
                        <div class="scenario-footer">
                            <small>${scenario.reasoning}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update summary cards
        function updateSummary(analysisResult) {
            const currentPrice = analysisResult.target_property.price_per_sqm;
            const fairPrice = analysisResult.fair_price_analysis.final_fair_price_per_sqm;
            const deviation = ((currentPrice - fairPrice) / fairPrice) * 100;

            document.getElementById('currentPrice').textContent = formatPrice(currentPrice) + '/–º¬≤';
            document.getElementById('fairPrice').textContent = formatPrice(fairPrice) + '/–º¬≤';

            const deviationEl = document.getElementById('priceDeviation');
            deviationEl.textContent = formatPercent(deviation);
            deviationEl.className = 'summary-value ' + (deviation > 5 ? 'negative' : deviation < -5 ? 'positive' : '');

            const recommendationEl = document.getElementById('priceRecommendation');
            if (Math.abs(deviation) < 5) {
                recommendationEl.textContent = '‚úÖ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞';
                recommendationEl.className = 'summary-value positive';
            } else if (deviation > 0) {
                recommendationEl.textContent = '‚ö†Ô∏è –ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞';
                recommendationEl.className = 'summary-value negative';
            } else {
                recommendationEl.textContent = 'üí∞ –ù–µ–¥–æ–æ—Ü–µ–Ω–∫–∞';
                recommendationEl.className = 'summary-value positive';
            }

            // Market stats
            const stats = analysisResult.market_statistics;
            document.getElementById('marketMedian').textContent = formatPrice(stats.median_price_per_sqm) + '/–º¬≤';
            document.getElementById('marketMin').textContent = formatPrice(stats.min_price_per_sqm) + '/–º¬≤';
            document.getElementById('marketMax').textContent = formatPrice(stats.max_price_per_sqm) + '/–º¬≤';
            document.getElementById('marketStd').textContent = formatPrice(stats.std_dev_price_per_sqm);
            document.getElementById('comparablesCount').textContent = stats.total_comparables;
            document.getElementById('filteredCount').textContent = stats.filtered_comparables;
        }

        // Handle form submission
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Show loading
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('resultsContainer').style.display = 'none';

            // Gather form data
            const formData = {
                target_property: {
                    price_per_sqm: parseFloat(document.getElementById('targetPrice').value),
                    total_area: parseFloat(document.getElementById('targetArea').value),
                    living_area: parseFloat(document.getElementById('targetLivingArea').value),
                    floor: parseInt(document.getElementById('targetFloor').value),
                    total_floors: parseInt(document.getElementById('targetTotalFloors').value),
                    rooms: parseInt(document.getElementById('targetRooms').value),
                    repair_level: document.getElementById('repairLevel').value,
                    view_type: document.getElementById('viewType').value
                },
                comparables: generateMockComparables(parseInt(document.getElementById('comparablesCount').value)),
                filter_outliers: document.getElementById('filterOutliers').checked,
                use_median: document.getElementById('useMedian').checked
            };

            try {
                const response = await fetch('/api/v2/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Hide loading
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';

                // Render all components
                renderRecommendations(result.recommendations);
                renderWaterfallChart(result.waterfall_chart_data);
                updateSummary(result);
                renderScenarios(result.selling_scenarios);

                // Scroll to results
                document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loadingState').style.display = 'none';
                alert('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
            }
        });

        // Generate mock comparables for demo
        function generateMockComparables(count) {
            const comparables = [];
            const basePrice = 180000;

            for (let i = 0; i < count; i++) {
                const variation = (Math.random() - 0.5) * 0.3; // ¬±15%
                const price = basePrice * (1 + variation);

                const repairLevels = ['—á–µ—Ä–Ω–æ–≤–∞—è', '—ç–∫–æ–Ω–æ–º', '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è', '–∫–∞–ø–∏—Ç–∞–ª—å–Ω–∞—è', '—É–ª—É—á—à–µ–Ω–Ω–∞—è', '–ø—Ä–µ–º–∏—É–º', '–ª—é–∫—Å', '–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è'];
                const viewTypes = ['—Ö—É–¥–æ–≥–æ–≤', '–¥–æ–º', '—É–ª–∏—Ü–∞', '–ø–∞—Ä–∫', '–≥–æ—Ä–æ–¥', '–≤–æ–¥–∞', '–∑–∞–∫–∞—Ç', '–ø—Ä–µ–º–∏—É–º'];

                comparables.push({
                    price_per_sqm: Math.round(price),
                    total_area: 45 + Math.random() * 20,
                    living_area: 25 + Math.random() * 15,
                    floor: Math.floor(Math.random() * 10) + 1,
                    total_floors: Math.floor(Math.random() * 15) + 5,
                    rooms: Math.floor(Math.random() * 3) + 1,
                    repair_level: repairLevels[Math.floor(Math.random() * repairLevels.length)],
                    view_type: viewTypes[Math.floor(Math.random() * viewTypes.length)],
                    building_age_years: Math.floor(Math.random() * 30),
                    distance_to_center_km: 5 + Math.random() * 15
                });
            }

            return comparables;
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            checkHealth();

            // Set up periodic health checks
            setInterval(checkHealth, 30000); // Every 30 seconds
        });
    </script>
</body>
</html>
