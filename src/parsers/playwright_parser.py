"""
–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π Playwright –ø–∞—Ä—Å–µ—Ä —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±—Ä–∞—É–∑–µ—Ä–∞
"""

import time
import logging
from typing import Optional, List, Dict, Callable, Any
from functools import wraps
from playwright.sync_api import sync_playwright, Page, Browser, BrowserContext
from bs4 import BeautifulSoup

from .base_parser import BaseCianParser

logger = logging.getLogger(__name__)


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ò–ú–ü–û–†–¢ –í–ê–õ–ò–î–ê–¢–û–†–ê
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

try:
    from ..analytics.data_validator import validate_comparable
    from ..models.property import ComparableProperty
    from pydantic import ValidationError
    VALIDATION_AVAILABLE = True
except ImportError:
    VALIDATION_AVAILABLE = False
    logger.warning("‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞")


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤ –¶–ò–ê–ù –Ω–∞ –∫–æ–¥—ã —Ä–µ–≥–∏–æ–Ω–æ–≤ (–¥–ª—è detect_region_from_url)
SUBDOMAIN_TO_REGION = {
    # –û—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
    'spb': 'spb', 'piter': 'spb', 'saint-petersburg': 'spb',
    'msk': 'msk', 'moskva': 'msk', 'moscow': 'msk',
    # –û–±–ª–∞—Å—Ç–∏
    'mo': 'mo', 'moskovskaya-oblast': 'mo',
    'lo': 'lo', 'leningradskaya-oblast': 'lo',
    # –ì–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ –∏ –∫—Ä—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
    'ekaterinburg': 'sverdlovsk', 'ekb': 'sverdlovsk',
    'novosibirsk': 'novosibirsk', 'nsk': 'novosibirsk',
    'kazan': 'tatarstan', 'tatarstan': 'tatarstan',
    'nizhniy-novgorod': 'nizhniy-novgorod', 'nn': 'nizhniy-novgorod',
    'krasnodar': 'krasnodar', 'sochi': 'krasnodar',
    'rostov': 'rostov', 'rostov-na-donu': 'rostov',
    'samara': 'samara',
    'chelyabinsk': 'chelyabinsk',
    'voronezh': 'voronezh',
    'omsk': 'omsk',
    'krasnoyarsk': 'krasnoyarsk',
    # –¢—É–ª–∞ –∏ –¥—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã
    'tula': 'tula',
    'tver': 'tver',
    'kaliningrad': 'kaliningrad',
    'tyumen': 'tyumen',
    'irkutsk': 'irkutsk',
    'perm': 'perm',
    'ufa': 'bashkortostan', 'bashkortostan': 'bashkortostan',
    'vladivostok': 'primorye', 'primorye': 'primorye',
    'khabarovsk': 'khabarovsk',
    'yaroslavl': 'yaroslavl',
    'ryazan': 'ryazan',
    'lipetsk': 'lipetsk',
    'ivanovo': 'ivanovo',
    'vladimir': 'vladimir',
    'bryansk': 'bryansk',
    'orel': 'orel',
    'kursk': 'kursk',
    'belgorod': 'belgorod',
    'tambov': 'tambov',
    'saratov': 'saratov',
    'penza': 'penza',
    'volgograd': 'volgograd',
    'astrakhan': 'astrakhan',
    'kaluga': 'kaluga',
    'smolensk': 'smolensk',
    'pskov': 'pskov',
    'novgorod': 'novgorod',
    'vologda': 'vologda',
    'arkhangelsk': 'arkhangelsk',
    'murmansk': 'murmansk',
    'karelia': 'karelia',
    'crimea': 'crimea', 'krym': 'crimea', 'simferopol': 'crimea',
    'sevastopol': 'sevastopol',
    'komi': 'komi',
    'kirov': 'kirov',
    'kostroma': 'kostroma',
    'tomsk': 'tomsk',
    'kemerovo': 'kemerovo',
    'ulyanovsk': 'ulyanovsk',
    'orenburg': 'orenburg',
    'kurgan': 'kurgan',
    'magadan': 'magadan',
    'sakhalin': 'sakhalin',
    'amur': 'amur',
}


def detect_region_from_url(url: str) -> str:
    """
    –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ URL –æ–±—ä–µ–∫—Ç–∞.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–¥–¥–æ–º–µ–Ω—ã –¶–ò–ê–ù.

    Args:
        url: URL –æ–±—ä—è–≤–ª–µ–Ω–∏—è

    Returns:
        –ö–ª—é—á —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 'msk', 'spb', 'tula') –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
    """
    if not url:
        return None

    url_lower = url.lower()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–¥–¥–æ–º–µ–Ω –∏–∑ URL
    # –§–æ—Ä–º–∞—Ç: https://tula.cian.ru/... -> tula
    import re
    subdomain_match = re.search(r'https?://([a-z0-9-]+)\.cian\.ru', url_lower)

    if subdomain_match:
        subdomain = subdomain_match.group(1)

        # www.cian.ru = –ú–æ—Å–∫–≤–∞ (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω)
        if subdomain == 'www':
            logger.info(f"‚úì URL www.cian.ru –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –ú–û–°–ö–í–ê (–¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω)")
            return 'msk'

        # –ò—â–µ–º –ø–æ–¥–¥–æ–º–µ–Ω –≤ –º–∞–ø–ø–∏–Ω–≥–µ
        if subdomain in SUBDOMAIN_TO_REGION:
            region = SUBDOMAIN_TO_REGION[subdomain]
            logger.info(f"‚úì –†–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ –ø–æ–¥–¥–æ–º–µ–Ω—É: {subdomain} -> {region}")
            return region

        # –ï—Å–ª–∏ –ø–æ–¥–¥–æ–º–µ–Ω –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω)
        logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–¥–¥–æ–º–µ–Ω: {subdomain}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –∫–ª—é—á —Ä–µ–≥–∏–æ–Ω–∞")
        return subdomain

    # cian.ru –±–µ–∑ –ø–æ–¥–¥–æ–º–µ–Ω–∞ = –ú–æ—Å–∫–≤–∞
    if 'cian.ru' in url_lower:
        logger.info(f"‚úì URL cian.ru –±–µ–∑ –ø–æ–¥–¥–æ–º–µ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –ú–û–°–ö–í–ê")
        return 'msk'

    # –†–µ–∑–µ—Ä–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ URL
    if any(word in url_lower for word in ['sankt-peterburg', 'saint-petersburg', '/spb/']):
        return 'spb'
    if any(word in url_lower for word in ['moskva', 'moscow', '/msk/']):
        return 'msk'

    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω –ø–æ URL: {url}")
    return None


# –ú–∞–ø–ø–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –∞–¥—Ä–µ—Å–µ –Ω–∞ —Ä–µ–≥–∏–æ–Ω—ã
ADDRESS_KEYWORDS_TO_REGION = {
    # –ú–æ—Å–∫–≤–∞ –∏ –ú–û
    'msk': ['–º–æ—Å–∫–≤–∞', 'moscow', '–≥ –º–æ—Å–∫–≤–∞', '–≥.–º–æ—Å–∫–≤–∞'],
    'mo': ['–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª', '–º–æ,'],
    # –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –∏ –õ–û
    'spb': ['—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '—Å–ø–±', '—Å-–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '—Å.–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '–ø–∏—Ç–µ—Ä', 'saint-petersburg'],
    'lo': ['–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å', '–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª', '–ª–æ,'],
    # –ì–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏
    'novosibirsk': ['–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è'],
    'sverdlovsk': ['–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '—Å–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è'],
    'tatarstan': ['–∫–∞–∑–∞–Ω—å', '—Ç–∞—Ç–∞—Ä—Å—Ç–∞–Ω', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ —Ç–∞—Ç–∞—Ä—Å—Ç–∞–Ω'],
    'nizhniy-novgorod': ['–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥', '–Ω–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è'],
    'chelyabinsk': ['—á–µ–ª—è–±–∏–Ω—Å–∫', '—á–µ–ª—è–±–∏–Ω—Å–∫–∞—è'],
    'omsk': ['–æ–º—Å–∫', '–æ–º—Å–∫–∞—è'],
    'samara': ['—Å–∞–º–∞—Ä–∞', '—Å–∞–º–∞—Ä—Å–∫–∞—è'],
    'rostov': ['—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É', '—Ä–æ—Å—Ç–æ–≤ –Ω–∞ –¥–æ–Ω—É', '—Ä–æ—Å—Ç–æ–≤—Å–∫–∞—è'],
    'bashkortostan': ['—É—Ñ–∞', '–±–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –±–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω'],
    'krasnoyarsk': ['–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∞—è'],
    'perm': ['–ø–µ—Ä–º—å', '–ø–µ—Ä–º—Å–∫–∞—è', '–ø–µ—Ä–º—Å–∫–∏–π'],
    'voronezh': ['–≤–æ—Ä–æ–Ω–µ–∂', '–≤–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è'],
    'volgograd': ['–≤–æ–ª–≥–æ–≥—Ä–∞–¥', '–≤–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è'],
    'krasnodar': ['–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä', '—Å–æ—á–∏', '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π'],
    # –û–±–ª–∞—Å—Ç–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã
    'tula': ['—Ç—É–ª–∞', '—Ç—É–ª—å—Å–∫–∞—è'],
    'tver': ['—Ç–≤–µ—Ä—å', '—Ç–≤–µ—Ä—Å–∫–∞—è'],
    'kaluga': ['–∫–∞–ª—É–≥–∞', '–∫–∞–ª—É–∂—Å–∫–∞—è'],
    'ryazan': ['—Ä—è–∑–∞–Ω—å', '—Ä—è–∑–∞–Ω—Å–∫–∞—è'],
    'vladimir': ['–≤–ª–∞–¥–∏–º–∏—Ä', '–≤–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è'],
    'yaroslavl': ['—è—Ä–æ—Å–ª–∞–≤–ª—å', '—è—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è'],
    'ivanovo': ['–∏–≤–∞–Ω–æ–≤–æ', '–∏–≤–∞–Ω–æ–≤—Å–∫–∞—è'],
    'kostroma': ['–∫–æ—Å—Ç—Ä–æ–º–∞', '–∫–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è'],
    'bryansk': ['–±—Ä—è–Ω—Å–∫', '–±—Ä—è–Ω—Å–∫–∞—è'],
    'orel': ['–æ—Ä—ë–ª', '–æ—Ä–µ–ª', '–æ—Ä–ª–æ–≤—Å–∫–∞—è'],
    'kursk': ['–∫—É—Ä—Å–∫', '–∫—É—Ä—Å–∫–∞—è'],
    'belgorod': ['–±–µ–ª–≥–æ—Ä–æ–¥', '–±–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è'],
    'lipetsk': ['–ª–∏–ø–µ—Ü–∫', '–ª–∏–ø–µ—Ü–∫–∞—è'],
    'tambov': ['—Ç–∞–º–±–æ–≤', '—Ç–∞–º–±–æ–≤—Å–∫–∞—è'],
    'penza': ['–ø–µ–Ω–∑–∞', '–ø–µ–Ω–∑–µ–Ω—Å–∫–∞—è'],
    'saratov': ['—Å–∞—Ä–∞—Ç–æ–≤', '—Å–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è'],
    'ulyanovsk': ['—É–ª—å—è–Ω–æ–≤—Å–∫', '—É–ª—å—è–Ω–æ–≤—Å–∫–∞—è'],
    'orenburg': ['–æ—Ä–µ–Ω–±—É—Ä–≥', '–æ—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è'],
    'tyumen': ['—Ç—é–º–µ–Ω—å', '—Ç—é–º–µ–Ω—Å–∫–∞—è'],
    'tomsk': ['—Ç–æ–º—Å–∫', '—Ç–æ–º—Å–∫–∞—è'],
    'kemerovo': ['–∫–µ–º–µ—Ä–æ–≤–æ', '–∫–µ–º–µ—Ä–æ–≤—Å–∫–∞—è'],
    'irkutsk': ['–∏—Ä–∫—É—Ç—Å–∫', '–∏—Ä–∫—É—Ç—Å–∫–∞—è'],
    'kaliningrad': ['–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è'],
    'arkhangelsk': ['–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫', '–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è'],
    'murmansk': ['–º—É—Ä–º–∞–Ω—Å–∫', '–º—É—Ä–º–∞–Ω—Å–∫–∞—è'],
    'vologda': ['–≤–æ–ª–æ–≥–¥–∞', '–≤–æ–ª–æ–≥–æ–¥—Å–∫–∞—è'],
    'pskov': ['–ø—Å–∫–æ–≤', '–ø—Å–∫–æ–≤—Å–∫–∞—è'],
    'novgorod': ['–≤–µ–ª–∏–∫–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥', '–Ω–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è'],
    'smolensk': ['—Å–º–æ–ª–µ–Ω—Å–∫', '—Å–º–æ–ª–µ–Ω—Å–∫–∞—è'],
    'astrakhan': ['–∞—Å—Ç—Ä–∞—Ö–∞–Ω—å', '–∞—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è'],
    'kurgan': ['–∫—É—Ä–≥–∞–Ω', '–∫—É—Ä–≥–∞–Ω—Å–∫–∞—è'],
    'primorye': ['–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', '–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π'],
    'khabarovsk': ['—Ö–∞–±–∞—Ä–æ–≤—Å–∫', '—Ö–∞–±–∞—Ä–æ–≤—Å–∫–∏–π'],
    'sakhalin': ['—Å–∞—Ö–∞–ª–∏–Ω', '—é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫'],
    'amur': ['–±–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫', '–∞–º—É—Ä—Å–∫–∞—è'],
    'crimea': ['—Å–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å', '–∫—Ä—ã–º', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –∫—Ä—ã–º'],
    'sevastopol': ['—Å–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å'],
    'karelia': ['–ø–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫', '–∫–∞—Ä–µ–ª–∏—è', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –∫–∞—Ä–µ–ª–∏—è'],
    'komi': ['—Å—ã–∫—Ç—ã–≤–∫–∞—Ä', '–∫–æ–º–∏', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –∫–æ–º–∏'],
}


def detect_region_from_address(address: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É –æ–±—ä–µ–∫—Ç–∞.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –†–æ—Å—Å–∏–∏.

    Args:
        address: –ê–¥—Ä–µ—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è

    Returns:
        –ö–ª—é—á —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 'msk', 'spb', 'tula') –∏–ª–∏ None
    """
    if not address:
        return None

    address_lower = address.lower()

    # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
    for region_key, keywords in ADDRESS_KEYWORDS_TO_REGION.items():
        for keyword in keywords:
            if keyword in address_lower:
                logger.info(f"‚úì –†–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: {region_key} (–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: {keyword})")
                return region_key

    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: {address}")
    return None


def retry_with_exponential_backoff(max_retries: int = 3, base_delay: float = 1.0, max_delay: float = 10.0) -> Callable:
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

    Args:
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        base_delay: –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã)
        max_delay: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã)
    """
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        def wrapper(*args: Any, **kwargs: Any) -> Any:
            last_exception = None

            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    last_exception = e

                    if attempt < max_retries - 1:
                        # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1s, 2s, 4s, ...
                        delay = min(base_delay * (2 ** attempt), max_delay)
                        logger.warning(
                            f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å: {e}. "
                            f"–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay:.1f}s..."
                        )
                        time.sleep(delay)
                    else:
                        logger.error(
                            f"–í—Å–µ {max_retries} –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å. "
                            f"–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {e}"
                        )

            # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            raise last_exception

        return wrapper
    return decorator


class PlaywrightParser(BaseCianParser):
    """
    Playwright –ø–∞—Ä—Å–µ—Ä —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±—Ä–∞—É–∑–µ—Ä–∞

    –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø:
    - –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é
    - Context –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    - –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–µ–Ω—É–∂–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–∫–∞—Ä—Ç–∏–Ω–∫–∏, —à—Ä–∏—Ñ—Ç—ã)
    - Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
    """

    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    MIN_HTML_SIZE = 1000  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä HTML (—Å–∏–º–≤–æ–ª–æ–≤)
    MAX_ADDRESS_LENGTH = 200  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∞–¥—Ä–µ—Å–∞ (—Å–∏–º–≤–æ–ª–æ–≤)
    MIN_RESULTS_THRESHOLD = 5  # –ú–∏–Ω–∏–º—É–º –∞–Ω–∞–ª–æ–≥–æ–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è 0
    PREFERRED_RESULTS_THRESHOLD = 10  # –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–æ–≥–æ–≤

    # –°–ª–æ–≤–∞—Ä—å —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ –ú–æ—Å–∫–≤—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏)
    # –§–æ—Ä–º–∞—Ç: '—Å—Ç–∞–Ω—Ü–∏—è': ['—Å–æ—Å–µ–¥–Ω—è—è1', '—Å–æ—Å–µ–¥–Ω—è—è2', ...]
    NEARBY_METRO = {
        # –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è (1)
        '—Å–æ–∫–æ–ª—å–Ω–∏–∫–∏': ['–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è', '–ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å'],
        '–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è': ['—Å–æ–∫–æ–ª—å–Ω–∏–∫–∏', '–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è'],
        '–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è': ['–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è', '–∫—Ä–∞—Å–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞'],
        '–∫—Ä–∞—Å–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞': ['–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è', '—á–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã'],
        '—á–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã': ['–∫—Ä–∞—Å–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞', '–ª—É–±—è–Ω–∫–∞'],
        '–ª—É–±—è–Ω–∫–∞': ['—á–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã', '–æ—Ö–æ—Ç–Ω—ã–π —Ä—è–¥'],
        '–æ—Ö–æ—Ç–Ω—ã–π —Ä—è–¥': ['–ª—É–±—è–Ω–∫–∞', '–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º–µ–Ω–∏ –ª–µ–Ω–∏–Ω–∞'],
        '–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º–µ–Ω–∏ –ª–µ–Ω–∏–Ω–∞': ['–æ—Ö–æ—Ç–Ω—ã–π —Ä—è–¥', '–∫—Ä–æ–ø–æ—Ç–∫–∏–Ω—Å–∫–∞—è'],
        '–∫—Ä–æ–ø–æ—Ç–∫–∏–Ω—Å–∫–∞—è': ['–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º–µ–Ω–∏ –ª–µ–Ω–∏–Ω–∞', '–ø–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã'],
        '–ø–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã': ['–∫—Ä–æ–ø–æ—Ç–∫–∏–Ω—Å–∫–∞—è', '—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è'],
        '—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è': ['–ø–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã', '—Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è'],
        '—Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è': ['—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è', '–≤–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã'],
        '–≤–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã': ['—Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç'],
        '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç': ['–≤–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã', '–ø—Ä–æ—Å–ø–µ–∫—Ç –≤–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ'],
        '–ø—Ä–æ—Å–ø–µ–∫—Ç –≤–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ': ['—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '—é–≥–æ-–∑–∞–ø–∞–¥–Ω–∞—è'],
        '—é–≥–æ-–∑–∞–ø–∞–¥–Ω–∞—è': ['–ø—Ä–æ—Å–ø–µ–∫—Ç –≤–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ', '—Ç—Ä–æ–ø–∞—Ä—ë–≤–æ'],

        # –ó–µ–ª—ë–Ω–∞—è –ª–∏–Ω–∏—è (2)
        '—Ä–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª': ['–≤–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω'],
        '–≤–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω': ['—Ä–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª', '–≤–æ–π–∫–æ–≤—Å–∫–∞—è'],
        '–≤–æ–π–∫–æ–≤—Å–∫–∞—è': ['–≤–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω', '—Å–æ–∫–æ–ª'],
        '—Å–æ–∫–æ–ª': ['–≤–æ–π–∫–æ–≤—Å–∫–∞—è', '–∞—ç—Ä–æ–ø–æ—Ä—Ç'],
        '–∞—ç—Ä–æ–ø–æ—Ä—Ç': ['—Å–æ–∫–æ–ª', '–¥–∏–Ω–∞–º–æ'],
        '–¥–∏–Ω–∞–º–æ': ['–∞—ç—Ä–æ–ø–æ—Ä—Ç', '–±–µ–ª–æ—Ä—É—Å—Å–∫–∞—è'],
        '–±–µ–ª–æ—Ä—É—Å—Å–∫–∞—è': ['–¥–∏–Ω–∞–º–æ', '–º–∞—è–∫–æ–≤—Å–∫–∞—è'],
        '–º–∞—è–∫–æ–≤—Å–∫–∞—è': ['–±–µ–ª–æ—Ä—É—Å—Å–∫–∞—è', '—Ç–≤–µ—Ä—Å–∫–∞—è'],
        '—Ç–≤–µ—Ä—Å–∫–∞—è': ['–º–∞—è–∫–æ–≤—Å–∫–∞—è', '—Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è'],
        '—Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è': ['—Ç–≤–µ—Ä—Å–∫–∞—è', '–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è'],
        '–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è': ['—Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è', '–ø–∞–≤–µ–ª–µ—Ü–∫–∞—è'],
        '–ø–∞–≤–µ–ª–µ—Ü–∫–∞—è': ['–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è', '–∞–≤—Ç–æ–∑–∞–≤–æ–¥—Å–∫–∞—è'],

        # –°–∏–Ω—è—è –ª–∏–Ω–∏—è (3)
        '—â—ë–ª–∫–æ–≤—Å–∫–∞—è': ['–ø–µ—Ä–≤–æ–º–∞–π—Å–∫–∞—è'],
        '–ø–µ—Ä–≤–æ–º–∞–π—Å–∫–∞—è': ['—â—ë–ª–∫–æ–≤—Å–∫–∞—è', '–∏–∑–º–∞–π–ª–æ–≤—Å–∫–∞—è'],
        '–∏–∑–º–∞–π–ª–æ–≤—Å–∫–∞—è': ['–ø–µ—Ä–≤–æ–º–∞–π—Å–∫–∞—è', '–ø–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞—è'],
        '–ø–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞—è': ['–∏–∑–º–∞–π–ª–æ–≤—Å–∫–∞—è', '—Å–µ–º—ë–Ω–æ–≤—Å–∫–∞—è'],
        '—Å–µ–º—ë–Ω–æ–≤—Å–∫–∞—è': ['–ø–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞—è', '—ç–ª–µ–∫—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∞—è'],
        '—ç–ª–µ–∫—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∞—è': ['—Å–µ–º—ë–Ω–æ–≤—Å–∫–∞—è', '–±–∞—É–º–∞–Ω—Å–∫–∞—è'],
        '–±–∞—É–º–∞–Ω—Å–∫–∞—è': ['—ç–ª–µ–∫—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∞—è', '–∫—É—Ä—Å–∫–∞—è'],
        '–∫—É—Ä—Å–∫–∞—è': ['–±–∞—É–º–∞–Ω—Å–∫–∞—è', '–ø–ª–æ—â–∞–¥—å —Ä–µ–≤–æ–ª—é—Ü–∏–∏'],
        '–ø–ª–æ—â–∞–¥—å —Ä–µ–≤–æ–ª—é—Ü–∏–∏': ['–∫—É—Ä—Å–∫–∞—è', '–∞—Ä–±–∞—Ç—Å–∫–∞—è'],
        '–∞—Ä–±–∞—Ç—Å–∫–∞—è': ['–ø–ª–æ—â–∞–¥—å —Ä–µ–≤–æ–ª—é—Ü–∏–∏', '—Å–º–æ–ª–µ–Ω—Å–∫–∞—è'],
        '—Å–º–æ–ª–µ–Ω—Å–∫–∞—è': ['–∞—Ä–±–∞—Ç—Å–∫–∞—è', '–∫–∏–µ–≤—Å–∫–∞—è'],
        '–∫–∏–µ–≤—Å–∫–∞—è': ['—Å–º–æ–ª–µ–Ω—Å–∫–∞—è', '–ø–∞—Ä–∫ –ø–æ–±–µ–¥—ã'],
        '–ø–∞—Ä–∫ –ø–æ–±–µ–¥—ã': ['–∫–∏–µ–≤—Å–∫–∞—è', '—Å–ª–∞–≤—è–Ω—Å–∫–∏–π –±—É–ª—å–≤–∞—Ä'],

        # –ö–æ–ª—å—Ü–µ–≤–∞—è –ª–∏–Ω–∏—è (5)
        '–ø—Ä–æ—Å–ø–µ–∫—Ç –º–∏—Ä–∞': ['–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è', '–Ω–æ–≤–æ—Å–ª–æ–±–æ–¥—Å–∫–∞—è'],
        '–Ω–æ–≤–æ—Å–ª–æ–±–æ–¥—Å–∫–∞—è': ['–ø—Ä–æ—Å–ø–µ–∫—Ç –º–∏—Ä–∞', '–±–µ–ª–æ—Ä—É—Å—Å–∫–∞—è'],
        '–∫—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è': ['–±–µ–ª–æ—Ä—É—Å—Å–∫–∞—è', '–∫–∏–µ–≤—Å–∫–∞—è'],
        '–æ–∫—Ç—è–±—Ä—å—Å–∫–∞—è': ['–ø–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã', '–¥–æ–±—Ä—ã–Ω–∏–Ω—Å–∫–∞—è'],
        '–¥–æ–±—Ä—ã–Ω–∏–Ω—Å–∫–∞—è': ['–æ–∫—Ç—è–±—Ä—å—Å–∫–∞—è', '–ø–∞–≤–µ–ª–µ—Ü–∫–∞—è'],
        '—Ç–∞–≥–∞–Ω—Å–∫–∞—è': ['–ø–∞–≤–µ–ª–µ—Ü–∫–∞—è', '–∫—É—Ä—Å–∫–∞—è'],

        # –û—Ä–∞–Ω–∂–µ–≤–∞—è –ª–∏–Ω–∏—è (6)
        '–º–µ–¥–≤–µ–¥–∫–æ–≤–æ': ['–±–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è'],
        '–±–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è': ['–º–µ–¥–≤–µ–¥–∫–æ–≤–æ', '—Å–≤–∏–±–ª–æ–≤–æ'],
        '—Å–≤–∏–±–ª–æ–≤–æ': ['–±–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è', '–±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥'],
        '–±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥': ['—Å–≤–∏–±–ª–æ–≤–æ', '–≤–¥–Ω—Ö'],
        '–≤–¥–Ω—Ö': ['–±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥', '–∞–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è'],
        '–∞–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è': ['–≤–¥–Ω—Ö', '—Ä–∏–∂—Å–∫–∞—è'],
        '—Ä–∏–∂—Å–∫–∞—è': ['–∞–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è', '–ø—Ä–æ—Å–ø–µ–∫—Ç –º–∏—Ä–∞'],
        '—Å—É—Ö–∞—Ä–µ–≤—Å–∫–∞—è': ['–ø—Ä–æ—Å–ø–µ–∫—Ç –º–∏—Ä–∞', '—Ç—É—Ä–≥–µ–Ω–µ–≤—Å–∫–∞—è'],
        '—Ç—É—Ä–≥–µ–Ω–µ–≤—Å–∫–∞—è': ['—Å—É—Ö–∞—Ä–µ–≤—Å–∫–∞—è', '–∫–∏—Ç–∞–π-–≥–æ—Ä–æ–¥'],
        '–∫–∏—Ç–∞–π-–≥–æ—Ä–æ–¥': ['—Ç—É—Ä–≥–µ–Ω–µ–≤—Å–∫–∞—è', '—Ç—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è'],
        '—Ç—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è': ['–∫–∏—Ç–∞–π-–≥–æ—Ä–æ–¥', '–æ–∫—Ç—è–±—Ä—å—Å–∫–∞—è'],

        # –°–µ—Ä–∞—è –ª–∏–Ω–∏—è (9)
        '–∞–ª—Ç—É—Ñ—å–µ–≤–æ': ['–±–∏–±–∏—Ä–µ–≤–æ'],
        '–±–∏–±–∏—Ä–µ–≤–æ': ['–∞–ª—Ç—É—Ñ—å–µ–≤–æ', '–æ—Ç—Ä–∞–¥–Ω–æ–µ'],
        '–æ—Ç—Ä–∞–¥–Ω–æ–µ': ['–±–∏–±–∏—Ä–µ–≤–æ', '–≤–ª–∞–¥—ã–∫–∏–Ω–æ'],
        '–≤–ª–∞–¥—ã–∫–∏–Ω–æ': ['–æ—Ç—Ä–∞–¥–Ω–æ–µ', '–ø–µ—Ç—Ä–æ–≤—Å–∫–æ-—Ä–∞–∑—É–º–æ–≤—Å–∫–∞—è'],
        '–ø–µ—Ç—Ä–æ–≤—Å–∫–æ-—Ä–∞–∑—É–º–æ–≤—Å–∫–∞—è': ['–≤–ª–∞–¥—ã–∫–∏–Ω–æ', '—Ç–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è'],
        '—Ç–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è': ['–ø–µ—Ç—Ä–æ–≤—Å–∫–æ-—Ä–∞–∑—É–º–æ–≤—Å–∫–∞—è', '–¥–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è'],
        '–¥–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è': ['—Ç–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è', '—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è'],
        '—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è': ['–¥–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è', '–º–µ–Ω–¥–µ–ª–µ–µ–≤—Å–∫–∞—è'],
        '–º–µ–Ω–¥–µ–ª–µ–µ–≤—Å–∫–∞—è': ['—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è', '—Ü–≤–µ—Ç–Ω–æ–π –±—É–ª—å–≤–∞—Ä'],
        '—Ü–≤–µ—Ç–Ω–æ–π –±—É–ª—å–≤–∞—Ä': ['–º–µ–Ω–¥–µ–ª–µ–µ–≤—Å–∫–∞—è', '—á–µ—Ö–æ–≤—Å–∫–∞—è'],
        '—á–µ—Ö–æ–≤—Å–∫–∞—è': ['—Ü–≤–µ—Ç–Ω–æ–π –±—É–ª—å–≤–∞—Ä', '–±–æ—Ä–æ–≤–∏—Ü–∫–∞—è'],
        '–±–æ—Ä–æ–≤–∏—Ü–∫–∞—è': ['—á–µ—Ö–æ–≤—Å–∫–∞—è', '–ø–æ–ª—è–Ω–∫–∞'],
        '–ø–æ–ª—è–Ω–∫–∞': ['–±–æ—Ä–æ–≤–∏—Ü–∫–∞—è', '—Å–µ—Ä–ø—É—Ö–æ–≤—Å–∫–∞—è'],

        # –°–∞–ª–∞—Ç–æ–≤–∞—è –ª–∏–Ω–∏—è (10)
        '–ª—é–±–ª–∏–Ω–æ': ['–±—Ä–∞—Ç–∏—Å–ª–∞–≤—Å–∫–∞—è', '–≤–æ–ª–∂—Å–∫–∞—è'],
        '–±—Ä–∞—Ç–∏—Å–ª–∞–≤—Å–∫–∞—è': ['–ª—é–±–ª–∏–Ω–æ', '–º–∞—Ä—å–∏–Ω–æ'],
        '–º–∞—Ä—å–∏–Ω–æ': ['–±—Ä–∞—Ç–∏—Å–ª–∞–≤—Å–∫–∞—è', '–±–æ—Ä–∏—Å–æ–≤–æ'],
        '–≤–æ–ª–∂—Å–∫–∞—è': ['–ª—é–±–ª–∏–Ω–æ', '–ø–µ—á–∞—Ç–Ω–∏–∫–∏'],
        '–ø–µ—á–∞—Ç–Ω–∏–∫–∏': ['–≤–æ–ª–∂—Å–∫–∞—è', '–∫–æ–∂—É—Ö–æ–≤—Å–∫–∞—è'],
        '–∫–æ–∂—É—Ö–æ–≤—Å–∫–∞—è': ['–ø–µ—á–∞—Ç–Ω–∏–∫–∏', '–¥—É–±—Ä–æ–≤–∫–∞'],
        '–¥—É–±—Ä–æ–≤–∫–∞': ['–∫–æ–∂—É—Ö–æ–≤—Å–∫–∞—è', '–∫—Ä–µ—Å—Ç—å—è–Ω—Å–∫–∞—è –∑–∞—Å—Ç–∞–≤–∞'],

        # –ë–∏—Ä—é–∑–æ–≤–∞—è –ª–∏–Ω–∏—è (11 - –ë–ö–õ) - –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏
        '—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è': ['–º–∞—Ä—å–∏–Ω–∞ —Ä–æ—â–∞', '–ø–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø–∞—Ä–∫'],
        '–º–∞—Ä—å–∏–Ω–∞ —Ä–æ—â–∞': ['—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è', '—Ä–∏–∂—Å–∫–∞—è'],
        '–ø–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø–∞—Ä–∫': ['—Å–∞–≤—ë–ª–æ–≤—Å–∫–∞—è', '—Ü—Å–∫–∞'],
        '—Ü—Å–∫–∞': ['–ø–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø–∞—Ä–∫', '—Ö–æ—Ä–æ—à—ë–≤—Å–∫–∞—è'],
        '—Ö–æ—Ä–æ—à—ë–≤—Å–∫–∞—è': ['—Ü—Å–∫–∞', '—à–µ–ª–µ–ø–∏—Ö–∞'],
        '—à–µ–ª–µ–ø–∏—Ö–∞': ['—Ö–æ—Ä–æ—à—ë–≤—Å–∫–∞—è', '–¥–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä'],
        '–¥–µ–ª–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä': ['—à–µ–ª–µ–ø–∏—Ö–∞', '–º–æ—Å–∫–≤–∞-—Å–∏—Ç–∏'],
    }

    @staticmethod
    def _normalize_rooms(target_rooms) -> int:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ rooms –≤ int

        Args:
            target_rooms: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (str, int –∏–ª–∏ None)

        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (—Å—Ç—É–¥–∏—è ‚Üí 1, '2-–∫–æ–º–Ω' ‚Üí 2, None ‚Üí 0)

        Examples:
            >>> PlaywrightParser._normalize_rooms('—Å—Ç—É–¥–∏—è')
            1
            >>> PlaywrightParser._normalize_rooms('2-–∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞')
            2
            >>> PlaywrightParser._normalize_rooms(3)
            3
            >>> PlaywrightParser._normalize_rooms(None)
            0
        """
        if not target_rooms:
            return 0

        if isinstance(target_rooms, str):
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç—É–¥–∏—é
            if '—Å—Ç—É–¥' in target_rooms.lower():
                return 1

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∏—Å–ª–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏
            import re
            match = re.search(r'\d+', target_rooms)
            return int(match.group()) if match else 0

        # –ï—Å–ª–∏ —É–∂–µ int
        return int(target_rooms)

    @staticmethod
    def _get_room_filter_params(target_rooms: int, strict: bool = True) -> dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–º–Ω–∞—Ç –¥–ª—è –¶–ò–ê–ù API

        Args:
            target_rooms: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
            strict: –ï—Å–ª–∏ True - —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, False - ¬±1 –∫–æ–º–Ω–∞—Ç–∞

        Returns:
            dict: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è URL (–Ω–∞–ø—Ä–∏–º–µ—Ä {'room2': '1', 'room3': '1'})

        Examples:
            >>> PlaywrightParser._get_room_filter_params(3, strict=True)
            {'room3': '1'}
            >>> PlaywrightParser._get_room_filter_params(3, strict=False)
            {'room2': '1', 'room3': '1', 'room4': '1'}
        """
        if target_rooms <= 0:
            target_rooms = 2  # –¥–µ—Ñ–æ–ª—Ç

        if strict:
            return {f'room{target_rooms}': '1'}

        # –ù–µ—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: ¬±1 –∫–æ–º–Ω–∞—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫—Ä–∞–π–Ω–∏—Ö —Å–ª—É—á–∞–µ–≤
        params = {}

        # –°—Ç—É–¥–∏—è (room9 –≤ –¶–ò–ê–ù) –∏–ª–∏ 1-–∫–æ–º–Ω ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç—É–¥–∏–∏ + 1 + 2
        if target_rooms == 1:
            params['room9'] = '1'  # —Å—Ç—É–¥–∏—è –≤ –¶–ò–ê–ù
            params['room1'] = '1'
            params['room2'] = '1'
        # 5+ –∫–æ–º–Ω–∞—Ç ‚Üí 4, 5, 6 (–≤—Å–µ –±–æ–ª—å—à–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å—Ö–æ–∂–∏–π —Å–µ–≥–º–µ–Ω—Ç)
        elif target_rooms >= 5:
            params['room4'] = '1'
            params['room5'] = '1'
            params['room6'] = '1'  # 6+ –≤ –¶–ò–ê–ù
        # 2-4 –∫–æ–º–Ω–∞—Ç—ã ‚Üí ¬±1
        else:
            for r in range(max(1, target_rooms - 1), min(6, target_rooms + 2)):
                params[f'room{r}'] = '1'

        return params

    @classmethod
    def _get_nearby_metros(cls, metro_name: str) -> List[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ

        Args:
            metro_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ

        Returns:
            List[str]: –°–ø–∏—Å–æ–∫ —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π (–≤–∫–ª—é—á–∞—è –∏—Å—Ö–æ–¥–Ω—É—é)

        Example:
            >>> PlaywrightParser._get_nearby_metros('–°–æ–∫–æ–ª—å–Ω–∏–∫–∏')
            ['—Å–æ–∫–æ–ª—å–Ω–∏–∫–∏', '–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è', '–ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å']
        """
        if not metro_name:
            return []

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (lowercase, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã)
        metro_lower = metro_name.lower().strip()

        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ç–∏–ø–∞ "–º. ", "–º–µ—Ç—Ä–æ "
        for prefix in ['–º. ', '–º.', '–º–µ—Ç—Ä–æ ']:
            if metro_lower.startswith(prefix):
                metro_lower = metro_lower[len(prefix):].strip()

        # –ò—â–µ–º –≤ —Å–ª–æ–≤–∞—Ä–µ
        nearby = [metro_lower]  # –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç–∞–Ω—Ü–∏—é

        if metro_lower in cls.NEARBY_METRO:
            nearby.extend(cls.NEARBY_METRO[metro_lower])

        # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ø–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã" vs "–ø–∞—Ä–∫-–∫—É–ª—å—Ç—É—Ä—ã")
        metro_normalized = metro_lower.replace('-', ' ').replace('—ë', '–µ')
        for station, neighbors in cls.NEARBY_METRO.items():
            station_normalized = station.replace('-', ' ').replace('—ë', '–µ')
            if station_normalized == metro_normalized and station != metro_lower:
                nearby.extend(neighbors)
                break

        return list(set(nearby))  # —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã

    def __init__(
        self,
        headless: bool = True,
        delay: float = 2.0,
        block_resources: bool = True,
        cache=None,
        region: str = 'spb',
        browser_pool=None
    ):
        """
        Args:
            headless: –ó–∞–ø—É—Å–∫–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
            delay: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            block_resources: –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏/—à—Ä–∏—Ñ—Ç—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            cache: PropertyCache instance (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            region: –†–µ–≥–∏–æ–Ω –ø–æ–∏—Å–∫–∞ ('spb' –∏–ª–∏ 'msk')
            browser_pool: BrowserPool instance (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)
        """
        super().__init__(delay, cache=cache)
        self.headless = headless
        self.block_resources = block_resources
        self.playwright = None
        self.browser: Optional[Browser] = None
        self.context: Optional[BrowserContext] = None
        self.browser_pool = browser_pool
        self.using_pool = browser_pool is not None

        # –ü–æ–ª–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Ä–µ–≥–∏–æ–Ω–æ–≤ –Ω–∞ –∫–æ–¥—ã –¶–ò–ê–ù (–ø–æ–ª—É—á–µ–Ω–æ –∏–∑ API –¶–ò–ê–ù)
        self.region_codes = {
            # –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
            'msk': '1',           # –ú–æ—Å–∫–≤–∞
            'spb': '2',           # –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥

            # –û–±–ª–∞—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –∫—Ä—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤
            'mo': '4593',         # –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'lo': '4588',         # –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å

            # –†–µ—Å–ø—É–±–ª–∏–∫–∏
            'adygea': '4553',     # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è
            'altai-republic': '4554',  # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π
            'bashkortostan': '4560',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω
            'buryatia': '4563',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë—É—Ä—è—Ç–∏—è
            'dagestan': '4568',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω
            'ingushetia': '4571', # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è
            'kbr': '4573',        # –ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
            'kalmykia': '4575',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è
            'kchr': '4578',       # –ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
            'karelia': '4579',    # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è
            'komi': '4582',       # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏
            'mariy-el': '4591',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–∞—Ä–∏–π –≠–ª
            'mordovia': '4592',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–æ—Ä–¥–æ–≤–∏—è
            'yakutia': '4610',    # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)
            'osetia': '4613',     # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è - –ê–ª–∞–Ω–∏—è
            'tatarstan': '4618',  # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω
            'tyva': '4622',       # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢—ã–≤–∞
            'udmurtia': '4624',   # –£–¥–º—É—Ä—Ç—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
            'khakassia': '4628',  # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –•–∞–∫–∞—Å–∏—è
            'chechnya': '4631',   # –ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
            'chuvashia': '4633',  # –ß—É–≤–∞—à—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
            'crimea': '181462',   # –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö—Ä—ã–º

            # –ö—Ä–∞—è
            'altai': '4555',      # –ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π
            'kamchatka': '4577',  # –ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π
            'krasnodar': '4584',  # –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π
            'krasnoyarsk': '4585', # –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π
            'perm': '4603',       # –ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π
            'primorye': '4604',   # –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π
            'stavropol': '4615',  # –°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π
            'khabarovsk': '4627', # –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π
            'zabaikalye': '187450', # –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π

            # –û–±–ª–∞—Å—Ç–∏
            'amur': '4556',       # –ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'arkhangelsk': '4557', # –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'astrakhan': '4558',  # –ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'belgorod': '4561',   # –ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'bryansk': '4562',    # –ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'vladimir': '4564',   # –í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'volgograd': '4565',  # –í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'vologda': '4566',    # –í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'voronezh': '4567',   # –í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'ivanovo': '4570',    # –ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'irkutsk': '4572',    # –ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kaliningrad': '4574', # –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kaluga': '4576',     # –ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kemerovo': '4580',   # –ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kirov': '4581',      # –ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kostroma': '4583',   # –ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kurgan': '4586',     # –ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'kursk': '4587',      # –ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'lipetsk': '4589',    # –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'magadan': '4590',    # –ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'murmansk': '4594',   # –ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'nizhniy-novgorod': '4596', # –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'novgorod': '4597',   # –ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'novosibirsk': '4598', # –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'omsk': '4599',       # –û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'orenburg': '4600',   # –û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'orel': '4601',       # –û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'penza': '4602',      # –ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'pskov': '4605',      # –ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'rostov': '4606',     # –†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'ryazan': '4607',     # –†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'samara': '4608',     # –°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'saratov': '4609',    # –°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'sakhalin': '4611',   # –°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'sverdlovsk': '4612', # –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'smolensk': '4614',   # –°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'tambov': '4617',     # –¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'tver': '4619',       # –¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'tomsk': '4620',      # –¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'tula': '4621',       # –¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'tyumen': '4623',     # –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'ulyanovsk': '4625',  # –£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'chelyabinsk': '4630', # –ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            'yaroslavl': '4636',  # –Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å

            # –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–µ –æ–∫—Ä—É–≥–∞
            'eao': '4569',        # –ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
            'nao': '4595',        # –ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥
            'khanty-mansiysk': '4629', # –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥
            'chukotka': '4634',   # –ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥
            'yamalo-nenets': '4635', # –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥

            # –ì–æ—Ä–æ–¥ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
            'sevastopol': '184723', # –°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å
        }

        # –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤ –¶–ò–ê–ù –Ω–∞ –∫–ª—é—á–∏ region_codes
        self.subdomain_to_region = {
            'spb': 'spb', 'piter': 'spb', 'saint-petersburg': 'spb',
            'msk': 'msk', 'moskva': 'msk', 'moscow': 'msk',
            'mo': 'mo', 'moskovskaya-oblast': 'mo',
            'lo': 'lo', 'leningradskaya-oblast': 'lo',
            'ekaterinburg': 'sverdlovsk', 'ekb': 'sverdlovsk',
            'novosibirsk': 'novosibirsk', 'nsk': 'novosibirsk',
            'kazan': 'tatarstan', 'tatarstan': 'tatarstan',
            'nizhniy-novgorod': 'nizhniy-novgorod', 'nn': 'nizhniy-novgorod',
            'krasnodar': 'krasnodar', 'sochi': 'krasnodar',
            'rostov': 'rostov', 'rostov-na-donu': 'rostov',
            'samara': 'samara',
            'chelyabinsk': 'chelyabinsk',
            'voronezh': 'voronezh',
            'omsk': 'omsk',
            'krasnoyarsk': 'krasnoyarsk',
            'tula': 'tula',
            'tver': 'tver',
            'kaliningrad': 'kaliningrad',
            'tyumen': 'tyumen',
            'irkutsk': 'irkutsk',
            'perm': 'perm',
            'ufa': 'bashkortostan', 'bashkortostan': 'bashkortostan',
            'vladivostok': 'primorye', 'primorye': 'primorye',
            'khabarovsk': 'khabarovsk',
            'yaroslavl': 'yaroslavl',
            'ryazan': 'ryazan',
            'lipetsk': 'lipetsk',
            'ivanovo': 'ivanovo',
            'vladimir': 'vladimir',
            'bryansk': 'bryansk',
            'orel': 'orel',
            'kursk': 'kursk',
            'belgorod': 'belgorod',
            'tambov': 'tambov',
            'saratov': 'saratov',
            'penza': 'penza',
            'volgograd': 'volgograd',
            'astrakhan': 'astrakhan',
            'kaluga': 'kaluga',
            'smolensk': 'smolensk',
            'pskov': 'pskov',
            'novgorod': 'novgorod',
            'vologda': 'vologda',
            'arkhangelsk': 'arkhangelsk',
            'murmansk': 'murmansk',
            'karelia': 'karelia',
            'crimea': 'crimea', 'krym': 'crimea', 'simferopol': 'crimea',
            'sevastopol': 'sevastopol',
            'komi': 'komi',
            'kirov': 'kirov',
            'kostroma': 'kostroma',
        }

        self.region = region
        self.region_code = self.region_codes.get(region, '1')  # Default: MSK (Moscow)

        logger.info(f"–†–µ–≥–∏–æ–Ω: {region} (–∫–æ–¥: {self.region_code}), using_pool: {self.using_pool}")

    def __enter__(self) -> 'PlaywrightParser':
        """Context manager –≤—Ö–æ–¥"""
        self.start()
        return self

    def __exit__(self, exc_type, exc_val, exc_tb) -> None:
        """Context manager –≤—ã—Ö–æ–¥"""
        self.close()

    def start(self) -> None:
        """–ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ (–æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é) –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –ø—É–ª–∞"""
        if self.browser:
            logger.warning("–ë—Ä–∞—É–∑–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            return

        try:
            # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º browser pool, –ø–æ–ª—É—á–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –∏–∑ –ø—É–ª–∞
            if self.using_pool:
                logger.info("Acquiring browser from pool...")
                self.browser, self.context = self.browser_pool.acquire(timeout=30.0)
                logger.info("‚úì –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–µ–Ω –∏–∑ –ø—É–ª–∞")
                return

            # –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (legacy —Ä–µ–∂–∏–º)
            logger.info("üöÄ –ó–∞–ø—É—Å–∫ Playwright –±—Ä–∞—É–∑–µ—Ä–∞...")
            self.playwright = sync_playwright().start()

            self.browser = self.playwright.chromium.launch(
                headless=self.headless,
                args=[
                    '--disable-blink-features=AutomationControlled',
                    '--disable-dev-shm-usage',
                    '--no-sandbox',
                    '--disable-gpu',
                    '--disable-software-rasterizer',
                ]
            )

            self.context = self.browser.new_context(
                viewport={'width': 1920, 'height': 1080},
                user_agent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                locale='ru-RU',
                timezone_id='Europe/Moscow',
            )

            # –°–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é
            self.context.add_init_script("""
                Object.defineProperty(navigator, 'webdriver', {
                    get: () => undefined
                });
                window.chrome = { runtime: {} };
            """)

            # –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
            if self.block_resources:
                self.context.route(
                    "**/*.{png,jpg,jpeg,gif,svg,webp,woff,woff2,ttf,mp4,mp3,pdf}",
                    lambda route: route.abort()
                )

            logger.info("‚úì –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞: {e}")
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            self.close()
            raise

    def close(self) -> None:
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø—É–ª"""
        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º browser pool, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –≤ –ø—É–ª
        if self.using_pool and self.browser:
            try:
                logger.info("Returning browser to pool...")
                self.browser_pool.release(self.browser)
                self.browser = None
                self.context = None
                logger.info("‚úì Browser returned to pool")
                return
            except Exception as e:
                logger.error(f"Error returning browser to pool: {e}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ–±—ã—á–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º

        # Legacy —Ä–µ–∂–∏–º: –∑–∞–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é
        errors = []

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º context
        if self.context:
            try:
                self.context.close()
            except Exception as e:
                errors.append(f"Context: {e}")
            finally:
                self.context = None

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º browser
        if self.browser:
            try:
                self.browser.close()
            except Exception as e:
                errors.append(f"Browser: {e}")
            finally:
                self.browser = None

        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º playwright
        if self.playwright:
            try:
                self.playwright.stop()
            except Exception as e:
                errors.append(f"Playwright: {e}")
            finally:
                self.playwright = None

        if errors:
            logger.warning(f"–û—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞: {', '.join(errors)}")
        else:
            logger.info("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä—ã—Ç")

    def _get_page_content(self, url: str, max_retries: int = 3) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å HTML –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ Playwright —Å retry –ª–æ–≥–∏–∫–æ–π

        Args:
            url: URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

        Returns:
            HTML –∫–æ–Ω—Ç–µ–Ω—Ç –∏–ª–∏ None

        Raises:
            Exception: –ü–æ—Å–ª–µ max_retries –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        """
        if not self.context:
            raise RuntimeError("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ with context –∏–ª–∏ –≤—ã–∑–æ–≤–∏—Ç–µ .start()")

        last_error = None

        for attempt in range(1, max_retries + 1):
            page: Page = None
            try:
                # PATCH: Rate limiting - —Å–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                if attempt > 1:
                    import random
                    delay = random.uniform(2, 5)  # 2-5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
                    logger.info(f"   ‚è≥ –ó–∞–¥–µ—Ä–∂–∫–∞ {delay:.1f}—Å –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π #{attempt}")
                    time.sleep(delay)

                page = self.context.new_page()

                # PATCH: –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π User-Agent (–∑–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
                import random
                user_agents = [
                    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                ]
                page.set_extra_http_headers({
                    'User-Agent': random.choice(user_agents)
                })

                logger.info(f"–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries}): {url}")

                # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                page.goto(url, wait_until='domcontentloaded', timeout=30000)

                # –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                try:
                    page.wait_for_selector(
                        'h1, [data-mark="OfferTitle"], script[type="application/ld+json"]',
                        timeout=10000
                    )
                except Exception as e:
                    logger.warning(f"–°–µ–ª–µ–∫—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º: {e}")

                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                time.sleep(1)

                html = page.content()

                if not html or len(html) < self.MIN_HTML_SIZE:
                    raise ValueError(f"–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π HTML ({len(html) if html else 0} —Å–∏–º–≤–æ–ª–æ–≤)")

                logger.info(f"‚úì –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ({len(html)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return html

            except Exception as e:
                last_error = e
                logger.warning(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")

                # –ï—Å–ª–∏ —ç—Ç–æ –∫–∞–ø—á–∞ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
                if 'captcha' in str(e).lower() or '403' in str(e) or '429' in str(e):
                    logger.warning(f"   üö´ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–∫–∞–ø—á–∞, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É")
                    if attempt < max_retries:
                        time.sleep(10)  # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º

                if attempt == max_retries:
                    logger.error(f"‚ùå –í—Å–µ {max_retries} –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è {url}")
                    raise last_error

            finally:
                if page:
                    page.close()

        # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        if last_error:
            raise last_error
        return None

    def parse_search_page(self, url: str) -> List[Dict]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏

        Args:
            url: URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∏—Å–∫–∞

        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        """
        logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∏—Å–∫–∞: {url}")

        html = self._get_page_content(url)
        if not html:
            logger.warning("‚ö†Ô∏è DEBUG: _get_page_content –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π HTML")
            return []

        soup = BeautifulSoup(html, 'lxml')

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
        from .adaptive_selectors import AdaptiveSelector, CARD_SELECTORS

        selector = AdaptiveSelector(soup)
        cards = selector.find_elements(CARD_SELECTORS, "–∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π")

        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(cards)} –∫–∞—Ä—Ç–æ—á–µ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")

        if len(cards) == 0:
            logger.warning("‚ö†Ô∏è DEBUG: –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è")
            logger.warning(f"‚ö†Ô∏è DEBUG: –†–∞–∑–º–µ—Ä HTML: {len(html)} –±–∞–π—Ç")
            # –°–æ—Ö—Ä–∞–Ω–∏–º –ø–µ—Ä–≤—ã–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤ HTML –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            logger.debug(f"‚ö†Ô∏è DEBUG: –ù–∞—á–∞–ª–æ HTML: {html[:2000]}")

        listings = []
        for i, card in enumerate(cards):
            try:
                listing_data = self._parse_listing_card(card)
                if listing_data.get('title'):
                    listings.append(listing_data)
                    if i < 3:  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 3 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        logger.debug(f"‚úì –ö–∞—Ä—Ç–æ—á–∫–∞ {i+1} —Å–ø–∞—Ä—Å–µ–Ω–∞: {listing_data.get('title', '')[:80]}")
                else:
                    logger.debug(f"‚úó –ö–∞—Ä—Ç–æ—á–∫–∞ {i+1}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç title, –ø—Ä–æ–ø—É—â–µ–Ω–∞")
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∫–∞—Ä—Ç–æ—á–∫–∏ {i+1}: {e}")
                continue

        logger.info(f"‚úì –£—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω–æ {len(listings)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏–∑ {len(cards)} –∫–∞—Ä—Ç–æ—á–µ–∫")

        # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—Å–ø–µ—à–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
        stats = selector.get_stats()
        if stats:
            logger.debug(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤: {stats}")

        return listings

    def _parse_listing_card(self, card: BeautifulSoup) -> Dict:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏

        Args:
            card: BeautifulSoup –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç–æ—á–∫–∏

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        """
        from .adaptive_selectors import (
            AdaptiveSelector, TITLE_SELECTORS, PRICE_SELECTORS,
            ADDRESS_SELECTORS, AREA_SELECTORS, METRO_SELECTORS,
            extract_rooms_from_text, extract_floor_from_text
        )

        data = {
            'title': None,
            'price': None,
            'price_per_sqm': None,  # –¶–µ–Ω–∞ –∑–∞ –∫–≤.–º
            'price_raw': None,  # –¶–µ–Ω–∞ –≤ —á–∏—Å–ª–æ–≤–æ–º –≤–∏–¥–µ
            'address': None,
            'metro': None,
            'area': None,
            'area_value': None,  # –ü–ª–æ—â–∞–¥—å –≤ —á–∏—Å–ª–æ–≤–æ–º –≤–∏–¥–µ
            'rooms': None,
            'floor': None,
            'renovation': None,  # –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            'url': None,
            'image_url': None,
        }

        # –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
        selector = AdaptiveSelector(BeautifulSoup(str(card), 'lxml'))

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        data['title'] = selector.extract_text(TITLE_SELECTORS, "–∑–∞–≥–æ–ª–æ–≤–æ–∫")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if data['title']:
            data['rooms'] = extract_rooms_from_text(data['title'])

        # –¶–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        price_elem = selector.find_element(PRICE_SELECTORS, "—Ü–µ–Ω–∞")
        if price_elem:
            price_text = price_elem.get_text(strip=True)
            data['price'] = price_text

            # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
            import re
            price_numbers = re.sub(r'[^\d]', '', price_text)
            if price_numbers:
                data['price_raw'] = int(price_numbers)

        # –ê–¥—Ä–µ—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ GeoLabel
        geo_labels = card.find_all('a', {'data-name': 'GeoLabel'})
        if geo_labels:
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞
            address_parts = [label.get_text(strip=True) for label in geo_labels]
            # –°–æ–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –ø—Ä–æ–ø—É—Å–∫–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã
            unique_parts = []
            for part in address_parts:
                if part not in unique_parts:
                    unique_parts.append(part)
            data['address'] = ', '.join(unique_parts)

        # –ï—Å–ª–∏ GeoLabel –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        if not data['address']:
            data['address'] = selector.extract_text(ADDRESS_SELECTORS, "–∞–¥—Ä–µ—Å")

        # –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç —Å –≥–æ—Ä–æ–¥–æ–º
        if not data['address']:
            # –ò—â–µ–º div/span —Å —Ç–µ–∫—Å—Ç–æ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" –∏–ª–∏ "–ú–æ—Å–∫–≤–∞"
            for elem in card.find_all(['div', 'span', 'a']):
                text = elem.get_text(strip=True)
                if '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥' in text or '–ú–æ—Å–∫–≤–∞' in text:
                    if len(text) < self.MAX_ADDRESS_LENGTH:  # –ù–µ –±–µ—Ä–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
                        data['address'] = text
                        break

        # –ú–µ—Ç—Ä–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        metro_elem = selector.find_element(METRO_SELECTORS, "–º–µ—Ç—Ä–æ")
        if metro_elem:
            data['metro'] = metro_elem.get_text(strip=True)

        # –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ (–ü–†–ò–û–†–ò–¢–ï–¢ - –∑–¥–µ—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ø–ª–æ—â–∞–¥—å!)
        # –§–æ—Ä–º–∞—Ç: "2-–∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞, 85 –º¬≤, 4/9 —ç—Ç–∞–∂"
        subtitle_elem = card.find('span', {'data-mark': 'OfferSubtitle'})
        if subtitle_elem:
            subtitle_text = subtitle_elem.get_text(strip=True)
            import re

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–ª–æ—â–∞–¥—å (85 –º¬≤)
            area_match = re.search(r'([\d,\.]+)\s*–º¬≤', subtitle_text)
            if area_match:
                data['area'] = area_match.group(0)  # "85 –º¬≤"
                area_str = area_match.group(1).replace(',', '.')
                try:
                    data['area_value'] = float(area_str)
                except ValueError:
                    pass

            # –ò–∑–≤–ª–µ–∫–∞–µ–º —ç—Ç–∞–∂ –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
            if not data.get('floor'):
                data['floor'] = extract_floor_from_text(subtitle_text)

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (2-–∫–æ–º–Ω.)
            if not data['rooms']:  # –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∏–∑–≤–ª–µ–∫–ª–∏ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                data['rooms'] = extract_rooms_from_text(subtitle_text)

        # –ï—Å–ª–∏ –ø–ª–æ—â–∞–¥—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        if not data['area_value']:
            area_elem = selector.find_element(AREA_SELECTORS, "–ø–ª–æ—â–∞–¥—å")
            if area_elem:
                area_text = area_elem.get_text(strip=True)
                area_match = re.search(r'([\d,\.]+)\s*–º¬≤', area_text)
                if area_match:
                    data['area'] = area_match.group(0)
                    area_str = area_match.group(1).replace(',', '.')
                    try:
                        data['area_value'] = float(area_str)
                    except ValueError:
                        pass

        # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (FALLBACK - –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–µ)
        characteristics = card.find_all('span', {'data-mark': 'OfferCharacteristics'})
        for char in characteristics:
            text = char.get_text(strip=True)
            if '–º¬≤' in text and not data['area_value']:
                data['area'] = text
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏
                area_match = re.search(r'([\d,\.]+)\s*–º¬≤', text)
                if area_match:
                    area_str = area_match.group(1).replace(',', '.')
                    try:
                        data['area_value'] = float(area_str)
                    except ValueError:
                        pass
            elif '—ç—Ç–∞–∂' in text.lower() and not data['floor']:
                floor_extracted = extract_floor_from_text(text)
                if floor_extracted:
                    data['floor'] = floor_extracted
            elif '—Ä–µ–º–æ–Ω—Ç' in text.lower() or '–æ—Ç–¥–µ–ª–∫' in text.lower():
                data['renovation'] = text

        # –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—É –∑–∞ –∫–≤.–º –µ—Å–ª–∏ –µ—Å—Ç—å —Ü–µ–Ω–∞ –∏ –ø–ª–æ—â–∞–¥—å
        if data['price_raw'] and data['area_value']:
            data['price_per_sqm'] = round(data['price_raw'] / data['area_value'])

        # –°—Å—ã–ª–∫–∞ - –ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        link_elem = (
            card.find('a', {'data-mark': 'OfferTitle'}) or
            card.find('a', {'data-name': 'LinkArea'}) or
            card.find('a', href=lambda x: x and '/sale/flat/' in str(x))
        )
        if link_elem and link_elem.get('href'):
            href = link_elem['href']
            data['url'] = self.base_url + href if not href.startswith('http') else href

        # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img_elem = card.find('img', {'data-mark': 'OfferPreviewImage'})
        if img_elem:
            data['image_url'] = img_elem.get('src') or img_elem.get('data-src')

        return data

    def _validate_and_prepare_results(
        self,
        results: List[Dict],
        limit: int,
        enable_validation: bool = True,
        target_property: Dict = None,
        relaxed_filters: bool = False
    ) -> List[Dict]:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º

        Args:
            results: –°–ø–∏—Å–æ–∫ —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            enable_validation: –í–∫–ª—é—á–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
            target_property: –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—É–º–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–æ–≥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            relaxed_filters: –û—Å–ª–∞–±–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (–¥–ª—è –ñ–ö –≥–¥–µ —Ü–µ–Ω–∞/–º¬≤ –≤–∞–∂–Ω–µ–µ –ø–ª–æ—â–∞–¥–∏)

        Returns:
            –°–ø–∏—Å–æ–∫ –≤–∞–ª–∏–¥–Ω—ã—Ö –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        """
        if not results:
            logger.info("‚ö†Ô∏è DEBUG: _validate_and_prepare_results –ø–æ–ª—É—á–∏–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
            return []

        logger.info(f"üîç DEBUG: –ù–∞—á–∏–Ω–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (enable_validation={enable_validation})")

        # –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –¥–ª—è Pydantic –º–æ–¥–µ–ª–µ–π
        for result in results:
            if 'area_value' in result and result['area_value']:
                result['total_area'] = result['area_value']
            if 'price_raw' in result and result['price_raw']:
                result['price'] = result['price_raw']
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º rooms –≤ int –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å —Ü–∏—Ñ—Ä–æ–π
            if 'rooms' in result and isinstance(result['rooms'], str) and result['rooms'].isdigit():
                result['rooms'] = int(result['rooms'])

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –î–û–†–ê–ë–û–¢–ö–ê #1: –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –†–ï–ì–ò–û–ù–£ (–ö–†–ò–¢–ò–ß–ù–û: –ø–æ –∞–¥—Ä–µ—Å—É, –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ URL!)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        region_filtered = []
        region_excluded = 0
        for result in results:
            result_url = result.get('url', '')
            result_address = result.get('address', '')

            # –ü–†–ò–û–†–ò–¢–ï–¢ 1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω –ø–æ –∞–¥—Ä–µ—Å—É
            result_region = detect_region_from_address(result_address)

            # –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ –∞–¥—Ä–µ—Å—É - –ø—Ä–æ–±—É–µ–º –ø–æ URL
            if not result_region:
                result_region = detect_region_from_url(result_url)

            # –ï—Å–ª–∏ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            if result_region:
                if result_region == self.region:
                    region_filtered.append(result)
                else:
                    region_excluded += 1
                    logger.warning(
                        f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω –∞–Ω–∞–ª–æ–≥ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞: "
                        f"{result_region} (–æ–∂–∏–¥–∞–ª—Å—è {self.region}), "
                        f"–∞–¥—Ä–µ—Å: {result_address[:80] if result_address else '–Ω–µ —É–∫–∞–∑–∞–Ω'}"
                    )
            else:
                # –ö–†–ò–¢–ò–ß–ù–û: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω - –ò–°–ö–õ–Æ–ß–ê–ï–ú –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ –æ—Ç—á–µ—Ç
                region_excluded += 1
                logger.warning(
                    f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω –∞–Ω–∞–ª–æ–≥ —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ä–µ–≥–∏–æ–Ω–æ–º, "
                    f"URL: {result_url[:80] if result_url else '–Ω–µ —É–∫–∞–∑–∞–Ω'}, "
                    f"–∞–¥—Ä–µ—Å: {result_address[:80] if result_address else '–Ω–µ —É–∫–∞–∑–∞–Ω'}"
                )

        if region_excluded > 0:
            logger.info(f"üìä –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É: {len(results)} ‚Üí {len(region_filtered)} (–∏—Å–∫–ª—é—á–µ–Ω–æ {region_excluded} –∏–∑ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤)")

        results = region_filtered

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –î–û–†–ê–ë–û–¢–ö–ê #3: –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ê–ó–£–ú–ù–û–°–¢–ò –ê–ù–ê–õ–û–ì–û–í
        # –£–õ–£–ß–®–ï–ù–ò–ï: relaxed_filters –¥–ª—è –ñ–ö (—Ü–µ–Ω–∞/–º¬≤ –≤–∞–∂–Ω–µ–µ –ø–ª–æ—â–∞–¥–∏)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if target_property:
            target_price = target_property.get('price', 0)
            target_area = target_property.get('total_area', 0)

            # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if relaxed_filters:
                # –î–ª—è –ñ–ö: –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Ü–µ–Ω–∞/–º¬≤ –≤–∞–∂–Ω–µ–µ)
                price_ratio_threshold = 5.0      # –±—ã–ª–æ 3.0
                area_ratio_threshold = 3.0       # –±—ã–ª–æ 1.5 (–¥–ª—è –ñ–ö –Ω–µ —Ç–∞–∫ –≤–∞–∂–Ω–æ)
                price_sqm_threshold = 0.40       # –±—ã–ª–æ 0.30
                logger.info(f"   üìä –†–µ–∂–∏–º: –û–°–õ–ê–ë–õ–ï–ù–ù–´–ï —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ñ–ö (–ø–ª–æ—â–∞–¥—å ¬±{area_ratio_threshold}x, —Ü–µ–Ω–∞/–º¬≤ ¬±{int(price_sqm_threshold*100)}%)")
            else:
                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
                price_ratio_threshold = 3.0
                area_ratio_threshold = 1.5
                price_sqm_threshold = 0.30

            if target_price > 0 and target_area > 0:
                reasonable = []
                unreasonable_count = 0

                for result in results:
                    comp_price = result.get('price') or result.get('price_raw') or 0
                    comp_area = result.get('total_area') or result.get('area_value') or 0

                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    if not comp_price or not comp_area:
                        reasonable.append(result)
                        continue

                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –¶–µ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ
                    price_ratio = max(comp_price, target_price) / min(comp_price, target_price)
                    if price_ratio > price_ratio_threshold:
                        unreasonable_count += 1
                        logger.warning(
                            f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω –Ω–µ—Ä–∞–∑—É–º–Ω—ã–π –∞–Ω–∞–ª–æ–≥: —Ü–µ–Ω–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤ {price_ratio:.1f} —Ä–∞–∑ "
                            f"(–∞–Ω–∞–ª–æ–≥ {comp_price:,} ‚ÇΩ vs —Ü–µ–ª–µ–≤–æ–π {target_price:,} ‚ÇΩ), "
                            f"URL: {result.get('url', '')[:60]}..."
                        )
                        continue

                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ü–ª–æ—â–∞–¥—å (–¥–ª—è –ñ–ö - –æ—Å–ª–∞–±–ª–µ–Ω–Ω–∞—è)
                    area_ratio = max(comp_area, target_area) / min(comp_area, target_area)
                    if area_ratio > area_ratio_threshold:
                        unreasonable_count += 1
                        logger.warning(
                            f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω –Ω–µ—Ä–∞–∑—É–º–Ω—ã–π –∞–Ω–∞–ª–æ–≥: –ø–ª–æ—â–∞–¥—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤ {area_ratio:.1f} —Ä–∞–∑ "
                            f"(–∞–Ω–∞–ª–æ–≥ {comp_area} –º¬≤ vs —Ü–µ–ª–µ–≤–æ–π {target_area} –º¬≤), "
                            f"URL: {result.get('url', '')[:60]}..."
                        )
                        continue

                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –¶–µ–Ω–∞ –∑–∞ –º¬≤ (–≥–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –ñ–ö)
                    target_price_per_sqm = target_price / target_area
                    comp_price_per_sqm = comp_price / comp_area
                    price_per_sqm_diff = abs(comp_price_per_sqm - target_price_per_sqm) / target_price_per_sqm

                    if price_per_sqm_diff > price_sqm_threshold:
                        unreasonable_count += 1
                        logger.warning(
                            f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω –ø–æ —Ü–µ–Ω–µ/–º¬≤: –æ—Ç–ª–∏—á–∏–µ {price_per_sqm_diff*100:.0f}% "
                            f"(–∞–Ω–∞–ª–æ–≥ {comp_price_per_sqm:,.0f} ‚ÇΩ/–º¬≤ vs —Ü–µ–ª–µ–≤–æ–π {target_price_per_sqm:,.0f} ‚ÇΩ/–º¬≤), "
                            f"–∞–¥—Ä–µ—Å: {result.get('address', '')[:50]}"
                        )
                        continue

                    reasonable.append(result)

                if unreasonable_count > 0:
                    logger.info(
                        f"üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—É–º–Ω–æ—Å—Ç–∏: {len(results)} ‚Üí {len(reasonable)} "
                        f"(–∏—Å–∫–ª—é—á–µ–Ω–æ {unreasonable_count} –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã—Ö)"
                    )

                results = reasonable

        # –í–∞–ª–∏–¥–∞—Ü–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
        if enable_validation and VALIDATION_AVAILABLE:
            validated = []
            excluded_count = 0

            for i, result in enumerate(results):
                try:
                    # –°–æ–∑–¥–∞–µ–º ComparableProperty –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    comp = ComparableProperty(**result)

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                    is_valid, details = validate_comparable(comp)

                    if is_valid:
                        validated.append(result)
                        logger.debug(
                            f"‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –≤–∞–ª–∏–¥–µ–Ω "
                            f"(–ø–æ–ª–Ω–æ—Ç–∞: {details.get('completeness', 0):.0f}%)"
                        )
                    else:
                        excluded_count += 1
                        failures_str = '; '.join(details.get('failures', []))
                        logger.info(f"‚úó –†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –ò–°–ö–õ–Æ–ß–ï–ù - {failures_str}")
                        logger.info(f"   URL: {result.get('url', 'N/A')}")
                        logger.info(f"   –¶–µ–Ω–∞: {result.get('price', 'N/A')}, –ü–ª–æ—â–∞–¥—å: {result.get('total_area', 'N/A')}, –¶–µ–Ω–∞/–º¬≤: {result.get('price_per_sqm', 'N/A')}")

                except ValidationError as e:
                    excluded_count += 1
                    logger.info(f"‚úó –†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}: –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö - {e}")
                    logger.info(f"   URL: {result.get('url', 'N/A')}")

            if excluded_count > 0:
                logger.info(
                    f"üìä –í–∞–ª–∏–¥–∞—Ü–∏—è: {len(results)} ‚Üí {len(validated)} "
                    f"(–∏—Å–∫–ª—é—á–µ–Ω–æ {excluded_count} –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö)"
                )
            else:
                logger.info(f"‚úì –í—Å–µ {len(validated)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é")

            results = validated
        else:
            logger.info(f"‚ö†Ô∏è DEBUG: –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (VALIDATION_AVAILABLE={VALIDATION_AVAILABLE})")

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        logger.info(f"‚úì –í–æ–∑–≤—Ä–∞—â–∞–µ–º {min(len(results), limit)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (limit={limit})")
        return results[:limit]

    def search_similar_in_building(self, target_property: Dict, limit: int = 20) -> List[Dict]:
        """
        –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä –≤ —Ç–æ–º –∂–µ –ñ–ö (–∂–∏–ª–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ)

        Args:
            target_property: –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ residential_complex, residential_complex_url, address
            limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö
        """
        logger.info("üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä –≤ —Ç–æ–º –∂–µ –ñ–ö...")

        residential_complex = target_property.get('residential_complex') or ''
        residential_complex_url = target_property.get('residential_complex_url') or ''
        address = target_property.get('address') or ''

        # DEBUG: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º—ã –ø–æ–ª—É—á–∏–ª–∏
        logger.info("üìã DEBUG: –î–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã:")
        logger.info(f"   - residential_complex: {residential_complex}")
        logger.info(f"   - residential_complex_url: {residential_complex_url}")
        logger.info(f"   - address: {address}")
        logger.info(f"   - price: {target_property.get('price', 'N/A')}")
        logger.info(f"   - total_area: {target_property.get('total_area', 'N/A')}")
        logger.info(f"   - rooms: {target_property.get('rooms', 'N/A')}")

        # –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ñ–ö (—Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π –º–µ—Ç–æ–¥!)
        if residential_complex_url:
            logger.info(f"‚ú® –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ñ–ö: {residential_complex_url}")

            # –ï—Å–ª–∏ —ç—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω (zhk-–Ω–∞–∑–≤–∞–Ω–∏–µ.cian.ru), –∏—â–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã"
            # –ï—Å–ª–∏ —ç—Ç–æ —Å—Å—ã–ª–∫–∞ /kupit-kvartiru-zhiloy-kompleks-*, –æ–Ω–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
            if 'zhk-' in residential_complex_url and '.cian.ru' in residential_complex_url:
                # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ñ–ö –∏ –∏—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥
                html = self._get_page_content(residential_complex_url)
                if html:
                    from bs4 import BeautifulSoup
                    soup = BeautifulSoup(html, 'lxml')

                    # –ò—â–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –∫–≤–∞—Ä—Ç–∏—Ä –ñ–ö
                    catalog_links = soup.find_all('a', href=True)
                    logger.info(f"üîç DEBUG: –ù–∞–π–¥–µ–Ω–æ {len(catalog_links)} —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ñ–ö")
                    for link in catalog_links:
                        href = link.get('href')

                        if ('/kupit-kvartiru-zhiloy-kompleks-' in href or
                                ('/cat.php' in href and 'newobject' in href)):
                            residential_complex_url = href if href.startswith('http') else f"https://www.cian.ru{href}"
                            logger.info(f"   ‚úì –ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥: {residential_complex_url[:100]}")
                            break
                else:
                    logger.warning(f"‚ö†Ô∏è DEBUG: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ñ–ö: {residential_complex_url}")

            # –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –ñ–ö
            logger.info(f"üîç DEBUG: –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ñ–ö: {residential_complex_url}")
            results = self.parse_search_page(residential_complex_url)

            if results:
                logger.info(f"‚úì –ù–∞–π–¥–µ–Ω–æ {len(results)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ñ–ö")
                # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
                return self._validate_and_prepare_results(results, limit, target_property=target_property)
            else:
                logger.warning("‚ö†Ô∏è –ü–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫")

        # –ü–†–ò–û–†–ò–¢–ï–¢ 2: –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ñ–ö (fallback)
        if not residential_complex:
            logger.warning("‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω –ñ–ö, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É")
            # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ –∞–¥—Ä–µ—Å–∞
            import re
            match = re.search(r'–ñ–ö\s+([–ê-–Ø–∞-—è—ë–Å\s\-\d]+?)(?:,|$)', address or '')
            if match:
                residential_complex = match.group(1).strip()
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç –ñ–ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
                logger.warning("‚ö†Ô∏è –ñ–ö –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫")
                return self.search_similar(target_property, limit)

        logger.info(f"üìç –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –ñ–ö: {residential_complex}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        import urllib.parse

        # –í–∞—Ä–∏–∞–Ω—Ç 1: –¢–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö
        search_query = f"–ñ–ö {residential_complex}"
        encoded_query = urllib.parse.quote(search_query)

        # –£–õ–£–ß–®–ï–ù–ò–ï: –î–ª—è –ñ–ö –∏—â–µ–º –í–°–ï –∫–≤–∞—Ä—Ç–∏—Ä—ã, —Ç.–∫. —Ü–µ–Ω–∞/–º¬≤ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è
        # –§–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç –£–ë–†–ê–ù - –≤ –ñ–ö 1-–∫–æ–º–Ω –∏ 3-–∫–æ–º–Ω = —Ö–æ—Ä–æ—à–∏–µ –∞–Ω–∞–ª–æ–≥–∏ –ø–æ —Ü–µ–Ω–µ/–º¬≤
        target_area = target_property.get('total_area', 0)

        # –°—Ç—Ä–æ–∏–º URL –ø–æ–∏—Å–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –ë–ï–ó —Å—Ç—Ä–æ–≥–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        search_params = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'region': self.region_code,
            'text': encoded_query,
        }

        # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–ª–æ—â–∞–¥–∏ –¥–ª—è –ñ–ö - —Ü–µ–Ω–∞/–º¬≤ –≤–∞–∂–Ω–µ–µ!
        # –í –ñ–ö –≤—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–º–µ—é—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Ü–µ–Ω—É –∑–∞ –º¬≤
        logger.info(f"   üìä –ü–æ–∏—Å–∫ –≤ –ñ–ö: –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ø–ª–æ—â–∞–¥–∏ –∏ –∫–æ–º–Ω–∞—Ç (—Ü–µ–Ω–∞/–º¬≤ –≤–∞–∂–Ω–µ–µ)")

        # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º - –≤ –ñ–ö —ç—Ç–æ –Ω–µ –≤–∞–∂–Ω–æ

        url = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params.items()])

        logger.info(f"üîó URL –ø–æ–∏—Å–∫–∞: {url}")

        # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        results = self.parse_search_page(url)

        logger.info(f"üîç DEBUG: parse_search_page –≤–µ—Ä–Ω—É–ª {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞")

        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —Ç–æ—á–Ω–æ –∏–∑ —ç—Ç–æ–≥–æ –ñ–ö
        filtered_results = []
        rc_lower = residential_complex.lower()

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
        rc_words = set(rc_lower.split())

        logger.info(f"   –ù–∞–π–¥–µ–Ω–æ {len(results)} –∫–∞—Ä—Ç–æ—á–µ–∫, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ñ–ö '{residential_complex}'")
        logger.info(f"   –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ñ–ö: {rc_words}")

        for i, result in enumerate(results):
            result_title = result.get('title', '').lower()
            result_address = result.get('address', '').lower()

            if i < 5:  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 5 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                logger.info(f"   –ö–∞—Ä—Ç–æ—á–∫–∞ {i+1}:")
                logger.info(f"     Title: {result_title[:100]}")
                logger.info(f"     Address: {result_address[:150]}")

            # –ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if rc_lower in result_title or rc_lower in result_address:
                filtered_results.append(result)
                logger.info(f"     ‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ (–ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)")
                continue

            # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–≤–∞
            # (–º–∏–Ω–∏–º—É–º 2 —Å–ª–æ–≤–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ñ–ö –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
            if len(rc_words) >= 2:
                title_words = set(result_title.split())
                address_words = set(result_address.split())

                matching_in_title = len(rc_words & title_words)
                matching_in_address = len(rc_words & address_words)

                if matching_in_title >= 2 or matching_in_address >= 2:
                    filtered_results.append(result)
                    logger.info(f"     ‚úì –î–æ–±–∞–≤–ª–µ–Ω–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: {matching_in_title} –≤ title, {matching_in_address} –≤ address)")
                elif i < 5:
                    logger.info(f"     ‚úó –ü—Ä–æ–ø—É—â–µ–Ω–∞ (–º–∞–ª–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {matching_in_title} –≤ title, {matching_in_address} –≤ address)")

        logger.info(f"‚úì –ù–∞–π–¥–µ–Ω–æ {len(filtered_results)} –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ñ–ö '{residential_complex}'")

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å –û–°–õ–ê–ë–õ–ï–ù–ù–´–ú–ò —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è –ñ–ö
        # –í –ñ–ö —Ü–µ–Ω–∞/–º¬≤ –æ–¥–∏–Ω–∞–∫–æ–≤–∞, –ø–æ—ç—Ç–æ–º—É –ø–ª–æ—â–∞–¥—å –º–µ–Ω–µ–µ –≤–∞–∂–Ω–∞
        return self._validate_and_prepare_results(filtered_results, limit, target_property=target_property, relaxed_filters=True)

    def _is_new_building(self, target_property: Dict = None) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–æ–π

        Args:
            target_property: –î–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

        Returns:
            bool: True –µ—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞, False –µ—Å–ª–∏ –≤—Ç–æ—Ä–∏—á–∫–∞
        """
        if not target_property:
            return False

        # –ú–µ—Ç–æ–¥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ URL
        url = target_property.get('url', '')
        if '/newobject/' in url or 'newobject' in url:
            logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (–ø–æ URL)")
            return True

        # –ú–µ—Ç–æ–¥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ —Å–¥–∞—á–∏ (–µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –∏–ª–∏ –±–ª–∏–∑–∫–æ –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É)
        from datetime import datetime
        current_year = datetime.now().year

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ build_year
        build_year = target_property.get('build_year')
        if build_year:
            try:
                year = int(build_year)
                if year >= current_year:  # –°–¥–∞—á–∞ –≤ –±—É–¥—É—â–µ–º = –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞
                    logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (–≥–æ–¥ —Å–¥–∞—á–∏ {year} >= {current_year})")
                    return True
                elif year >= current_year - 2:  # –°–¥–∞–Ω –Ω–µ–¥–∞–≤–Ω–æ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞)
                    logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (—Å–¥–∞–Ω –Ω–µ–¥–∞–≤–Ω–æ: {year})")
                    return True
            except (ValueError, TypeError):
                pass

        # –ú–µ—Ç–æ–¥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—ä–µ–∫—Ç–∞
        object_status = target_property.get('object_status', '').lower()
        if '–Ω–æ–≤–æ—Å—Ç—Ä' in object_status or '—Å—Ç—Ä–æ–∏—Ç' in object_status:
            logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (—Å—Ç–∞—Ç—É—Å: {object_status})")
            return True

        # –ú–µ—Ç–æ–¥ 4: –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ - –±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ + –≤—ã—Å–æ–∫–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤
        repair_level = target_property.get('repair_level', '').lower()
        price_per_sqm = target_property.get('price_per_sqm', 0) or target_property.get('price', 0) / max(target_property.get('total_area', 1), 1)

        if '–±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏' in repair_level and price_per_sqm > 200_000:  # –ü—Ä–µ–º–∏—É–º –±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ = —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞
            logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (–±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏ + —Ü–µ–Ω–∞ {price_per_sqm:,.0f} ‚ÇΩ/–º¬≤)")
            return True

        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –≤—Ç–æ—Ä–∏—á–∫–æ–π
        logger.info(f"   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –≤—Ç–æ—Ä–∏—á–∫–∞ (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏)")
        return False

    def _get_segment_tolerances(self, target_price: float) -> tuple[float, float, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ–ø—É—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏

        Returns:
            tuple: (price_tolerance, area_tolerance, segment)
        """
        # FIX ISSUE #1: –£–ñ–ï–°–¢–û–ß–ï–ù–´ –¥–æ–ø—É—Å–∫–∏ –¥–ª—è –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞ (–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Ä–æ–∂–µ)
        # –î–ª—è –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞ –Ω—É–∂–Ω—ã —É–∑–∫–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã, —Ç.–∫. —Ä–∞–∑–±—Ä–æ—Å —Ü–µ–Ω –º–µ–Ω—å—à–µ
        if target_price >= 300_000_000:  # –≠–ª–∏—Ç–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (300+ –º–ª–Ω)
            return 0.15, 0.10, "—ç–ª–∏—Ç–Ω–∞—è"  # ¬±15% —Ü–µ–Ω–∞, ¬±10% –ø–ª–æ—â–∞–¥—å (–±—ã–ª–æ 0.30/0.20)
        elif target_price >= 100_000_000:  # –ü—Ä–µ–º–∏—É–º (100-300 –º–ª–Ω)
            return 0.20, 0.15, "–ø—Ä–µ–º–∏—É–º"  # ¬±20% —Ü–µ–Ω–∞, ¬±15% –ø–ª–æ—â–∞–¥—å (–±—ã–ª–æ 0.40/0.30)
        elif target_price >= 25_000_000:   # –°—Ä–µ–¥–Ω–∏–π+ (25-100 –º–ª–Ω) - –£–ñ–ï–°–¢–û–ß–ï–ù–´ –î–û–ü–£–°–ö–ò
            return 0.25, 0.20, "—Å—Ä–µ–¥–Ω–∏–π+"  # ¬±25% —Ü–µ–Ω–∞, ¬±20% –ø–ª–æ—â–∞–¥—å (–±—ã–ª–æ 0.50/0.35)
            # –î–ª—è 31 –º–ª–Ω: –¥–∏–∞–ø–∞–∑–æ–Ω 23.25-38.75 –º–ª–Ω –≤–º–µ—Å—Ç–æ 15.5-46.5 –º–ª–Ω
        else:  # –≠–∫–æ–Ω–æ–º (–¥–æ 25 –º–ª–Ω)
            return 0.40, 0.30, "—ç–∫–æ–Ω–æ–º"  # ¬±40% —Ü–µ–Ω–∞, ¬±30% –ø–ª–æ—â–∞–¥—å (–±—ã–ª–æ 0.60/0.40)

    def _parse_address(self, address: str) -> dict:
        """
        –ü–∞—Ä—Å–∏—Ç –∞–¥—Ä–µ—Å –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞

        –ü—Ä–∏–º–µ—Ä—ã:
            "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 4–∫2" -> {"street": "–ü—Ä–∏–º–µ—Ä–Ω–∞—è", "house": "4", "building": "–∫2"}
            "—É–ª. –õ–µ–Ω–∏–Ω–∞, 15/3" -> {"street": "–õ–µ–Ω–∏–Ω–∞", "house": "15", "building": "/3"}

        Returns:
            dict: {"street": str, "house": str, "building": str} –∏–ª–∏ –ø—É—Å—Ç–æ–π dict –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
        """
        import re

        if not address:
            return {}

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∞–¥—Ä–µ—Å
        addr = address.lower().strip()

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —É–ª–∏—Ü—ã
        # –í–ê–ñ–ù–û: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –¥–æ –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ "–¥./–¥–æ–º"
        street_patterns = [
            r'(?:—É–ª(?:\.|–∏—Ü–∞)?|–ø—Ä(?:-—Ç|–æ—Å–ø–µ–∫—Ç)?|–ø–µ—Ä(?:\.|–µ—É–ª–æ–∫)?|–±(?:-—Ä|—É–ª—å–≤–∞—Ä)?|–Ω–∞–±(?:\.|–µ—Ä–µ–∂–Ω–∞—è)?|—à(?:\.|–æ—Å—Å–µ)?|–ø–ª(?:\.|–æ—â–∞–¥—å)?)[.\s]+([–∞-—è—ë][–∞-—è—ë\s\-]*?)(?:,|\s+–¥\.|\s+–¥\s|\s+–¥–æ–º|\s*$)',
            r'([–∞-—è—ë][–∞-—è—ë\s\-]+?)\s+(?:—É–ª–∏—Ü–∞|–ø—Ä–æ—Å–ø–µ–∫—Ç|–ø–µ—Ä–µ—É–ª–æ–∫|–±—É–ª—å–≤–∞—Ä)',
        ]

        street = ""
        for pattern in street_patterns:
            match = re.search(pattern, addr)
            if match:
                street = match.group(1).strip()
                break

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –¥–æ–º–∞
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º: –¥. 4, –¥.4, –¥–æ–º 4, 4–∫2, 4/3, 4 –∫–æ—Ä–ø. 2, 4 —Å—Ç—Ä. 1
        house_patterns = [
            r'(?:–¥(?:\.|–æ–º)?)\s*(\d+)\s*(–∫(?:–æ—Ä–ø(?:\.|—É—Å)?)?\.?\s*\d+|/\d+|—Å—Ç—Ä(?:\.|–æ–µ–Ω–∏–µ)?\.?\s*\d+|–ª–∏—Ç(?:\.|–µ—Ä–∞)?\.?\s*[–∞-—èa-z])?',
            r',\s*(\d+)\s*(–∫(?:–æ—Ä–ø(?:\.|—É—Å)?)?\.?\s*\d+|/\d+|—Å—Ç—Ä(?:\.|–æ–µ–Ω–∏–µ)?\.?\s*\d+|–ª–∏—Ç(?:\.|–µ—Ä–∞)?\.?\s*[–∞-—èa-z])?\s*(?:,|$)',
        ]

        house = ""
        building = ""
        for pattern in house_patterns:
            match = re.search(pattern, addr)
            if match:
                house = match.group(1)
                building = match.group(2) or ""
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ—Ä–ø—É—Å: "–∫–æ—Ä–ø. 2" -> "–∫2", "–∫–æ—Ä–ø—É—Å2" -> "–∫2"
                if building:
                    building = re.sub(r'–∫–æ—Ä–ø(?:—É—Å)?\.?\s*', '–∫', building)
                    building = re.sub(r'—Å—Ç—Ä(?:–æ–µ–Ω–∏–µ)?\.?\s*', '—Å', building)
                    building = re.sub(r'\s+', '', building)
                break

        if not street and not house:
            return {}

        result = {
            "street": street.strip(' ,-'),
            "house": house,
            "building": building
        }

        logger.debug(f"   üìç –ü–∞—Ä—Å–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ '{address}' -> {result}")
        return result

    def _generate_nearby_houses(self, parsed_address: dict, radius: int = 3) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Å–µ–¥–Ω–∏—Ö –¥–æ–º–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–Ω–∞–ª–æ–≥–æ–≤

        Args:
            parsed_address: –†–µ–∑—É–ª—å—Ç–∞—Ç _parse_address()
            radius: –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ (—Å–∫–æ–ª—å–∫–æ –¥–æ–º–æ–≤ –≤ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É)

        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–æ–º–µ—Ä–æ–≤ –¥–æ–º–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞: ["4–∫1", "4–∫2", "3", "3–∫1", "5", "5–∫1", ...]
        """
        if not parsed_address or not parsed_address.get("house"):
            return []

        try:
            base_house = int(parsed_address["house"])
        except (ValueError, TypeError):
            return []

        nearby = []

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–æ–º–æ–≤
        for offset in range(0, radius + 1):
            for direction in [0, 1, -1] if offset == 0 else [1, -1]:
                house_num = base_house + (offset * direction)
                if house_num <= 0:
                    continue

                # –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º –¥–æ–º –∏ –µ–≥–æ –∫–æ—Ä–ø—É—Å–∞
                nearby.append(str(house_num))
                for korpus in range(1, 5):  # –∫1, –∫2, –∫3, –∫4
                    nearby.append(f"{house_num}–∫{korpus}")
                # –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏—Ç–µ—Ä—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–æ–º–æ–≤
                if offset <= 1:
                    for lit in ['–∞', '–±', '–≤']:
                        nearby.append(f"{house_num}{lit}")

        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
        seen = set()
        unique = []
        for h in nearby:
            if h not in seen:
                seen.add(h)
                unique.append(h)

        logger.debug(f"   üè† –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(unique)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –¥–æ–º–æ–≤: {unique[:10]}...")
        return unique

    def _search_by_address(self, street: str, house: str, target_property: Dict,
                           price_tolerance: float, area_tolerance: float, limit: int = 5) -> List[Dict]:
        """
        –ü–æ–∏—Å–∫ –∞–Ω–∞–ª–æ–≥–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–¥—Ä–µ—Å—É (—É–ª–∏—Ü–∞ + –¥–æ–º)

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –¶–ò–ê–ù –ø–æ –∞–¥—Ä–µ—Å—É
        """
        if not street:
            return []

        target_price = target_property.get('price', 100_000_000)
        target_area = target_property.get('total_area', 100)
        target_rooms = target_property.get('rooms', 2)

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–º–Ω–∞—Ç—ã
        target_rooms_int = self._normalize_rooms(target_rooms) or 2

        # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
        search_params = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'price_min': int(target_price * (1 - price_tolerance)),
            'price_max': int(target_price * (1 + price_tolerance)),
            'minArea': int(target_area * (1 - area_tolerance)),
            'maxArea': int(target_area * (1 + area_tolerance)),
            'region': self.region_code,
            f'room{target_rooms_int}': '1',
        }

        # –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
        is_new_building = self._is_new_building(target_property)
        search_params['type'] = '4' if is_new_building else '1'

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ –∞–¥—Ä–µ—Å—É
        # –¶–ò–ê–ù –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä 'text' –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
        search_query = f"{street}"
        if house:
            search_query += f" {house}"

        search_params['text'] = search_query

        url = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params.items()])

        logger.debug(f"   üîç –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É: {search_query}")

        results = self.parse_search_page(url)

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–¥—Ä–µ—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω—É—é —É–ª–∏—Ü—É
        filtered = []
        street_lower = street.lower()
        for r in results:
            r_address = (r.get('address', '') or '').lower()
            if street_lower in r_address:
                filtered.append(r)

        return filtered[:limit]

    def _build_search_url(self, target_price: float, target_area: float, target_rooms: int,
                          price_tolerance: float, area_tolerance: float, target_property: Dict = None) -> str:
        """
        –°—Ç—Ä–æ–∏—Ç URL –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –¶–∏–∞–Ω

        Args:
            target_price: –¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞
            target_area: –¶–µ–ª–µ–≤–∞—è –ø–ª–æ—â–∞–¥—å
            target_rooms: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
            price_tolerance: –î–æ–ø—É—Å–∫ –ø–æ —Ü–µ–Ω–µ (0.2 = ¬±20%)
            area_tolerance: –î–æ–ø—É—Å–∫ –ø–æ –ø–ª–æ—â–∞–¥–∏ (0.15 = ¬±15%)
            target_property: –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞)

        Returns:
            str: URL –¥–ª—è –ø–æ–∏—Å–∫–∞
        """
        search_params = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'price_min': int(target_price * (1 - price_tolerance)),
            'price_max': int(target_price * (1 + price_tolerance)),
            'minArea': int(target_area * (1 - area_tolerance)),
            'maxArea': int(target_area * (1 + area_tolerance)),
            'region': self.region_code,
        }

        # PATCH: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ vs –≤—Ç–æ—Ä–∏—á–∫–∞)
        is_new_building = self._is_new_building(target_property)

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¶–∏–∞–Ω!
        # type=4 - –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏, type=1 - –≤—Ç–æ—Ä–∏—á–∫–∞
        if is_new_building:
            search_params['type'] = '4'  # 4 = –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ –≤ Cian API
            logger.info(f"   üèóÔ∏è –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç - –ù–û–í–û–°–¢–†–û–ô–ö–ê, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–∏—Å–∫ (type=4)")
        else:
            search_params['type'] = '1'  # 1 = –≤—Ç–æ—Ä–∏—á–∫–∞ –≤ Cian API
            logger.info(f"   üè† –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç - –í–¢–û–†–ò–ß–ö–ê, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–∏—Å–∫ (type=1)")

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂–∞–º (–Ω–µ –ø–µ—Ä–≤—ã–π –∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —ç—Ç–∞–∂–µ–π)
        # –ò—Å–∫–ª—é—á–∞–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂–∏, –µ—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç - —Å—Ä–µ–¥–Ω–∏–π —ç—Ç–∞–∂
        if target_property:
            floor = target_property.get('floor')
            total_floors = target_property.get('total_floors')

            if floor and total_floors:
                try:
                    floor_num = int(floor)
                    total_num = int(total_floors)

                    # –ï—Å–ª–∏ —Å—Ä–µ–¥–Ω–∏–π —ç—Ç–∞–∂ (–Ω–µ 1 –∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π)
                    if floor_num > 1 and floor_num < total_num:
                        search_params['not_first_floor'] = '1'  # –ò—Å–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–≤—ã–π
                        search_params['not_last_floor'] = '1'   # –ò—Å–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π
                        logger.info(f"   üè¢ –§–∏–ª—å—Ç—Ä —ç—Ç–∞–∂–µ–π: –¢–û–õ–¨–ö–û —Å—Ä–µ–¥–Ω–∏–µ (–Ω–µ 1, –Ω–µ {total_num})")
                    elif floor_num == 1:
                        # –ò—â–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ —ç—Ç–∞–∂–∏
                        search_params['foot'] = '1'
                        logger.info(f"   üè¢ –§–∏–ª—å—Ç—Ä —ç—Ç–∞–∂–µ–π: –¢–û–õ–¨–ö–û –ø–µ—Ä–≤—ã–µ")
                    elif floor_num == total_num:
                        # –ò—â–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏
                        search_params['max_foot'] = '1'
                        logger.info(f"   üè¢ –§–∏–ª—å—Ç—Ä —ç—Ç–∞–∂–µ–π: –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ–¥–Ω–∏–µ")
                except (ValueError, TypeError):
                    pass

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∞—Å—Å—É –∂–∏–ª—å—è –¥–ª—è –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞
        # class=1 - —ç–∫–æ–Ω–æ–º, class=2 - –∫–æ–º—Ñ–æ—Ä—Ç, class=3 - –±–∏–∑–Ω–µ—Å, class=4 - —ç–ª–∏—Ç
        if target_price >= 25_000_000 and is_new_building:
            # –î–ª—è –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞ –∏—â–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º—Ñ–æ—Ä—Ç+ (2,3,4)
            search_params['class'] = '2'  # –ö–æ–º—Ñ–æ—Ä—Ç –∫–∞–∫ –º–∏–Ω–∏–º—É–º
            logger.info(f"   üíé –§–∏–ª—å—Ç—Ä –∫–ª–∞—Å—Å–∞: –∫–æ–º—Ñ–æ—Ä—Ç+ (–ø—Ä–µ–º–∏—É–º —Å–µ–≥–º–µ–Ω—Ç)")

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ–¥—É —Å–¥–∞—á–∏ (¬±1 –≥–æ–¥ –¥–ª—è –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫)
        if is_new_building and target_property:
            build_year = target_property.get('build_year')
            if build_year:
                try:
                    year = int(build_year)
                    from datetime import datetime
                    current_year = datetime.now().year

                    # –î–ª—è –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫ —Å –≥–æ–¥–æ–º —Å–¥–∞—á–∏ –≤ –±—É–¥—É—â–µ–º
                    if year >= current_year:
                        # min_offer_date –∏ max_offer_date –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-Q (–≥–æ–¥-–∫–≤–∞—Ä—Ç–∞–ª)
                        # –ù–∞–ø—Ä–∏–º–µ—Ä: 2028-3 = 3 –∫–≤–∞—Ä—Ç–∞–ª 2028
                        year_min = max(current_year, year - 1)
                        year_max = year + 1

                        # –¶–∏–∞–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç: deadline_from=2027&deadline_to=2029
                        search_params['deadline_from'] = str(year_min)
                        search_params['deadline_to'] = str(year_max)
                        logger.info(f"   üìÖ –§–∏–ª—å—Ç—Ä –≥–æ–¥–∞ —Å–¥–∞—á–∏: {year_min}-{year_max} (¬±1 –≥–æ–¥ –æ—Ç {year})")
                except (ValueError, TypeError):
                    pass

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ –æ—Ç–¥–µ–ª–∫–µ (—Å –æ—Ç–¥–µ–ª–∫–æ–π/–±–µ–∑)
        if target_property:
            repair_level = target_property.get('repair_level', '').lower()

            if '–±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏' in repair_level or '—á–µ—Ä–Ω–æ–≤–∞—è' in repair_level:
                # –ò—â–µ–º –æ–±—ä–µ–∫—Ç—ã –±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏
                # decoration=1 - –±–µ–∑ –æ—Ç–¥–µ–ª–∫–∏, decoration=2 - —Å –æ—Ç–¥–µ–ª–∫–æ–π, decoration=3 - –ø–æ–¥ –∫–ª—é—á
                search_params['decoration'] = '1'
                logger.info(f"   üé® –§–∏–ª—å—Ç—Ä –æ—Ç–¥–µ–ª–∫–∏: –ë–ï–ó –æ—Ç–¥–µ–ª–∫–∏")
            elif '–æ—Ç–¥–µ–ª–∫' in repair_level or '—Ä–µ–º–æ–Ω—Ç' in repair_level:
                # –ò—â–µ–º –æ–±—ä–µ–∫—Ç—ã —Å –æ—Ç–¥–µ–ª–∫–æ–π
                search_params['decoration'] = '2'
                logger.info(f"   üé® –§–∏–ª—å—Ç—Ä –æ—Ç–¥–µ–ª–∫–∏: –° –æ—Ç–¥–µ–ª–∫–æ–π")

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –¥–æ–º–∞ (–¥–ª—è –≤—Ç–æ—Ä–∏—á–∫–∏)
        # building_type: 1-–∫–∏—Ä–ø–∏—á–Ω—ã–π, 2-–ø–∞–Ω–µ–ª—å–Ω—ã–π, 3-–±–ª–æ—á–Ω—ã–π, 4-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π, 5-–∫–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π
        if not is_new_building and target_property:
            house_type = target_property.get('house_type', '').lower()

            if '–º–æ–Ω–æ–ª–∏—Ç' in house_type:
                if '–∫–∏—Ä–ø–∏—á' in house_type:
                    search_params['building_type'] = '5'  # –ö–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π
                    logger.info(f"   üèóÔ∏è –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –¥–æ–º–∞: –∫–∏—Ä–ø–∏—á–Ω–æ-–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π")
                else:
                    search_params['building_type'] = '4'  # –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π
                    logger.info(f"   üèóÔ∏è –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –¥–æ–º–∞: –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π")
            elif '–∫–∏—Ä–ø–∏—á' in house_type:
                search_params['building_type'] = '1'  # –ö–∏—Ä–ø–∏—á–Ω—ã–π
                logger.info(f"   üèóÔ∏è –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –¥–æ–º–∞: –∫–∏—Ä–ø–∏—á–Ω—ã–π")
            elif '–ø–∞–Ω–µ–ª' in house_type:
                search_params['building_type'] = '2'  # –ü–∞–Ω–µ–ª—å–Ω—ã–π
                logger.info(f"   üèóÔ∏è –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –¥–æ–º–∞: –ø–∞–Ω–µ–ª—å–Ω—ã–π")
            elif '–±–ª–æ—á–Ω' in house_type:
                search_params['building_type'] = '3'  # –ë–ª–æ—á–Ω—ã–π
                logger.info(f"   üèóÔ∏è –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –¥–æ–º–∞: –±–ª–æ—á–Ω—ã–π")

        # PATCH: –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ–¥—É –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–ª—è –≤—Ç–æ—Ä–∏—á–∫–∏, ¬±10 –ª–µ—Ç)
        if not is_new_building and target_property:
            build_year = target_property.get('build_year')
            if build_year:
                try:
                    year = int(build_year)
                    from datetime import datetime
                    current_year = datetime.now().year

                    # –¢–æ–ª—å–∫–æ –¥–ª—è –≤—Ç–æ—Ä–∏—á–∫–∏ (–Ω–µ –±—É–¥—É—â–∏–µ –≥–æ–¥–∞)
                    if year < current_year:
                        year_min = year - 10
                        year_max = year + 10

                        search_params['min_year'] = str(year_min)
                        search_params['max_year'] = str(year_max)
                        logger.info(f"   üìÖ –§–∏–ª—å—Ç—Ä –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏: {year_min}-{year_max} (¬±10 –ª–µ—Ç –æ—Ç {year})")
                except (ValueError, TypeError):
                    pass

        # –ö–æ–º–Ω–∞—Ç—ã (–¥–∏–∞–ø–∞–∑–æ–Ω ¬±1)
        target_rooms_int = self._normalize_rooms(target_rooms) or 2  # –¥–µ—Ñ–æ–ª—Ç 2 –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –°–¢–†–û–ì–ò–ô —Ñ–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç (–±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è!)
        # –ë–´–õ–û: rooms_min=1, rooms_max=2 ‚Üí room1=1 –ò room2=1 (–∏—Å–∫–∞–ª–æ 1-–∫–æ–º–Ω –ò 2-–∫–æ–º–Ω!)
        # –°–ï–ô–ß–ê–°: –¢–û–õ–¨–ö–û room{target}=1 (–∏—â–µ–º –°–¢–†–û–ì–û —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç)
        search_params[f'room{target_rooms_int}'] = '1'
        logger.info(f"   üè† –§–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç: –°–¢–†–û–ì–û {target_rooms_int}-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ (–±–µ–∑ —Å–º–µ—à–∏–≤–∞–Ω–∏—è!)")

        return f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params.items()])

    def _filter_by_location(self, results: List[Dict], target_property: Dict, strict: bool = True) -> List[Dict]:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –ª–æ–∫–∞—Ü–∏–∏ (–º–µ—Ç—Ä–æ, —Ä–∞–π–æ–Ω)

        Args:
            results: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            target_property: –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç
            strict: –ï—Å–ª–∏ True, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–µ—Ç—Ä–æ/—Ä–∞–π–æ–Ω–∞
                   –ï—Å–ª–∏ False, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞

        Returns:
            –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        """
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ metro –∫–∞–∫ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏
        target_metro_raw = target_property.get('metro', '')
        if isinstance(target_metro_raw, list):
            # –ï—Å–ª–∏ metro - —Å–ø–∏—Å–æ–∫, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Ç–∞–Ω—Ü–∏—é –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
            target_metro = ', '.join(target_metro_raw).lower().strip() if target_metro_raw else ''
        else:
            target_metro = str(target_metro_raw).lower().strip()

        target_address = target_property.get('address') or ''.lower().strip()

        if not target_metro and not target_address:
            logger.info("   ‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–æ–∫–∞—Ü–∏–∏ —Ü–µ–ª–µ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞")
            return results

        filtered = []

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∞–¥—Ä–µ—Å–∞ (—Ä–∞–π–æ–Ω—ã, —É–ª–∏—Ü—ã)
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥, –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ –∏ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞
        stop_words = {'–º–æ—Å–∫–≤–∞', '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '—Å–ø–±', '–º—Å–∫', '—É–ª–∏—Ü–∞', '–ø—Ä–æ—Å–ø–µ–∫—Ç', '–ø–µ—Ä–µ—É–ª–æ–∫',
                      '–±—É–ª—å–≤–∞—Ä', '—à–æ—Å—Å–µ', '–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è', '–ø–ª–æ—â–∞–¥—å', '–∞–ª–ª–µ—è', '–ø—Ä–æ–µ–∑–¥'}

        target_keywords = set()
        if target_address:
            for word in target_address.replace(',', ' ').split():
                word = word.strip()
                if len(word) > 3 and word not in stop_words:
                    target_keywords.add(word)

        for result in results:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π)
            result_metro_raw = result.get('metro', '')
            if isinstance(result_metro_raw, list):
                result_metro = ', '.join(result_metro_raw).lower().strip() if result_metro_raw else ''
            else:
                result_metro = result_metro_raw.lower().strip() if result_metro_raw else ''

            result_address = result.get('address', '').lower().strip() if result.get('address') else ''

            # –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–µ—Ç—Ä–æ
            if strict and target_metro:
                if target_metro in result_metro or result_metro in target_metro:
                    filtered.append(result)
                    continue

            # FIX: –î–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (–±–µ–∑ –º–µ—Ç—Ä–æ) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥—Ä–µ—Å –¥–∞–∂–µ –≤ —Å—Ç—Ä–æ–≥–æ–º —Ä–µ–∂–∏–º–µ
            # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ —É–ª–∏—Ü–µ –∫–æ–≥–¥–∞ –º–µ—Ç—Ä–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
            if strict and not target_metro and target_keywords:
                result_keywords = set()
                for word in result_address.replace(',', ' ').split():
                    word = word.strip()
                    if len(word) > 3 and word not in stop_words:
                        result_keywords.add(word)

                # –¢—Ä–µ–±—É–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–∏–Ω–∏–º—É–º 1 –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (—É–ª–∏—Ü–∞, —Ä–∞–π–æ–Ω)
                if target_keywords & result_keywords:
                    filtered.append(result)
                    continue

            # –ù–µ—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —á–∞—Å—Ç–∏ –∞–¥—Ä–µ—Å–∞
            if not strict and target_keywords:
                result_keywords = set()
                for word in result_address.replace(',', ' ').split():
                    word = word.strip()
                    if len(word) > 3 and word not in stop_words:
                        result_keywords.add(word)

                # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –æ–±—â–µ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (—Ä–∞–π–æ–Ω, —É–ª–∏—Ü–∞ –∏ —Ç.–¥.)
                if target_keywords & result_keywords:
                    filtered.append(result)
                    continue

        return filtered

    def search_similar(self, target_property: Dict, limit: int = 20) -> List[Dict]:
        """
        –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä (–î–û–†–ê–ë–û–¢–ö–ê #5)

        –£—Ä–æ–≤–µ–Ω—å 1: –ü–æ–∏—Å–∫ —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–æ–ø—É—Å–∫–∞–º–∏ + —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–π–æ–Ω—É/–º–µ—Ç—Ä–æ
        –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –≥–æ—Ä–æ–¥—É (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏)
        –£—Ä–æ–≤–µ–Ω—å 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (+50% –∫ –¥–æ–ø—É—Å–∫–∞–º)

        Args:
            target_property: –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ price, total_area, rooms, metro, address
            limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        """
        logger.info("=" * 80)
        logger.info("üîç –ù–ê–ß–ò–ù–ê–ï–ú –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–´–ô –ü–û–ò–°–ö –ê–ù–ê–õ–û–ì–û–í (–î–û–†–ê–ë–û–¢–ö–ê #5)")
        logger.info("=" * 80)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
        target_price = target_property.get('price', 100_000_000)
        target_area = target_property.get('total_area', 100)
        target_rooms = target_property.get('rooms', 2)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è "—Å—Ç—É–¥–∏—è" - —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ 1 –∫–æ–º–Ω–∞—Ç—É
        if isinstance(target_rooms, str):
            if '—Å—Ç—É–¥' in target_rooms.lower():
                target_rooms = 1
            else:
                # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
                import re
                match = re.search(r'\d+', target_rooms)
                target_rooms = int(match.group()) if match else 2

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç—Ä–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π)
        target_metro_raw = target_property.get('metro', '')
        if isinstance(target_metro_raw, list):
            target_metro = ', '.join(target_metro_raw) if target_metro_raw else ''
        else:
            target_metro = target_metro_raw if target_metro_raw else ''

        target_address = target_property.get('address') or ''

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –î–û–†–ê–ë–û–¢–ö–ê #2: –ê–î–ê–ü–¢–ò–í–ù–´–ï –î–ò–ê–ü–ê–ó–û–ù–´ –ü–û–ò–°–ö–ê (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        price_tolerance, area_tolerance, segment = self._get_segment_tolerances(target_price)

        logger.info(f"üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ü–µ–ª–µ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:")
        logger.info(f"   - –°–µ–≥–º–µ–Ω—Ç: {segment} (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –¥–æ–ø—É—Å–∫–∏: —Ü–µ–Ω–∞ ¬±{price_tolerance*100:.0f}%, –ø–ª–æ—â–∞–¥—å ¬±{area_tolerance*100:.0f}%)")
        logger.info(f"   - –¶–µ–Ω–∞: {target_price:,} ‚ÇΩ")
        logger.info(f"   - –ü–ª–æ—â–∞–¥—å: {target_area} –º¬≤")
        logger.info(f"   - –ö–æ–º–Ω–∞—Ç—ã: {target_rooms}")
        logger.info(f"   - –ú–µ—Ç—Ä–æ: {target_metro or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}")
        logger.info(f"   - –ê–¥—Ä–µ—Å: {target_address or '–Ω–µ —É–∫–∞–∑–∞–Ω'}")
        logger.info("")

        final_results = []
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
        new_results_level2 = []
        new_results_level3 = []

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 0: –î–õ–Ø –ù–û–í–û–°–¢–†–û–ï–ö - –ü–†–ò–û–†–ò–¢–ï–¢ –ü–û–ò–°–ö–ê –ü–û –ñ–ö
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –î–ª—è –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ç–æ–º –∂–µ –ñ–ö
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        is_new_building = self._is_new_building(target_property)
        residential_complex = target_property.get('residential_complex', '')

        if is_new_building and residential_complex:
            logger.info(f"üèóÔ∏è –£–†–û–í–ï–ù–¨ 0: –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ - –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ –ñ–ö '{residential_complex}'")
            try:
                results_level0 = self.search_similar_in_building(target_property, limit=limit)
                if len(results_level0) >= self.MIN_RESULTS_THRESHOLD:
                    logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 0: –ù–∞—à–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ –≤ –ñ–ö ({len(results_level0)} —à—Ç.)")
                    validated_level0 = self._validate_and_prepare_results(results_level0, limit, target_property=target_property)
                    final_results.extend(validated_level0)
                    logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 0 –ó–ê–í–ï–†–®–Å–ù: {len(validated_level0)} –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö")
                    logger.info("=" * 80)
                    return final_results[:limit]
                else:
                    logger.warning(f"   ‚ö†Ô∏è –£–†–û–í–ï–ù–¨ 0: –í –ñ–ö –Ω–∞–π–¥–µ–Ω–æ –º–∞–ª–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(results_level0)} —à—Ç.), –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∏—Ä–æ–∫–æ–º—É –ø–æ–∏—Å–∫—É")
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ —á—Ç–æ –Ω–∞—à–ª–∏, –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                    if results_level0:
                        validated_level0 = self._validate_and_prepare_results(results_level0, limit, target_property=target_property)
                        final_results.extend(validated_level0)
                        logger.info(f"   ‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ {len(validated_level0)} –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ –ñ–ö")
            except Exception as e:
                logger.warning(f"   ‚ö†Ô∏è –£–†–û–í–ï–ù–¨ 0: –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –ñ–ö - {e}")
                logger.info(f"   ‚Üí –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∏—Ä–æ–∫–æ–º—É –ø–æ–∏—Å–∫—É")
            logger.info("")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 1: –ü–æ–∏—Å–∫ –≤ —Ç–æ–º –∂–µ —Ä–∞–π–æ–Ω–µ/—É —Ç–æ–≥–æ –∂–µ –º–µ—Ç—Ä–æ
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        logger.info("üéØ –£–†–û–í–ï–ù–¨ 1: –ü–æ–∏—Å–∫ –∞–Ω–∞–ª–æ–≥–æ–≤ –≤ —Ç–æ–º –∂–µ —Ä–∞–π–æ–Ω–µ/—É –º–µ—Ç—Ä–æ")
        logger.info(f"   –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω: {int(target_price * (1-price_tolerance)):,} - {int(target_price * (1+price_tolerance)):,} ‚ÇΩ")
        logger.info(f"   –î–∏–∞–ø–∞–∑–æ–Ω –ø–ª–æ—â–∞–¥–∏: {int(target_area * (1-area_tolerance))} - {int(target_area * (1+area_tolerance))} –º¬≤")

        url_level1 = self._build_search_url(target_price, target_area, target_rooms,
                                            price_tolerance, area_tolerance, target_property)
        logger.info(f"   URL: {url_level1[:100]}...")

        results_level1 = self.parse_search_page(url_level1)
        logger.info(f"   ‚úì –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {len(results_level1)}")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–° –ë–ê–ì #2: PROGRESSIVE FILTER RELAXATION
        # –ï—Å–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí —É–±–∏—Ä–∞–µ–º –¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä—ã (–≥–æ–¥/–∫–ª–∞—Å—Å/—ç—Ç–∞–∂–∏/–æ—Ç–¥–µ–ª–∫–∞)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if len(results_level1) == 0:
            logger.warning("‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å 1 –¥–∞–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!")
            logger.warning("‚ö†Ô∏è –ü—Ä–æ–±—É–µ–º –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–≥–æ–¥/–∫–ª–∞—Å—Å/—ç—Ç–∞–∂–∏/–æ—Ç–¥–µ–ª–∫–∞)...")

            # –°—Ç—Ä–æ–∏–º URL –¢–û–õ–¨–ö–û —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
            search_params_relaxed = {
                'deal_type': 'sale',
                'offer_type': 'flat',
                'engine_version': '2',
                'price_min': int(target_price * (1 - price_tolerance)),
                'price_max': int(target_price * (1 + price_tolerance)),
                'minArea': int(target_area * (1 - area_tolerance)),
                'maxArea': int(target_area * (1 + area_tolerance)),
                'region': self.region_code,
            }

            # –ö–†–ò–¢–ò–ß–ù–û: –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–≤—Ç–æ—Ä–∏—á–∫–∞)
            is_new_building = self._is_new_building(target_property)
            if is_new_building:
                search_params_relaxed['type'] = '4'
                logger.info(f"   üèóÔ∏è –¢–∏–ø: –ù–û–í–û–°–¢–†–û–ô–ö–ê (type=4)")
            else:
                search_params_relaxed['type'] = '1'
                logger.info(f"   üè† –¢–∏–ø: –í–¢–û–†–ò–ß–ö–ê (type=1)")

            # –ö–†–ò–¢–ò–ß–ù–û: –ö–æ–º–Ω–∞—Ç—ã (–°–¢–†–û–ì–û —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
            target_rooms_int = self._normalize_rooms(target_rooms) or 2  # –¥–µ—Ñ–æ–ª—Ç 2

            search_params_relaxed[f'room{target_rooms_int}'] = '1'
            logger.info(f"   üè† –ö–æ–º–Ω–∞—Ç—ã: –°–¢–†–û–ì–û {target_rooms_int}-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ")

            # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º: deadline_from/to, class, not_first/last_floor, decoration, building_type
            url_relaxed = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params_relaxed.items()])
            logger.info(f"   üîÑ Relaxed URL: {url_relaxed[:100]}...")

            results_level1 = self.parse_search_page(url_relaxed)
            logger.info(f"   ‚úÖ –ü–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: {len(results_level1)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π")

        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ª–æ–∫–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º - —Ç–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–µ—Ç—Ä–æ)
        if target_metro or target_address:
            filtered_level1 = self._filter_by_location(results_level1, target_property, strict=True)
            logger.info(f"   ‚úì –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞—Ü–∏–∏: {len(filtered_level1)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π")
        else:
            filtered_level1 = results_level1
            logger.info(f"   ‚ÑπÔ∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Ç—Ä–æ/–∞–¥—Ä–µ—Å–µ)")

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
        validated_level1 = self._validate_and_prepare_results(filtered_level1, limit, target_property=target_property)
        final_results.extend(validated_level1)
        logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 1: –î–æ–±–∞–≤–ª–µ–Ω–æ {len(validated_level1)} –≤–∞–ª–∏–¥–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤")
        logger.info("")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∞–Ω–∞–ª–æ–≥–æ–≤
        if len(final_results) >= self.PREFERRED_RESULTS_THRESHOLD:
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(final_results)} —à—Ç.), –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω")
            logger.info("=" * 80)
            return final_results[:limit]

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 1.5: –ü–û–ò–°–ö –ü–û –°–û–°–ï–î–ù–ò–ú –î–û–ú–ê–ú/–ö–û–†–ü–£–°–ê–ú
        # –î–ª—è –≤—Ç–æ—Ä–∏—á–∫–∏: —Å–æ—Å–µ–¥–Ω–∏–µ –¥–æ–º–∞ (4 ‚Üí 3, 5, 4–∫1...)
        # –î–ª—è –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫: —Å–æ—Å–µ–¥–Ω–∏–µ –∫–æ—Ä–ø—É—Å–∞ –ñ–ö (9–ê–∫3 ‚Üí 9–ê–∫1, 9–ê–∫2, 9–ë...)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        new_results_level15 = []
        if target_address:  # –£–±—Ä–∞–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ "not is_new_building"
            search_type = "–∫–æ—Ä–ø—É—Å–∞–º" if is_new_building else "–¥–æ–º–∞–º"
            logger.info(f"üè† –£–†–û–í–ï–ù–¨ 1.5: –ü–æ–∏—Å–∫ –ø–æ —Å–æ—Å–µ–¥–Ω–∏–º {search_type}")
            logger.info(f"   (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(final_results)}, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10)")

            parsed_addr = self._parse_address(target_address)
            if parsed_addr.get('street'):
                nearby_houses = self._generate_nearby_houses(parsed_addr, radius=5)
                logger.info(f"   üìç –£–ª–∏—Ü–∞: {parsed_addr.get('street')}, –¥–æ–º: {parsed_addr.get('house')}{parsed_addr.get('building', '')}")
                logger.info(f"   üèòÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º {len(nearby_houses)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –¥–æ–º–æ–≤...")

                existing_urls = {r.get('url') for r in final_results}
                houses_checked = 0
                houses_with_results = 0

                for house_variant in nearby_houses:
                    # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤
                    if len(final_results) + len(new_results_level15) >= self.PREFERRED_RESULTS_THRESHOLD:
                        logger.info(f"   ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –¥–æ–º–∞–º")
                        break

                    # –ò—â–µ–º –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
                    results_house = self._search_by_address(
                        parsed_addr['street'], house_variant, target_property,
                        price_tolerance, area_tolerance, limit=3
                    )
                    houses_checked += 1

                    if results_house:
                        houses_with_results += 1
                        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
                        validated_house = self._validate_and_prepare_results(
                            results_house, limit=3, target_property=target_property
                        )
                        for r in validated_house:
                            if r.get('url') not in existing_urls:
                                new_results_level15.append(r)
                                existing_urls.add(r.get('url'))

                final_results.extend(new_results_level15)
                logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 1.5: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ {houses_checked} –¥–æ–º–æ–≤, –Ω–∞–π–¥–µ–Ω–æ –≤ {houses_with_results}")
                logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 1.5: –î–æ–±–∞–≤–ª–µ–Ω–æ {len(new_results_level15)} –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ —Å–æ—Å–µ–¥–Ω–∏—Ö –¥–æ–º–æ–≤")
                logger.info("")
            else:
                logger.info(f"   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∞–¥—Ä–µ—Å: {target_address}")
                logger.info("")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ —É—Ä–æ–≤–Ω—è 1.5
        if len(final_results) >= self.PREFERRED_RESULTS_THRESHOLD:
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(final_results)} —à—Ç.), –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω")
            logger.info("=" * 80)
            return final_results[:limit]

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 1.6: –ü–û–ò–°–ö –ü–û –°–û–°–ï–î–ù–ò–ú –°–¢–ê–ù–¶–ò–Ø–ú –ú–ï–¢–†–û
        # –†–∞—Å—à–∏—Ä—è–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –Ω–∞ 1-2 —Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –≤–µ—Ç–∫–µ –º–µ—Ç—Ä–æ
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        new_results_level16 = []
        if target_metro and self.region == 'msk':  # –¢–æ–ª—å–∫–æ –¥–ª—è –ú–æ—Å–∫–≤—ã
            nearby_metros = self._get_nearby_metros(target_metro)

            if len(nearby_metros) > 1:  # –ï—Å—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
                logger.info(f"üöá –£–†–û–í–ï–ù–¨ 1.6: –ü–æ–∏—Å–∫ –ø–æ —Å–æ—Å–µ–¥–Ω–∏–º —Å—Ç–∞–Ω—Ü–∏—è–º –º–µ—Ç—Ä–æ")
                logger.info(f"   (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(final_results)}, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10)")
                logger.info(f"   üìç –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è: {target_metro}")
                logger.info(f"   üîÑ –°–æ—Å–µ–¥–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏: {', '.join(nearby_metros[1:])}")

                existing_urls = {r.get('url') for r in final_results}

                for metro_station in nearby_metros[1:]:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç–∞–Ω—Ü–∏—é
                    # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤
                    if len(final_results) + len(new_results_level16) >= self.PREFERRED_RESULTS_THRESHOLD:
                        logger.info(f"   ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –º–µ—Ç—Ä–æ")
                        break

                    # –§–∏–ª—å—Ç—Ä—É–µ–º —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ —ç—Ç–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
                    metro_results = []
                    for r in results_level1:  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Level 1 (–≤–µ—Å—å –≥–æ—Ä–æ–¥)
                        result_metro = r.get('metro', '').lower() if r.get('metro') else ''
                        if metro_station in result_metro and r.get('url') not in existing_urls:
                            metro_results.append(r)

                    if metro_results:
                        validated_metro = self._validate_and_prepare_results(
                            metro_results[:5], limit=5, target_property=target_property
                        )
                        for r in validated_metro:
                            if r.get('url') not in existing_urls:
                                new_results_level16.append(r)
                                existing_urls.add(r.get('url'))

                final_results.extend(new_results_level16)
                logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 1.6: –î–æ–±–∞–≤–ª–µ–Ω–æ {len(new_results_level16)} –∞–Ω–∞–ª–æ–≥–æ–≤ —Å —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π")
                logger.info("")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ —É—Ä–æ–≤–Ω—è 1.6
        if len(final_results) >= self.PREFERRED_RESULTS_THRESHOLD:
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(final_results)} —à—Ç.), –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω")
            logger.info("=" * 80)
            return final_results[:limit]

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 2: –†–ï–ê–õ–¨–ù–´–ô –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –≥–æ—Ä–æ–¥—É (–Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏)
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –¶–ò–ê–ù, –∞ –Ω–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Ä–æ–≤–Ω—è 1
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        logger.info(f"üåÜ –£–†–û–í–ï–ù–¨ 2: –†–∞—Å—à–∏—Ä—è–µ–º –ø–æ–∏—Å–∫ –Ω–∞ –≤–µ—Å—å –≥–æ—Ä–æ–¥ (–ù–û–í–´–ô –∑–∞–ø—Ä–æ—Å)")
        logger.info(f"   (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(final_results)}, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10)")

        # –°—Ç—Ä–æ–∏–º URL –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–≥–æ–¥, –∫–ª–∞—Å—Å, —ç—Ç–∞–∂–∏, –æ—Ç–¥–µ–ª–∫–∞)
        search_params_city = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'price_min': int(target_price * (1 - price_tolerance)),
            'price_max': int(target_price * (1 + price_tolerance)),
            'minArea': int(target_area * (1 - area_tolerance)),
            'maxArea': int(target_area * (1 + area_tolerance)),
            'region': self.region_code,
        }

        # –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
        if is_new_building:
            search_params_city['type'] = '4'
        else:
            search_params_city['type'] = '1'

        # –ö–æ–º–Ω–∞—Ç—ã (–û–°–õ–ê–ë–õ–ï–ù–ù–´–ô —Ñ–∏–ª—å—Ç—Ä ¬±1 –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞)
        target_rooms_int = self._normalize_rooms(target_rooms) or 2
        room_params = self._get_room_filter_params(target_rooms_int, strict=False)
        search_params_city.update(room_params)
        room_range = ', '.join([k.replace('room', '') for k in room_params.keys()])
        logger.info(f"   üè† –§–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç: {room_range}-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ (¬±1 –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)")

        url_level2 = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params_city.items()])
        logger.info(f"   URL: {url_level2[:100]}...")

        results_level2 = self.parse_search_page(url_level2)
        logger.info(f"   ‚úì –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {len(results_level2)}")

        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏
        validated_level2 = self._validate_and_prepare_results(results_level2, limit, target_property=target_property)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ (–∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ final_results)
        existing_urls = {r.get('url') for r in final_results}
        new_results_level2 = [r for r in validated_level2 if r.get('url') not in existing_urls]

        final_results.extend(new_results_level2)
        logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 2: –î–æ–±–∞–≤–ª–µ–Ω–æ {len(new_results_level2)} –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ –≥–æ—Ä–æ–¥–∞")
        logger.info("")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
        if len(final_results) >= 5:
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(final_results)} —à—Ç.), –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω")
            logger.info("=" * 80)
            return final_results[:limit]

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 3: –°–≤–µ—Ä—Ö—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (–¥–æ–ø—É—Å–∫–∏ +50% + –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        logger.info(f"üöÄ –£–†–û–í–ï–ù–¨ 3: –†–∞—Å—à–∏—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–∏—Å–∫–∞ (+50% –∫ –¥–æ–ø—É—Å–∫–∞–º, ¬±1 –∫–æ–º–Ω–∞—Ç–∞)")
        logger.info(f"   (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(final_results)}, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5)")

        expanded_price_tolerance = price_tolerance * 1.5
        expanded_area_tolerance = area_tolerance * 1.5

        logger.info(f"   –ù–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏: —Ü–µ–Ω–∞ ¬±{expanded_price_tolerance*100:.0f}%, –ø–ª–æ—â–∞–¥—å ¬±{expanded_area_tolerance*100:.0f}%")
        logger.info(f"   –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω: {int(target_price * (1-expanded_price_tolerance)):,} - {int(target_price * (1+expanded_price_tolerance)):,} ‚ÇΩ")
        logger.info(f"   –î–∏–∞–ø–∞–∑–æ–Ω –ø–ª–æ—â–∞–¥–∏: {int(target_area * (1-expanded_area_tolerance))} - {int(target_area * (1+expanded_area_tolerance))} –º¬≤")

        # –°—Ç—Ä–æ–∏–º URL —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –¥–æ–ø—É—Å–∫–∞–º–∏ –∏ –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º –∫–æ–º–Ω–∞—Ç
        search_params_level3 = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'price_min': int(target_price * (1 - expanded_price_tolerance)),
            'price_max': int(target_price * (1 + expanded_price_tolerance)),
            'minArea': int(target_area * (1 - expanded_area_tolerance)),
            'maxArea': int(target_area * (1 + expanded_area_tolerance)),
            'region': self.region_code,
        }

        # –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
        if is_new_building:
            search_params_level3['type'] = '4'
        else:
            search_params_level3['type'] = '1'

        # –ö–æ–º–Ω–∞—Ç—ã (–û–°–õ–ê–ë–õ–ï–ù–ù–´–ô —Ñ–∏–ª—å—Ç—Ä ¬±1 –∫–æ–º–Ω–∞—Ç–∞)
        target_rooms_int = self._normalize_rooms(target_rooms) or 2
        room_params = self._get_room_filter_params(target_rooms_int, strict=False)
        search_params_level3.update(room_params)
        room_range = ', '.join([k.replace('room', '') for k in room_params.keys()])
        logger.info(f"   üè† –§–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç: {room_range}-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ (¬±1 –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)")

        url_level3 = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params_level3.items()])
        logger.info(f"   URL: {url_level3[:100]}...")

        results_level3 = self.parse_search_page(url_level3)
        logger.info(f"   ‚úì –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {len(results_level3)}")

        validated_level3 = self._validate_and_prepare_results(results_level3, limit, target_property=target_property)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
        existing_urls = {r.get('url') for r in final_results}
        new_results_level3 = [r for r in validated_level3 if r.get('url') not in existing_urls]

        final_results.extend(new_results_level3)
        logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 3: –î–æ–±–∞–≤–ª–µ–Ω–æ {len(new_results_level3)} –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤")
        logger.info("")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
        if len(final_results) >= 5:
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–Ω–∞–ª–æ–≥–æ–≤ ({len(final_results)} —à—Ç.), –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω")
            logger.info("=" * 80)
            return final_results[:limit]

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –£–†–û–í–ï–ù–¨ 4: FALLBACK –î–õ–Ø –í–°–ï–• –°–ï–ì–ú–ï–ù–¢–û–í (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫)
        # –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –í–°–ï–• —Ü–µ–Ω–æ–≤—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–º–∏—É–º
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        logger.info(f"üÜò –£–†–û–í–ï–ù–¨ 4: FALLBACK - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫")
        logger.info(f"   (—Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(final_results)}, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –º–∏–Ω–∏–º—É–º: 5)")
        logger.info(f"   –ò—â–µ–º –¢–û–õ–¨–ö–û –ø–æ —Ä–∞–π–æ–Ω—É, –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞ —Ü–µ–Ω—ã (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫)")

        # –£–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–µ–Ω—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–ª–æ—â–∞–¥—å –∏ –∫–æ–º–Ω–∞—Ç—ã
        search_params_fallback = {
            'deal_type': 'sale',
            'offer_type': 'flat',
            'engine_version': '2',
            'minArea': int(target_area * 0.5),  # –ï—â–µ —à–∏—Ä–µ: ¬±50% –ø–ª–æ—â–∞–¥—å
            'maxArea': int(target_area * 1.5),
            'region': self.region_code,
        }

        # –ö–æ–º–Ω–∞—Ç—ã (–û–°–õ–ê–ë–õ–ï–ù–ù–´–ô —Ñ–∏–ª—å—Ç—Ä ¬±1 –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ö–≤–∞—Ç–∞)
        target_rooms_int = self._normalize_rooms(target_rooms) or 2  # –¥–µ—Ñ–æ–ª—Ç 2
        room_params = self._get_room_filter_params(target_rooms_int, strict=False)
        search_params_fallback.update(room_params)
        room_range = ', '.join([k.replace('room', '') for k in room_params.keys()])
        logger.info(f"   üè† –§–∏–ª—å—Ç—Ä –∫–æ–º–Ω–∞—Ç: {room_range}-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ (¬±1 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ö–≤–∞—Ç–∞)")

        url_fallback = f"{self.base_url}/cat.php?" + '&'.join([f"{k}={v}" for k, v in search_params_fallback.items()])
        logger.info(f"   URL: {url_fallback[:100]}...")

        results_fallback = self.parse_search_page(url_fallback)
        logger.info(f"   ‚úì –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {len(results_fallback)}")

        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ª–æ–∫–∞—Ü–∏–∏ (–Ω–µ—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º)
        if target_metro or target_address:
            filtered_fallback = self._filter_by_location(results_fallback, target_property, strict=False)
            logger.info(f"   ‚úì –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ª–æ–∫–∞—Ü–∏–∏ (–Ω–µ—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º): {len(filtered_fallback)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π")
        else:
            filtered_fallback = results_fallback

        validated_fallback = self._validate_and_prepare_results(filtered_fallback, limit, target_property=target_property)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
        existing_urls = {r.get('url') for r in final_results}
        new_results_fallback = [r for r in validated_fallback if r.get('url') not in existing_urls]

        final_results.extend(new_results_fallback)
        logger.info(f"   ‚úÖ –£–†–û–í–ï–ù–¨ 4 (FALLBACK): –î–æ–±–∞–≤–ª–µ–Ω–æ {len(new_results_fallback)} –Ω–æ–≤—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤")
        logger.info("")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–û–í–û–ï: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        target_rc = target_property.get('residential_complex', '').lower().strip()
        if target_rc and len(final_results) > 0:
            # –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º target_price –∏ target_area –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–º—ã–∫–∞–Ω–∏–∏
            _target_price = target_price
            _target_area = target_area

            def sort_key(result: Dict) -> tuple[bool, float]:
                """
                –ö–ª—é—á —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏: —Å–Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–æ–≥–∏ –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö, –∑–∞—Ç–µ–º –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ —Ü–µ–Ω—ã/–º¬≤

                Returns:
                    tuple: (not same_rc, price_diff) –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                """
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ñ–ö –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏–ª–∏ –∞–¥—Ä–µ—Å–µ –∞–Ω–∞–ª–æ–≥–∞
                result_title = result.get('title', '').lower()
                result_address = result.get('address', '').lower()
                same_rc = target_rc in result_title or target_rc in result_address

                # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Ü–µ–Ω—ã –∑–∞ –º¬≤
                result_price = result.get('price') or result.get('price_raw') or 0
                result_area = result.get('total_area') or result.get('area_value') or 1
                result_price_per_sqm = result_price / result_area if result_area > 0 else 0

                target_price_per_sqm = _target_price / _target_area if _target_area > 0 else 0
                price_diff = abs(result_price_per_sqm - target_price_per_sqm) if target_price_per_sqm > 0 else float('inf')

                # –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö (False < True, –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º), –∑–∞—Ç–µ–º –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ —Ü–µ–Ω—ã
                return (not same_rc, price_diff)

            final_results.sort(key=sort_key)
            same_rc_count = sum(1 for r in final_results if target_rc in r.get('title', '').lower() or target_rc in r.get('address', '').lower())
            if same_rc_count > 0:
                logger.info(f"üèòÔ∏è –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: {same_rc_count} –∞–Ω–∞–ª–æ–≥–æ–≤ –∏–∑ —Ç–æ–≥–æ –∂–µ –ñ–ö '{target_property.get('residential_complex')}' –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ")

        # –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ _validate_and_prepare_results)
        logger.info("=" * 80)
        logger.info(f"üèÅ –ü–û–ò–°–ö –ó–ê–í–ï–†–®–ï–ù: –ù–∞–π–¥–µ–Ω–æ {len(final_results)} –∞–Ω–∞–ª–æ–≥–æ–≤")
        logger.info(f"   - –£—Ä–æ–≤–µ–Ω—å 1 (—Ä–∞–π–æ–Ω/–º–µ—Ç—Ä–æ): {len(validated_level1)} —à—Ç.")
        if new_results_level15:
            logger.info(f"   - –£—Ä–æ–≤–µ–Ω—å 1.5 (—Å–æ—Å–µ–¥–Ω–∏–µ –¥–æ–º–∞): +{len(new_results_level15)} —à—Ç.")
        logger.info(f"   - –£—Ä–æ–≤–µ–Ω—å 2 (–≥–æ—Ä–æ–¥): +{len(new_results_level2)} —à—Ç.")
        logger.info(f"   - –£—Ä–æ–≤–µ–Ω—å 3 (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π): +{len(new_results_level3)} —à—Ç.")
        if 'new_results_fallback' in locals():
            logger.info(f"   - –£—Ä–æ–≤–µ–Ω—å 4 (fallback): +{len(new_results_fallback)} —à—Ç.")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ù–û–í–û–ï: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–¥–±–æ—Ä–∞ (—Ä–∞–∑–±—Ä–æ—Å —Ü–µ–Ω –∑–∞ –º¬≤)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if len(final_results) > 0:
            prices_per_sqm = []
            for result in final_results:
                price = result.get('price') or result.get('price_raw') or 0
                area = result.get('total_area') or result.get('area_value') or 0
                if price > 0 and area > 0:
                    prices_per_sqm.append(price / area)

            if len(prices_per_sqm) > 1:
                min_price_sqm = min(prices_per_sqm)
                max_price_sqm = max(prices_per_sqm)
                avg_price_sqm = sum(prices_per_sqm) / len(prices_per_sqm)
                spread = ((max_price_sqm - min_price_sqm) / min_price_sqm) * 100

                logger.info("")
                logger.info("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–ê–ß–ï–°–¢–í–ê –ü–û–î–ë–û–†–ê:")
                logger.info(f"   - –ú–∏–Ω —Ü–µ–Ω–∞/–º¬≤: {min_price_sqm:,.0f} ‚ÇΩ")
                logger.info(f"   - –ú–∞–∫—Å —Ü–µ–Ω–∞/–º¬≤: {max_price_sqm:,.0f} ‚ÇΩ")
                logger.info(f"   - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞/–º¬≤: {avg_price_sqm:,.0f} ‚ÇΩ")
                logger.info(f"   - –†–∞–∑–±—Ä–æ—Å: {spread:.0f}%")

                if spread > 50:
                    logger.warning(f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –†–∞–∑–±—Ä–æ—Å —Ü–µ–Ω {spread:.0f}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50%!")
                    logger.warning(f"   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–æ–≥–æ–≤")
                elif spread > 30:
                    logger.warning(f"‚ö†Ô∏è –†–∞–∑–±—Ä–æ—Å —Ü–µ–Ω {spread:.0f}% —É–º–µ—Ä–µ–Ω–Ω–æ –≤—ã—Å–æ–∫–∏–π")
                else:
                    logger.info(f"‚úì –†–∞–∑–±—Ä–æ—Å —Ü–µ–Ω {spread:.0f}% –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö")

        logger.info("=" * 80)

        return final_results[:limit]
