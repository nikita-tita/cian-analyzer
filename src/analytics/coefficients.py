"""
Кластерная система коэффициентов для расчета справедливой цены
Все коэффициенты организованы по 6 кластерам
"""

# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 1: ОТДЕЛКА И СОСТОЯНИЕ
# ═══════════════════════════════════════════════════════════════════════════

# ИСПРАВЛЕНО: Реальное влияние ремонта на цену за м²
# Эконом: 18-25k (среднее 21.5k)
# Стандарт: 25-40k (среднее 32.5k) → +51% к эконому
# Капитальный: 30-52k (среднее 41k) → +90% к эконому
# Элит/Дизайнер: 52-100k+ (среднее 76k) → +253% к эконому

REPAIR_LEVEL_COEFFICIENTS = {
    'черновая': 0.75,      # Без отделки (минус затраты на ремонт)
    'эконом': 0.85,        # 18-25k за м²
    'стандартная': 1.00,   # 25-40k за м² (базовый уровень)
    'капитальная': 1.15,   # 30-52k за м² (+15% к стандарту)
    'улучшенная': 1.25,    # ~60k за м² (+25% к стандарту)
    'премиум': 1.50,       # 52-80k за м² (+50% к стандарту)
    'люкс': 1.80,          # 80-100k+ за м² (+80% к стандарту)
    'дизайнерская': 2.00,  # 100k+ за м² (индивидуальный проект)
}

HOUSE_CONDITION_COEFFICIENTS = {
    'новостройка': 1.05,
    'современное': 1.00,
    'хорошее': 0.98,
    'требует': 0.95,
    'ветхое': 0.85,
}


# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 2: ХАРАКТЕРИСТИКИ ДОМА
# ═══════════════════════════════════════════════════════════════════════════

HOUSE_TYPE_COEFFICIENTS = {
    'монолит': 1.08,
    'кирпич': 1.05,
    'панель': 0.98,
    'дерево': 0.90,
    'смешанный': 1.02,
}

ELEVATOR_COUNT_COEFFICIENTS = {
    'нет': 0.95,
    'один': 1.00,
    'два': 1.03,
    'три+': 1.05,
    'панорамный': 1.07,
}

# Высота потолков: динамический расчет
# 2.5м = 0.95, 2.7м = 1.00, 3.0м = 1.02, 3.2м+ = 1.05
def get_ceiling_height_coefficient(height: float) -> float:
    """Расчет коэффициента на основе высоты потолков"""
    if height < 2.5:
        return 0.95
    elif height < 2.7:
        return 0.95 + (height - 2.5) * 0.25  # линейно от 0.95 до 1.00
    elif height < 3.0:
        return 1.00 + (height - 2.7) * 0.067  # линейно от 1.00 до 1.02
    else:
        return min(1.05, 1.02 + (height - 3.0) * 0.015)  # до 1.05 макс

BATHROOMS_COEFFICIENTS = {
    0: 0.70,
    1: 1.00,
    2: 1.05,
    3: 1.08,
}

WINDOW_TYPE_COEFFICIENTS = {
    'деревянные': 0.85,
    'алюм': 0.90,
    'пластиковые': 1.00,
    'евро': 1.04,
    'панорамные': 1.06,
}


# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 3: ЛОКАЦИЯ И ДОСТУПНОСТЬ
# ═══════════════════════════════════════════════════════════════════════════

# УДАЛЕНО: Расстояние до метро не учитывается (сравнение в одной области)
# def get_metro_distance_coefficient(minutes: int) -> float:
#     """НЕ ИСПОЛЬЗУЕТСЯ - все аналоги в одном районе"""
#     return 1.0

DISTRICT_TYPE_COEFFICIENTS = {
    'center': 1.10,
    'near_center': 1.06,
    'residential': 1.00,
    'transitional': 0.98,
    'remote': 0.85,
}

TRANSPORT_ACCESSIBILITY_COEFFICIENTS = {
    'метро_рядом': 1.08,
    'метро_близко': 1.05,
    'доступно': 1.00,
    'транспорт': 0.95,
    'плохо': 0.80,
}

# Окружение - мультивыбор (каждый пункт добавляет)
SURROUNDINGS_COEFFICIENTS = {
    'парки': 1.02,
    'школы': 1.01,
    'торговля': 1.01,
    'офисы': 0.99,
    'промышленность': 0.95,
    'престиж': 1.03,
}


# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 4: БЕЗОПАСНОСТЬ И СЕРВИС
# ═══════════════════════════════════════════════════════════════════════════

SECURITY_LEVEL_COEFFICIENTS = {
    'нет': 0.98,
    'дневная': 1.00,
    '24/7': 1.03,
    '24/7+консьерж': 1.05,
    '24/7+консьерж+видео': 1.07,
}

PARKING_TYPE_COEFFICIENTS = {
    'нет': 0.98,
    'открытая': 1.00,
    'навес': 1.01,
    'закрытая': 1.04,
    'подземная': 1.04,
    'несколько': 1.05,
    'гараж': 1.06,
}

# УДАЛЕНО: Количество машиномест не учитывается (нет контекста сколько всего людей)
# def get_parking_spaces_bonus(spaces: int) -> float:
#     """НЕ ИСПОЛЬЗУЕТСЯ - не имеет смысла без контекста"""
#     return 1.0

# Спортивная инфраструктура - мультивыбор
SPORTS_AMENITIES_COEFFICIENTS = {
    'детская': 1.01,
    'спортплощадка': 1.02,
    'тренажер': 1.03,
    'бассейн': 1.04,
    'полный': 1.05,
}


# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 5: ВИД И ЭСТЕТИКА
# ═══════════════════════════════════════════════════════════════════════════

# ИСПРАВЛЕНО: Вид из окна влияет максимум на 5%
VIEW_TYPE_COEFFICIENTS = {
    'худогов': 0.97,       # -3% (промзона, мусорка)
    'дом': 1.00,           # Базовый уровень (стандартный двор)
    'улица': 1.00,         # То же что и двор
    'парк': 1.03,          # +3% (приятный вид)
    'вода': 1.05,          # +5% (река, море, залив)
    'город': 1.04,         # +4% (панорама города)
    'закат': 1.05,         # +5% (красивый закат)
    'премиум': 1.05,       # +5% максимум
}

# УДАЛЕНО: Шум не учитывается (сравнение в одной области)
# NOISE_LEVEL_COEFFICIENTS = {...}

# УДАЛЕНО: Людность не учитывается
# CROWDED_LEVEL_COEFFICIENTS = {...}


# ═══════════════════════════════════════════════════════════════════════════
# КЛАСТЕР 6: ИНФОРМАЦИЯ И РИСКИ
# ═══════════════════════════════════════════════════════════════════════════

PHOTO_TYPE_COEFFICIENTS = {
    'реальные': 1.00,
    'реальные+рендеры': 0.99,
    'рендеры+видео': 0.97,
    'только_рендеры': 0.95,
    'стройка': 0.98,
}

OBJECT_STATUS_COEFFICIENTS = {
    'готов': 1.02,
    'отделка': 1.00,
    'строительство': 0.98,
    'котлован': 0.96,
    'проект': 0.94,
}


# ═══════════════════════════════════════════════════════════════════════════
# ДОПОЛНИТЕЛЬНЫЕ ДИНАМИЧЕСКИЕ КОЭФФИЦИЕНТЫ
# ═══════════════════════════════════════════════════════════════════════════

def get_area_coefficient(target_area: float, avg_area: float) -> float:
    """
    Корректировка площади (применяется ВСЕГДА!)
    Если больше средней - бонус до +10%, если меньше - штраф
    """
    if avg_area <= 0:
        return 1.0

    area_ratio = target_area / avg_area
    area_coef = 1 + (area_ratio - 1) * 0.10
    # Ограничиваем диапазон: от 0.90 до 1.10
    return max(0.90, min(area_coef, 1.10))


def get_living_area_coefficient(living_area: float, total_area: float) -> float:
    """
    Коэффициент жилой площади
    > 50% - бонус до +8%
    < 30% - штраф до -8%
    """
    if not living_area or not total_area:
        return 1.0

    living_percent = (living_area / total_area) * 100

    if living_percent > 50:
        # Бонус: от 0% при 50% до +8% при 70%+
        bonus_percent = min((living_percent - 50) / 20, 1.0)
        return 1 + bonus_percent * 0.08
    elif living_percent < 30:
        # Штраф: от 0% при 30% до -8% при 10%
        penalty_percent = min((30 - living_percent) / 20, 1.0)
        return 1 - penalty_percent * 0.08
    else:
        return 1.0


def get_floor_coefficient(floor: int, total_floors: int) -> float:
    """
    Коэффициент этажа
    Средние этажи (30-70%) - бонус +4%
    Низкие (< 15%) - штраф -3%
    Высокие (> 85%) - штраф -2%
    """
    if not floor or not total_floors or total_floors < 5:
        return 1.0

    floor_ratio = floor / total_floors

    if 0.3 <= floor_ratio <= 0.7:
        return 1.04  # средние этажи
    elif floor_ratio < 0.15:
        return 0.97  # низкие этажи
    elif floor_ratio > 0.85:
        return 0.98  # высокие этажи
    else:
        return 1.0


def get_building_age_coefficient(build_year: int) -> float:
    """
    Коэффициент возраста дома
    До 10 лет - без штрафа
    Старше 10 лет - штраф до -5%
    """
    from datetime import datetime

    if not build_year:
        return 1.0

    current_year = datetime.now().year
    age = current_year - build_year

    if age <= 10:
        return 1.0
    else:
        # Штраф: -5% за каждые 100 лет
        penalty = (age - 10) / 100 * 0.05
        return max(0.95, 1 - penalty)


def get_price_liquidity_coefficient(price: float) -> float:
    """
    Коэффициент ликвидности (слишком высокая цена)
    > 150 млн - штраф -4%
    > 200 млн - штраф -6%
    > 300 млн - штраф -10%
    """
    if not price:
        return 1.0

    if price > 300_000_000:
        return 0.90
    elif price > 200_000_000:
        return 0.94
    elif price > 150_000_000:
        return 0.96
    else:
        return 1.0
