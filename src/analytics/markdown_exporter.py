"""
–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ Markdown —Ñ–æ—Ä–º–∞—Ç
"""

from typing import List, Dict, Any
from datetime import datetime
from .property_tracker import PropertyLog, PropertyTracker, EventType


class MarkdownExporter:
    """
    –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —á–∏—Ç–∞–µ–º—ã–π –∏ –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç
    """

    def __init__(self):
        pass

    def format_number(self, value: Any) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª"""
        if isinstance(value, (int, float)):
            if value > 1_000_000:
                return f"{value:,.0f} ‚ÇΩ"
            elif value > 1000:
                return f"{value:,.2f}"
            else:
                return f"{value:.4f}"
        return str(value)

    def format_price_millions(self, value: float) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö"""
        return f"{value / 1_000_000:.1f}M"

    def export_single_property(self, log: PropertyLog) -> str:
        """–≠–∫—Å–ø–æ—Ä—Ç –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ Markdown"""
        md = []

        # =========================================================================
        # –ó–ê–ì–û–õ–û–í–û–ö
        # =========================================================================
        md.append("# –û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏")
        md.append("")

        if log.url:
            md.append(f"–°—Å—ã–ª–∫–∞: [{log.url}]({log.url})")
            md.append("")

        md.append(f"–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –û–ë–™–ï–ö–¢–ï
        # =========================================================================
        md.append("## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ")
        md.append("")

        if log.property_info:
            prop = log.property_info
            md.append("### –í–∞—à –æ–±—ä–µ–∫—Ç")
            md.append("")
            md.append(f"- **–¶–µ–Ω–∞:** {self.format_number(prop.get('price', 0))}")
            md.append(f"- **–ü–ª–æ—â–∞–¥—å:** {prop.get('total_area', 0)} –º¬≤")
            if prop.get('living_area'):
                md.append(f"- **–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å:** {prop.get('living_area', 0)} –º¬≤")
            if prop.get('kitchen_area'):
                md.append(f"- **–ö—É—Ö–Ω—è:** {prop.get('kitchen_area', 0)} –º¬≤")
            md.append(f"- **–ö–æ–º–Ω–∞—Ç:** {prop.get('rooms', 0)}")
            if prop.get('floor') and prop.get('total_floors'):
                md.append(f"- **–≠—Ç–∞–∂:** {prop.get('floor')}/{prop.get('total_floors')}")
            if prop.get('address'):
                md.append(f"- **–ê–¥—Ä–µ—Å:** {prop.get('address')}")
            if prop.get('repair_level'):
                md.append(f"- **–†–µ–º–æ–Ω—Ç:** {prop.get('repair_level')}")
            md.append("")

        # –ê–Ω–∞–ª–æ–≥–∏ (–∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞)
        if log.comparables_data:
            md.append("### –ê–Ω–∞–ª–æ–≥–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è")
            md.append("")
            md.append(f"–ù–∞–π–¥–µ–Ω–æ **{len(log.comparables_data)} –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤** –≤ —Ç–æ–º –∂–µ —Ä–∞–π–æ–Ω–µ.")
            md.append("")

            # –¢–æ–ø-3 –±–ª–∏–∂–∞–π—à–∏—Ö –∞–Ω–∞–ª–æ–≥–∞
            md.append("**–¢–æ–ø-3 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–∞:**")
            md.append("")
            for i, comp in enumerate(log.comparables_data[:3], 1):
                price = self.format_number(comp.get('price', 0))
                area = comp.get('total_area', 0)
                price_sqm = self.format_number(comp.get('price_per_sqm', 0))
                rooms = comp.get('rooms', '-')
                floor = f"{comp.get('floor', '-')}/{comp.get('total_floors', '-')}"
                md.append(f"{i}. {rooms}-–∫–æ–º–Ω., {area} –º¬≤, {floor} —ç—Ç–∞–∂ - **{price}** ({price_sqm}/–º¬≤)")
            md.append("")
            md.append(f"_–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ {len(log.comparables_data)} –∞–Ω–∞–ª–æ–≥–æ–≤ —Å–º. –≤ —Ä–∞–∑–¥–µ–ª–µ \"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏\" –Ω–∏–∂–µ._")
            md.append("")

        md.append("---")
        md.append("")

        # =========================================================================
        # 1. EXECUTIVE SUMMARY - –ì–ª–∞–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∑–∞ 30 —Å–µ–∫—É–Ω–¥
        # =========================================================================
        md.append("## –ì–ª–∞–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã")
        md.append("")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        current_price = log.property_info.get('price', 0) if log.property_info else 0
        fair_price = log.fair_price_result.get('fair_price_total', 0) if log.fair_price_result else current_price
        price_diff = log.fair_price_result.get('price_diff_percent', 0) if log.fair_price_result else 0
        is_overpriced = log.fair_price_result.get('is_overpriced', False) if log.fair_price_result else False
        is_underpriced = log.fair_price_result.get('is_underpriced', False) if log.fair_price_result else False
        is_fair = log.fair_price_result.get('is_fair', False) if log.fair_price_result else False

        expected_time = log.time_forecast.get('expected_time_months', 0) if hasattr(log, 'time_forecast') and log.time_forecast else 3
        time_range = log.time_forecast.get('time_range_description', '2-4 –º–µ—Å—è—Ü–∞') if hasattr(log, 'time_forecast') and log.time_forecast else '2-4 –º–µ—Å—è—Ü–∞'

        attractiveness = log.attractiveness_index.get('total_index', 0) if hasattr(log, 'attractiveness_index') and log.attractiveness_index else 0
        attr_category = log.attractiveness_index.get('category', '–°—Ä–µ–¥–Ω—è—è') if hasattr(log, 'attractiveness_index') and log.attractiveness_index else '–°—Ä–µ–¥–Ω—è—è'

        # –°—Ç–∞—Ç—É—Å —Ü–µ–Ω—ã
        if is_fair:
            price_status = f"**–¶–µ–Ω–∞ –°–ü–†–ê–í–ï–î–õ–ò–í–ê–Ø** (–≤ —Ä—ã–Ω–æ—á–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ, {price_diff:+.1f}%)"
        elif is_overpriced:
            price_status = f"**–¶–µ–Ω–∞ –ó–ê–í–´–®–ï–ù–ê** –Ω–∞ {abs(price_diff):.1f}%"
        elif is_underpriced:
            price_status = f"**–¶–µ–Ω–∞ –ó–ê–ù–ò–ñ–ï–ù–ê** –Ω–∞ {abs(price_diff):.1f}%"
        else:
            price_status = "–¶–µ–Ω–∞ –±–ª–∏–∑–∫–∞ –∫ —Ä—ã–Ω–æ—á–Ω–æ–π"

        md.append(f"**–í–∞—à–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞:**")
        md.append(f"- {price_status}")
        md.append(f"- –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Ü–µ–Ω–∞: {self.format_price_millions(fair_price)} ({self.format_number(fair_price)})")
        md.append(f"- –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {self.format_price_millions(current_price)} ({self.format_number(current_price)})")
        md.append(f"- –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂–∏: {time_range}")
        md.append(f"- –ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {attractiveness:.0f}/100 ({attr_category})")
        md.append("")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        md.append("**–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:**")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1 - –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–Ω—ã
        if is_overpriced and abs(price_diff) > 5:
            md.append(f"1. **–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É** –¥–æ {self.format_price_millions(fair_price)} –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π")
        elif is_underpriced and abs(price_diff) > 5:
            md.append(f"1. **–ú–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Ü–µ–Ω—É** –¥–æ {self.format_price_millions(fair_price)} –±–µ–∑ —Ä–∏—Å–∫–∞ –ø–æ—Ç–µ—Ä—è—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π")
        else:
            md.append("1. **–¶–µ–Ω–∞ —Ö–æ—Ä–æ—à–∞—è** - –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2 - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
        md.append("2. **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** - –±–µ–∑ –Ω–∏—Ö —Ç–µ—Ä—è–µ—Ç–µ 60% –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –µ—â–µ –¥–æ –ø–æ–∫–∞–∑–∞")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3 - –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if attractiveness < 60:
            md.append("3. **–£—Å–∏–ª–∏—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ** - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –≤—ã—Å–æ–∫–∞—è, –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞")
        else:
            md.append("3. **–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å 2-3 –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞** –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è")

        md.append("")

        # –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ RecommendationEngine
        if hasattr(log, 'recommendations') and log.recommendations:
            md.append("")
            md.append("### üí° –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
            md.append("")
            md.append("–ù–∞ –æ—Å–Ω–æ–≤–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞:")
            md.append("")

            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
            priorities = {
                1: {'label': 'üî¥ –ö–†–ò–¢–ò–ß–ù–û', 'recs': []},
                2: {'label': 'üü† –í–ê–ñ–ù–û', 'recs': []},
                3: {'label': 'üü° –†–ï–ö–û–ú–ï–ù–î–£–ï–ú', 'recs': []},
                4: {'label': 'üîµ –°–û–í–ï–¢', 'recs': []}
            }

            for rec in log.recommendations:
                priority = rec.get('priority', 4)
                if priority in priorities:
                    priorities[priority]['recs'].append(rec)

            # –í—ã–≤–æ–¥–∏–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
            for priority in [1, 2, 3, 4]:
                recs = priorities[priority]['recs']
                if recs:
                    md.append(f"**{priorities[priority]['label']}**")
                    md.append("")
                    for rec in recs:
                        icon = rec.get('icon', 'üí°')
                        title = rec.get('title', '')
                        summary = rec.get('summary', '')
                        message = rec.get('message', '')
                        action = rec.get('action', '')
                        expected_result = rec.get('expected_result', '')
                        roi = rec.get('roi', 0)
                        financial_impact = rec.get('financial_impact', {})
                        category = rec.get('category', '')

                        md.append(f"**{icon} {title}**")

                        # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                        if summary:
                            md.append(f"> {summary}")
                            md.append("")

                        # –î–µ—Ç–∞–ª–∏
                        if message:
                            # –î–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
                            if '\n' in message:
                                md.append("**–î–µ—Ç–∞–ª–∏:**")
                                for line in message.split('\n'):
                                    md.append(f"{line}")
                            else:
                                md.append(f"- {message}")

                        # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
                        if financial_impact:
                            md.append("")
                            md.append("**–§–∏–Ω–∞–Ω—Å—ã:**")

                            # –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ improvement (—Ä–µ–º–æ–Ω—Ç) - –≤—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü–µ–π
                            if category == 'improvement' and len(financial_impact) > 3:
                                md.append("")
                                md.append("| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |")
                                md.append("|----------|----------|")
                                for key, value in financial_impact.items():
                                    md.append(f"| {key} | {value} |")
                            else:
                                # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - —Å–ø–∏—Å–∫–æ–º
                                for key, value in financial_impact.items():
                                    md.append(f"- {key}: {value}")

                        # –î–µ–π—Å—Ç–≤–∏–µ
                        if action:
                            md.append("")
                            md.append(f"**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:** {action}")

                        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        if expected_result:
                            md.append(f"**–†–µ–∑—É–ª—å—Ç–∞—Ç:** {expected_result}")

                        # ROI –µ—Å–ª–∏ –µ—Å—Ç—å –∏ –Ω–µ –≤ financial_impact
                        if roi and roi != 0 and 'ROI' not in str(financial_impact):
                            md.append(f"**ROI:** {roi:.0f}%")

                        md.append("")
                        md.append("---")
                        md.append("")

        md.append("–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ \"–ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂–∏\" –Ω–∏–∂–µ.")
        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # 2. –†–´–ù–û–ß–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ - –ì–¥–µ –≤—ã –Ω–∞ —Ä—ã–Ω–∫–µ
        # =========================================================================
        md.append("## –í–∞—à –æ–±—ä–µ–∫—Ç –Ω–∞ —Ñ–æ–Ω–µ —Ä—ã–Ω–∫–∞")
        md.append("")

        # –†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        comparables_count = len(log.comparables_data) if log.comparables_data else 0
        median_price_sqm = 0

        if log.market_stats:
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: –≤–ª–æ–∂–µ–Ω–Ω—ã–π 'all' –∏–ª–∏ –ø—Ä—è–º—ã–µ –ø–æ–ª—è
            if 'all' in log.market_stats:
                all_stats = log.market_stats['all']
                median_price_sqm = all_stats.get('median', 0)
                mean_price_sqm = all_stats.get('mean', 0)
            else:
                # Fallback –¥–ª—è –ø—Ä—è–º—ã—Ö –ø–æ–ª–µ–π
                median_price_sqm = log.market_stats.get('median_price_per_sqm', 0)
                mean_price_sqm = log.market_stats.get('mean_price_per_sqm', 0)

        your_price_sqm = current_price / log.property_info.get('total_area', 50) if log.property_info and current_price > 0 else 0

        md.append("**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –≤–∞—à–µ–º —Ä–∞–π–æ–Ω–µ:**")
        md.append(f"- –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤: {self.format_number(median_price_sqm)} (—Ä—ã–Ω–æ—á–Ω–∞—è –º–µ–¥–∏–∞–Ω–∞)")
        if your_price_sqm > 0:
            diff_from_market = ((your_price_sqm - median_price_sqm) / median_price_sqm * 100) if median_price_sqm > 0 else 0
            if abs(diff_from_market) < 3:
                md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ –∑–∞ –º¬≤: {self.format_number(your_price_sqm)} (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä—ã–Ω–∫—É)")
            elif diff_from_market > 0:
                md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ –∑–∞ –º¬≤: {self.format_number(your_price_sqm)} (–Ω–∞ {diff_from_market:.1f}% –≤—ã—à–µ —Ä—ã–Ω–∫–∞)")
            else:
                md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ –∑–∞ –º¬≤: {self.format_number(your_price_sqm)} (–Ω–∞ {abs(diff_from_market):.1f}% –Ω–∏–∂–µ —Ä—ã–Ω–∫–∞ - —Ö–æ—Ä–æ—à–∏–π —à–∞–Ω—Å –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–¥–∞—Ç—å)")

        md.append(f"- –ü–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø—Ä–æ–¥–∞–∂–µ: {comparables_count}")
        md.append(f"- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏: {expected_time:.1f} –º–µ—Å—è—Ü–∞")
        md.append("")

        # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
        md.append("**–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è:**")

        if is_underpriced and abs(price_diff) > 3:
            md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ –ù–ò–ñ–ï –º–µ–¥–∏–∞–Ω—ã –Ω–∞ {abs(price_diff):.1f}% - –æ—Ç–ª–∏—á–Ω—ã–π —à–∞–Ω—Å –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–¥–∞—Ç—å")
            md.append(f"- –ü—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ –æ–∂–∏–¥–∞–π—Ç–µ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π")
        elif is_overpriced and abs(price_diff) > 5:
            md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ –í–´–®–ï –º–µ–¥–∏–∞–Ω—ã –Ω–∞ {abs(price_diff):.1f}% - —Ä–∏—Å–∫ –¥–æ–ª–≥–æ–π –ø—Ä–æ–¥–∞–∂–∏")
            md.append(f"- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è —Å {comparables_count} –æ–±—ä–µ–∫—Ç–∞–º–∏ - –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å")
        else:
            md.append(f"- –í–∞—à–∞ —Ü–µ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä—ã–Ω–∫—É - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ {time_range}")
            md.append(f"- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è —É–º–µ—Ä–µ–Ω–Ω–∞—è ({comparables_count} –æ–±—ä–µ–∫—Ç–æ–≤)")

        md.append("")

        # –ò–Ω—Å–∞–π—Ç
        if comparables_count > 20:
            md.append(f"> **–ò–Ω—Å–∞–π—Ç:** –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è ({comparables_count} –æ–±—ä–µ–∫—Ç–æ–≤) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω—ã.")
            md.append("> –ö–ª—é—á –∫ —É—Å–ø–µ—Ö—É: –≤—ã–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏.")
        elif comparables_count < 10:
            md.append(f"> **–ò–Ω—Å–∞–π—Ç:** –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è ({comparables_count} –æ–±—ä–µ–∫—Ç–æ–≤) - —É –≤–∞—Å —Ö–æ—Ä–æ—à–∏–µ —à–∞–Ω—Å—ã –ø—Ä–∏–≤–ª–µ—á—å –≤–Ω–∏–º–∞–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π.")
            md.append("> –í–∞–∂–Ω–æ: –Ω–µ –∑–∞–≤—ã—à–∞—Ç—å —Ü–µ–Ω—É, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—É–≥–Ω—É—Ç—å —Ä–µ–¥–∫–∏—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –≤ –≤–∞—à–µ–º —Å–µ–≥–º–µ–Ω—Ç–µ.")

        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # 3. –í–ê–®–ê –°–ò–¢–£–ê–¶–ò–Ø - –†–∏—Å–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
        # =========================================================================
        md.append("## –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å –ø—Ä–æ–¥–∞–∂–µ –∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å")
        md.append("")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∏—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
        risks = []
        opportunities = []

        # –†–∏—Å–∫ 1: –¶–µ–Ω–∞
        if is_overpriced and abs(price_diff) > 5:
            risks.append({
                'title': '–ó–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞',
                'description': f'–ü—Ä–∏ —Ü–µ–Ω–µ –Ω–∞ {abs(price_diff):.1f}% –≤—ã—à–µ —Ä—ã–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂–∞ –∑–∞–π–º–µ—Ç {expected_time:.0f}+ –º–µ—Å—è—Ü–µ–≤. –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç "–¥–æ–ª–≥–æ –≤–∏—Å–∏—Ç" –∏ –±—É–¥—É—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å—Å—è.',
                'solution': f'–°–Ω–∏–∑–∏—Ç—å –¥–æ {self.format_price_millions(fair_price)} –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π'
            })

        # –†–∏—Å–∫ 2: –ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        if attractiveness < 60:
            risks.append({
                'title': '–ù–∏–∑–∫–∞—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞',
                'description': f'–ò–Ω–¥–µ–∫—Å {attractiveness:.0f}/100 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–±—ä–µ–∫—Ç –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.',
                'solution': '–ö–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π: –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä, –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞'
            })

        # –†–∏—Å–∫ 3: –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (–≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª–µ–Ω)
        risks.append({
            'title': '–ü–ª–æ—Ö–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
            'description': '–ë–µ–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –∏ –ø—Ä–æ–¥–∞—é—â–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Ä—è–µ—Ç–µ 60% –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞.',
            'solution': '–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å 5,000-10,000‚ÇΩ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ñ–æ—Ç–æ—Å—ä–µ–º–∫—É (–æ–∫—É–ø–∏—Ç—Å—è —Ü–µ–Ω–æ–π)'
        })

        # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 1: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞
        if is_underpriced or (is_fair and attractiveness > 70):
            fast_price = current_price * 0.95
            opportunities.append({
                'title': '–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ (1-2 –º–µ—Å—è—Ü–∞)',
                'description': f'–ü—Ä–∏ —Ü–µ–Ω–µ {self.format_price_millions(fast_price)} —Å –∞–∫—Ç–∏–≤–Ω—ã–º –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –∑–∞ 3-4 –Ω–µ–¥–µ–ª–∏.',
                'benefit': '–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏, –±—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ–Ω–µ–≥'
            })

        # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å 2: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
        if hasattr(log, 'price_range') and log.price_range:
            max_price = log.price_range.get('max_price', 0)
            if max_price > fair_price * 1.03:
                opportunities.append({
                    'title': '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞',
                    'description': f'–ü—Ä–∏ –∏–¥–µ–∞–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–∫–∞–∑–∞–º, –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ) –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –∑–∞ {self.format_price_millions(max_price)}.',
                    'benefit': f'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ +{self.format_price_millions(max_price - current_price)}'
                })

        # –í—ã–≤–æ–¥–∏–º —Ä–∏—Å–∫–∏
        if risks:
            md.append("**–í–∞—à–∏ —Ä–∏—Å–∫–∏:**")
            md.append("")
            for i, risk in enumerate(risks, 1):
                md.append(f"{i}. **{risk['title']}**")
                md.append(f"   - –ü—Ä–æ–±–ª–µ–º–∞: {risk['description']}")
                md.append(f"   - –†–µ—à–µ–Ω–∏–µ: {risk['solution']}")
                md.append("")

        # –í—ã–≤–æ–¥–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
        if opportunities:
            md.append("**–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**")
            md.append("")
            for i, opp in enumerate(opportunities, 1):
                md.append(f"{i}. **{opp['title']}**")
                md.append(f"   - {opp['description']}")
                md.append(f"   - –í—ã–≥–æ–¥–∞: {opp['benefit']}")
                md.append("")

        md.append("---")
        md.append("")

        # =========================================================================
        # 4. –ü–°–ò–•–û–õ–û–ì–ò–Ø –ü–û–ö–£–ü–ê–¢–ï–õ–Ø
        # =========================================================================
        md.append("## –ö—Ç–æ –ø–æ–∫—É–ø–∞–µ—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –≤–∞—à–µ–º —Å–µ–≥–º–µ–Ω—Ç–µ")
        md.append("")

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        rooms = log.property_info.get('rooms', 2) if log.property_info else 2
        area = log.property_info.get('total_area', 50) if log.property_info else 50

        # –ü—Ä–æ—Ñ–∏–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–Ω—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        if current_price < 15_000_000:
            buyer_profile = "–ú–æ–ª–æ–¥—ã–µ —Å–µ–º—å–∏, –ø–µ—Ä–≤–æ–µ –∂–∏–ª—å–µ –∏–ª–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è"
            income = "200-300k/–º–µ—Å"
            priorities = ["–¶–µ–Ω–∞", "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—à–∫–æ–ª—ã, —Å–∞–¥—ã)", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å"]
        elif current_price < 30_000_000:
            buyer_profile = "–°–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏, —É–ª—É—á—à–µ–Ω–∏–µ –∂–∏–ª–∏—â–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"
            income = "300-500k/–º–µ—Å"
            priorities = ["–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞", "–†–∞–π–æ–Ω –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–ü–∞—Ä–∫–æ–≤–∫–∞"]
        else:
            buyer_profile = "–°–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–µ —Å–µ–º—å–∏, –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç"
            income = "500k+/–º–µ—Å"
            priorities = ["–ü—Ä–µ—Å—Ç–∏–∂ —Ä–∞–π–æ–Ω–∞", "–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–¥–µ–ª–∫–∏", "–í–∏–¥—ã –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ"]

        md.append(f"**–¢–∏–ø–∏—á–Ω—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å:**")
        md.append(f"- –ü—Ä–æ—Ñ–∏–ª—å: {buyer_profile}")
        md.append(f"- –î–æ—Ö–æ–¥: {income}")
        md.append(f"- –í—Ä–µ–º—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è: 2-4 –Ω–µ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞")
        md.append("")

        md.append("**–ß—Ç–æ –∏—Ö –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç:**")
        for priority in priorities:
            md.append(f"- {priority}")
        md.append("- –°–≤–µ—Ç–ª—ã–µ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–µ–±—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ)")
        md.append("- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤—ã–≥–æ–¥—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏: \"5 –º–∏–Ω—É—Ç –¥–æ –º–µ—Ç—Ä–æ\" –≤–º–µ—Å—Ç–æ \"—Ö–æ—Ä–æ—à–∞—è –ª–æ–∫–∞—Ü–∏—è\"")
        md.append("- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä (–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å \"–ø—Ä–æ–≥—É–ª—è—Ç—å—Å—è\" –¥–æ –ø–æ–∫–∞–∑–∞)")
        md.append("")

        md.append("**–ß—Ç–æ –∏—Ö –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç:**")
        md.append("- –¢–µ–º–Ω—ã–µ –∏–ª–∏ –ø–ª–æ—Ö–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏)")
        md.append("- –û–±—â–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π")
        md.append("- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∑–≤–æ–Ω–∏—Ç—å –≤—ã—è—Å–Ω—è—Ç—å)")
        md.append("- –ó–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–≤–∏–¥—è—Ç \"–¥–æ–ª–≥–æ –≤–∏—Å–∏—Ç\" –∏ –Ω–∞—á–∏–Ω–∞—é—Ç –ø–æ–¥–æ–∑—Ä–µ–≤–∞—Ç—å)")
        md.append("")

        md.append("> **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:** –°–¥–µ–ª–∞–π—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.")
        md.append("> –ù–µ \"2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è, 50–º¬≤, 5 —ç—Ç–∞–∂\", –∞ \"–°–≤–µ—Ç–ª–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –¥–ª—è —Å–µ–º—å–∏: —Ç–∏—Ö–∏–π –¥–≤–æ—Ä, 2 –º–∏–Ω—É—Ç—ã –¥–æ –ø–∞—Ä–∫–∞, —Å–≤–µ–∂–∏–π —Ä–µ–º–æ–Ω—Ç\".")
        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # 5. –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô - –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω
        # =========================================================================
        md.append("## –ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂–∏ (–ø–æ—à–∞–≥–æ–≤–æ)")
        md.append("")
        md.append("–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏.")
        md.append("")

        md.append("### –ù–µ–¥–µ–ª—è 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)")
        md.append("")
        md.append("**–î–µ–Ω—å 1-2: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–æ—Ç–æ—Å—ä–µ–º–∫–∞**")
        md.append("- –°—Ç–æ–∏–º–æ—Å—Ç—å: 5,000-8,000‚ÇΩ")
        md.append("- –≠—Ñ—Ñ–µ–∫—Ç: +60% –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏—è")
        md.append("- –ß—Ç–æ —Å–Ω–∏–º–∞—Ç—å: –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –¥–Ω–µ–≤–Ω–æ–º —Å–≤–µ—Ç–µ, 2-3 —Ä–∞–∫—É—Ä—Å–∞ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É, –≤–∏–¥—ã –∏–∑ –æ–∫–æ–Ω")
        md.append("")

        md.append("**–î–µ–Ω—å 2-3: –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞—é—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**")
        md.append("- –ù–∞—á–Ω–∏—Ç–µ —Å –≥–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–ª–æ–∫–∞—Ü–∏—è/—Ä–µ–º–æ–Ω—Ç/–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞)")
        md.append("- –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤—ã–≥–æ–¥—ã: \"3 –º–∏–Ω—É—Ç—ã –¥–æ –º–µ—Ç—Ä–æ\", \"—Ç–∏—Ö–∏–π –¥–≤–æ—Ä –±–µ–∑ –º–∞—à–∏–Ω\"")
        md.append("- –£–∫–∞–∂–∏—Ç–µ, –¥–ª—è –∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç: \"–∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏\" –∏–ª–∏ \"–æ—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ø–µ—Ä–≤–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã\"")
        md.append("")

        md.append("**–î–µ–Ω—å 3-4: –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**")
        md.append("- –°—Ç–æ–∏–º–æ—Å—Ç—å: 3,000-5,000‚ÇΩ")
        md.append("- –≠—Ñ—Ñ–µ–∫—Ç: –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ –ø–æ–∫–∞–∑ —É–∂–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–º–∏")
        md.append("")

        md.append("### –ù–µ–¥–µ–ª—è 2: –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ")
        md.append("")
        md.append("**–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö –ø–ª–æ—â–∞–¥–∫–∞—Ö:**")
        md.append("- –¶–ò–ê–ù (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!) - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π")
        md.append("- –ê–≤–∏—Ç–æ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ö–≤–∞—Ç")
        md.append("- –õ–æ–∫–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ/Telegram –≤ –≤–∞—à–µ–º —Ä–∞–π–æ–Ω–µ")
        md.append("")

        md.append("**–í–∫–ª—é—á–∏—Ç—å –ø–ª–∞—Ç–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ:**")
        md.append("- –ü–æ–¥–Ω—è—Ç–∏–µ –≤ —Ç–æ–ø –Ω–∞ –¶–ò–ê–ù: 300-500‚ÇΩ/–¥–µ–Ω—å")
        md.append("- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤ 3-5 —Ä–∞–∑ –±–æ–ª—å—à–µ –∑–≤–æ–Ω–∫–æ–≤")
        md.append("- –ë—é–¥–∂–µ—Ç: 10,000-15,000‚ÇΩ –Ω–∞ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü")
        md.append("")

        md.append("**–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏:**")
        md.append("- –¶–µ–ª—å: –º–∏–Ω–∏–º—É–º 50 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –¥–µ–Ω—å")
        md.append("- –ï—Å–ª–∏ –º–µ–Ω—å—à–µ: —É–ª—É—á—à–∏—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—É –Ω–∞ 3-5%")
        md.append("")

        md.append("### –ù–µ–¥–µ–ª—è 3-4: –ü–æ–∫–∞–∑—ã –∏ —Ä–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏")
        md.append("")
        md.append("**–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –ø–æ–∫–∞–∑–∞–º:**")
        md.append("- –ß–∏—Å—Ç–æ—Ç–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ (–æ—á–µ–≤–∏–¥–Ω–æ, –Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ)")
        md.append("- –ü—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º")
        md.append("- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–∏–ø–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:")
        md.append("  - \"–ü–æ—á–µ–º—É –ø—Ä–æ–¥–∞–µ—Ç–µ?\" ‚Üí —á–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (–ø–µ—Ä–µ–µ–∑–¥/—É–ª—É—á—à–µ–Ω–∏–µ)")
        md.append("  - \"–ö–∞–∫–∏–µ —Å–æ—Å–µ–¥–∏?\" ‚Üí –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ-–ø–æ–∑–∏—Ç–∏–≤–Ω–æ")
        md.append("  - \"–¢–æ—Ä–≥ –≤–æ–∑–º–æ–∂–µ–Ω?\" ‚Üí –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É")
        md.append("")

        md.append("**–î–æ–∫—É–º–µ–Ω—Ç—ã –¥–µ—Ä–∂–∏—Ç–µ –Ω–∞–≥–æ—Ç–æ–≤–µ:**")
        md.append("- –í—ã–ø–∏—Å–∫–∞ –∏–∑ –ï–ì–†–ù (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–∏–π)")
        md.append("- –°—á–µ—Ç–∞ –ñ–ö–• (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–æ–ª–≥–æ–≤)")
        md.append("- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∞—Å–ø–æ—Ä—Ç")
        md.append("")

        md.append("### –ù–µ–¥–µ–ª—è 4+: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏")
        md.append("")
        md.append("**–ï—Å–ª–∏ –ø–æ—Å–ª–µ 5-7 –ø–æ–∫–∞–∑–æ–≤ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:**")
        md.append("- –°–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å: —á—Ç–æ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º?")
        md.append("- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω–∏ —É–ª—É—á—à–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
        md.append("- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –Ω–∞ 3-5%")
        md.append("")

        md.append("**–ü–æ–ª—É—á–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**")
        md.append("- –ù–µ —Å–æ–≥–ª–∞—à–∞–π—Ç–µ—Å—å –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ (–¥–∞–∂–µ –µ—Å–ª–∏ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç)")
        md.append("- –í–æ–∑—å–º–∏—Ç–µ 1-2 –¥–Ω—è –ø–æ–¥—É–º–∞—Ç—å - –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Ü–µ–Ω–∏—Ç—å –±–æ–ª—å—à–µ")
        md.append("- –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É 50,000-100,000‚ÇΩ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏")
        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # 6. –°–¶–ï–ù–ê–†–ò–ò –ü–†–û–î–ê–ñ–ò - 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞
        # =========================================================================
        md.append("## –°—Ü–µ–Ω–∞—Ä–∏–∏: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é")
        md.append("")

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        fast_price = fair_price * 0.95  # -5% –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏
        optimal_price = fair_price
        premium_price = fair_price * 1.05  # +5% –¥–ª—è –ø—Ä–µ–º–∏—É–º

        md.append("### –°—Ü–µ–Ω–∞—Ä–∏–π A: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ (1-2 –º–µ—Å—è—Ü–∞)")
        md.append("")
        md.append("**–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:**")
        md.append(f"- –¶–µ–Ω–∞: {self.format_price_millions(fast_price)} ({self.format_number(fast_price)})")
        md.append("- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ + –æ–ø–∏—Å–∞–Ω–∏–µ")
        md.append("- –ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ (–¶–ò–ê–ù —Ç–æ–ø + –ê–≤–∏—Ç–æ)")
        md.append("- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–æ–∫–∞–∑–∞–º –≤ –ª—é–±–æ–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è")
        md.append("")

        md.append("**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**")
        md.append("- 1-2 –Ω–µ–¥–µ–ª–∏: 10-15 –ø–æ–∫–∞–∑–æ–≤")
        md.append("- 3-4 –Ω–µ–¥–µ–ª–∏: 2-3 —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
        md.append("- 6-8 –Ω–µ–¥–µ–ª—å: —Å–¥–µ–ª–∫–∞")
        md.append("")

        md.append("**–§–∏–Ω–∞–Ω—Å—ã:**")
        md.append(f"- –í—ã—Ä—É—á–∫–∞: {self.format_number(fast_price)}")
        md.append("- –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É: ~10,000‚ÇΩ (—Ñ–æ—Ç–æ)")
        md.append(f"- –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞: ~{self.format_number(fast_price - 10000)}")
        md.append("")

        md.append("---")
        md.append("")

        md.append("### –°—Ü–µ–Ω–∞—Ä–∏–π B: –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ (2-3 –º–µ—Å—è—Ü–∞) - –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø")
        md.append("")
        md.append("**–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:**")
        md.append(f"- –¶–µ–Ω–∞: {self.format_price_millions(optimal_price)} ({self.format_number(optimal_price)})")
        md.append("- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ + –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç—É—Ä")
        md.append("- –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –ø–ª–æ—â–∞–¥–∫–∞—Ö")
        md.append("- –ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑–æ–≤")
        md.append("")

        md.append("**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**")
        md.append("- 3-4 –Ω–µ–¥–µ–ª–∏: 15-20 –ø–æ–∫–∞–∑–æ–≤")
        md.append("- 6-8 –Ω–µ–¥–µ–ª—å: 3-4 —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
        md.append(f"- 10-12 –Ω–µ–¥–µ–ª—å: —Å–¥–µ–ª–∫–∞ –ø–æ {self.format_price_millions(optimal_price * 0.98)}-{self.format_price_millions(optimal_price)}")
        md.append("")

        md.append("**–§–∏–Ω–∞–Ω—Å—ã:**")
        md.append(f"- –í—ã—Ä—É—á–∫–∞: {self.format_number(optimal_price)} (—Å—Ä–µ–¥–Ω—è—è)")
        md.append("- –†–∞—Å—Ö–æ–¥—ã: ~20,000‚ÇΩ (—Ñ–æ—Ç–æ + —Ç—É—Ä + –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ)")
        md.append(f"- –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞: ~{self.format_number(optimal_price - 20000)}")
        md.append(f"- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ +{self.format_number(optimal_price - fast_price)} –∫ —Å—Ü–µ–Ω–∞—Ä–∏—é –ê!")
        md.append("")

        md.append("---")
        md.append("")

        md.append("### –°—Ü–µ–Ω–∞—Ä–∏–π C: –ü—Ä–µ–º–∏—É–º –ø—Ä–æ–¥–∞–∂–∞ (3-6 –º–µ—Å—è—Ü–µ–≤)")
        md.append("")
        md.append("**–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:**")
        md.append(f"- –¶–µ–Ω–∞: {self.format_price_millions(premium_price)} ({self.format_number(premium_price)})")
        md.append("- VIP-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—ä–µ–º–∫–∞ + –≤–∏–¥–µ–æ + –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–∫–∞–∑–∞–º")
        md.append("- –†–∞–±–æ—Ç–∞ —Å —Ä–∏–µ–ª—Ç–æ—Ä–æ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π")
        md.append("- –¢–µ—Ä–ø–µ–Ω–∏–µ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–æ–ª–≥–æ–º—É –ø–æ–∏—Å–∫—É \"—Å–≤–æ–µ–≥–æ\" –ø–æ–∫—É–ø–∞—Ç–µ–ª—è")
        md.append("")

        md.append("**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**")
        md.append("- 2-3 –º–µ—Å—è—Ü–∞: 20-30 –ø–æ–∫–∞–∑–æ–≤")
        md.append("- 4-5 –º–µ—Å—è—Ü–µ–≤: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç –ø–ª–∞—Ç–µ–∂–µ—Å–ø–æ—Å–æ–±–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π")
        md.append(f"- 5-6 –º–µ—Å—è—Ü–µ–≤: —Å–¥–µ–ª–∫–∞ –ø–æ {self.format_price_millions(premium_price * 0.97)}-{self.format_price_millions(premium_price)}")
        md.append("")

        md.append("**–§–∏–Ω–∞–Ω—Å—ã:**")
        md.append(f"- –í—ã—Ä—É—á–∫–∞: {self.format_number(premium_price)} (–æ–∂–∏–¥–∞–µ–º–∞—è)")
        md.append("- –†–∞—Å—Ö–æ–¥—ã: ~40,000‚ÇΩ (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ + —Å—ä–µ–º–∫–∞ + —Ä–∏–µ–ª—Ç–æ—Ä)")
        md.append(f"- –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞: ~{self.format_number(premium_price - 40000)}")
        md.append(f"- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** +{self.format_number(premium_price - fast_price)} –∫ —Å—Ü–µ–Ω–∞—Ä–∏—é –ê")
        md.append("")

        md.append("**–†–∏—Å–∫–∏:**")
        md.append("- –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å 6+ –º–µ—Å—è—Ü–µ–≤")
        md.append("- –†—ã–Ω–æ–∫ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è")
        md.append("- –£–ø—É—â–µ–Ω–Ω–∞—è –≤—ã–≥–æ–¥–∞ –æ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–µ–Ω–µ–≥")
        md.append("")

        md.append("> **–ù–∞—à–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°—Ü–µ–Ω–∞—Ä–∏–π B - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ü–µ–Ω—ã, –≤—Ä–µ–º–µ–Ω–∏ –∏ —É—Å–∏–ª–∏–π.")
        md.append("")
        md.append("---")
        md.append("")

        # =========================================================================
        # 7. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò (collapsible)
        # =========================================================================
        md.append("## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞")
        md.append("")
        md.append("–≠—Ç–∞ —Å–µ–∫—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—á–µ—Ç–∞—Ö –∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.")
        md.append("")

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ
        md.append("<details>")
        md.append("<summary><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ</strong> (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>")
        md.append("")

        if log.property_info:
            info = log.property_info
            md.append("| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |")
            md.append("|----------|----------|")
            if 'price' in info:
                md.append(f"| –¶–µ–Ω–∞ | {self.format_number(info['price'])} |")
            if 'total_area' in info:
                md.append(f"| –ü–ª–æ—â–∞–¥—å | {info['total_area']} –º¬≤ |")
            if 'rooms' in info:
                md.append(f"| –ö–æ–º–Ω–∞—Ç | {info['rooms']} |")
            if 'floor' in info and 'total_floors' in info:
                md.append(f"| –≠—Ç–∞–∂ | {info['floor']} –∏–∑ {info['total_floors']} |")
            if 'address' in info:
                md.append(f"| –ê–¥—Ä–µ—Å | {info['address']} |")

        md.append("")
        md.append("</details>")
        md.append("")

        # –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏
        if log.comparables_data:
            md.append("<details>")
            md.append(f"<summary><strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏</strong> ({len(log.comparables_data)} –æ–±—ä–µ–∫—Ç–æ–≤)</summary>")
            md.append("")

            md.append("| ‚Ññ | –¶–µ–Ω–∞ | –ü–ª–æ—â–∞–¥—å | –¶–µ–Ω–∞ –∑–∞ –º¬≤ | –ê–¥—Ä–µ—Å |")
            md.append("|---|------|---------|-----------|--------|")

            for i, comp in enumerate(log.comparables_data[:20], 1):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-20
                price = self.format_number(comp.get('price', 0))
                area = comp.get('total_area', 0)
                price_sqm = self.format_number(comp.get('price_per_sqm', 0))
                address = comp.get('address', '')[:50] + '...' if len(comp.get('address', '')) > 50 else comp.get('address', '-')
                md.append(f"| {i} | {price} | {area} –º¬≤ | {price_sqm} | {address} |")

            if len(log.comparables_data) > 20:
                md.append(f"| ... | _(–µ—â—ë {len(log.comparables_data) - 20})_ | | | |")

            md.append("")
            md.append("</details>")
            md.append("")

        # –†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if log.market_stats:
            md.append("<details>")
            md.append("<summary><strong>–†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong></summary>")
            md.append("")

            stats = log.market_stats
            if 'all' in stats:
                all_stats = stats['all']
                md.append("**–í—Å–µ –∞–Ω–∞–ª–æ–≥–∏:**")
                md.append("")
                md.append(f"- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {all_stats.get('count', 0)}")
                md.append(f"- –ú–µ–¥–∏–∞–Ω–∞ —Ü–µ–Ω—ã –∑–∞ –º¬≤: {self.format_number(all_stats.get('median', 0))}")
                md.append(f"- –°—Ä–µ–¥–Ω–µ–µ: {self.format_number(all_stats.get('mean', 0))}")
                md.append(f"- –ú–∏–Ω–∏–º—É–º: {self.format_number(all_stats.get('min', 0))}")
                md.append(f"- –ú–∞–∫—Å–∏–º—É–º: {self.format_number(all_stats.get('max', 0))}")
                md.append("")

            md.append("</details>")
            md.append("")

        # –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
        if log.adjustments:
            md.append("<details>")
            md.append("<summary><strong>–ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</strong></summary>")
            md.append("")

            md.append("| –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç | –í–ª–∏—è–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |")
            md.append("|--------------|-------------|---------|----------|")

            for adj_name, adj_data in log.adjustments.items():
                if isinstance(adj_data, dict):
                    coef = adj_data.get('value', 1.0)
                    desc = adj_data.get('description', '')
                    percent = (coef - 1) * 100
                    sign = '+' if percent > 0 else ''
                    md.append(f"| {adj_name} | {coef:.4f} | {sign}{percent:.2f}% | {desc} |")

            md.append("")
            md.append("</details>")
            md.append("")

        # –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
        md.append("<details>")
        md.append("<summary><strong>–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</strong></summary>")
        md.append("")

        md.append("**–ö–∞–∫ –º—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—É—é —Ü–µ–Ω—É:**")
        md.append("")
        md.append("1. **–°–±–æ—Ä –∞–Ω–∞–ª–æ–≥–æ–≤**")
        md.append("   - –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Ç–æ–º –∂–µ —Ä–∞–π–æ–Ω–µ")
        md.append("   - –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–ª–æ—â–∞–¥–∏ (¬±20%), —ç—Ç–∞–∂—É, —Ç–∏–ø—É –¥–æ–º–∞")
        md.append("")

        md.append("2. **–ú–µ–¥–∏–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**")
        md.append("   - –ë–µ—Ä–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –∏–∑ –≤—Å–µ—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ (–º–µ–¥–∏–∞–Ω—É)")
        md.append("   - –ú–µ–¥–∏–∞–Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ –≤—ã–±—Ä–æ—Å–∞–º (1-2 —Å–∏–ª—å–Ω–æ –∑–∞–≤—ã—à–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞ –Ω–µ –∏—Å–ø–æ—Ä—Ç—è—Ç –∫–∞—Ä—Ç–∏–Ω—É)")
        md.append("")

        md.append("3. **–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏**")
        md.append("   - –£—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç–ª–∏—á–∏—è –≤–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞: —Ä–µ–º–æ–Ω—Ç, –≤–∏–¥ –∏–∑ –æ–∫–æ–Ω, —ç—Ç–∞–∂ –∏ —Ç.–¥.")
        md.append("   - –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç–æ—Ä –∏–º–µ–µ—Ç –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–ª–∏—è–Ω–∏—è")
        md.append("")

        md.append("4. **–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω**")
        md.append("   - –ú–∏–Ω–∏–º—É–º: —Ü–µ–Ω–∞ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏ (-5% –æ—Ç —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π)")
        md.append("   - –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è: –º–µ–¥–∏–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫")
        md.append("   - –ú–∞–∫—Å–∏–º—É–º: –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏ –∏–¥–µ–∞–ª—å–Ω–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ (+5-7%)")
        md.append("")

        md.append("**–ü—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏:**")
        md.append("")
        md.append("–û—Å–Ω–æ–≤–∞–Ω –Ω–∞:")
        md.append("- –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤–∞—à–µ–π —Ü–µ–Ω—ã –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π –º–µ–¥–∏–∞–Ω—ã")
        md.append("- –ò–Ω–¥–µ–∫—Å–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞")
        md.append("- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤")
        md.append("")

        md.append("> **–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ - –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.")
        md.append("> –†–µ–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫ —Å–ª–æ–∂–Ω–µ–µ: –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –≤–ª–∏—è—é—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞, –∫–∞—á–µ—Å—Ç–≤–æ")
        md.append("> –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –¥–∞–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è. –¶–∏—Ñ—Ä—ã –¥–∞—é—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä,")
        md.append("> –Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —É—Å–ø–µ—Ö –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.")
        md.append("")

        md.append("</details>")
        md.append("")

        # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if hasattr(log, 'attractiveness_index') and log.attractiveness_index:
            md.append("<details>")
            md.append("<summary><strong>–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</strong></summary>")
            md.append("")

            attr = log.attractiveness_index
            total = attr.get('total_index', 0)

            md.append(f"**–í–∞—à –∏–Ω–¥–µ–∫—Å: {total:.0f}/100**")
            md.append("")
            md.append("–≠—Ç–æ –ù–ï \"–∫–∞—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä—ã\", –∞ \"–Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –µ—ë –ø—Ä–æ–¥–∞—Ç—å\".")
            md.append("")
            md.append("–ú—ã —É—á–∏—Ç—ã–≤–∞–µ–º:")
            md.append("- –¶–µ–Ω—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞ (—É –≤–∞—Å –∑–∞–≤—ã—à–µ–Ω–∞/–∑–∞–Ω–∏–∂–µ–Ω–∞?)")
            md.append("- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–ø–ª–æ—â–∞–¥—å, —ç—Ç–∞–∂, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞)")
            md.append("- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é (—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤)")
            md.append("- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å (—á–µ–º –≤—ã–¥–µ–ª—è–µ—Ç–µ—Å—å)")
            md.append("")

            if total >= 80:
                md.append("**80-100: –û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å**")
                md.append("- –û–±—ä–µ–∫—Ç –ª–µ–≥–∫–æ –ø—Ä–æ–¥–∞–µ—Ç—Å—è")
                md.append("- –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞")
            elif total >= 60:
                md.append("**60-80: –•–æ—Ä–æ—à–∞—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å**")
                md.append("- –ü—Ä–æ–¥–∞—Ç—å –º–æ–∂–Ω–æ, –Ω–æ –Ω—É–∂–Ω—ã —É—Å–∏–ª–∏—è")
                md.append("- –ö—Ä–∏—Ç–∏—á–Ω–æ: –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ")
            else:
                md.append("**–ù–∏–∂–µ 60: –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ**")
                md.append("- –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∏–ª–∏ –∑–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞")
                md.append("- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: —Å–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—É –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é")

            md.append("")
            md.append("**–ö–∞–∫ –ø–æ–¥–Ω—è—Ç—å –∏–Ω–¥–µ–∫—Å:**")
            md.append("- –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—É –±–ª–∏–∂–µ –∫ –º–µ–¥–∏–∞–Ω–µ —Ä—ã–Ω–∫–∞")
            md.append("- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ (—ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ)")
            md.append("- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ –∫–æ–ø–∏–ø–∞—Å—Ç–∞)")
            md.append("- –ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ (–±–æ–ª—å—à–µ –æ—Ö–≤–∞—Ç = –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤)")
            md.append("")

            md.append("</details>")
            md.append("")

        # Footer
        md.append("---")
        md.append("")
        md.append(f"*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*")
        md.append("")
        md.append("*–≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ç–µ–∫—É—â–∏—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.")
        md.append("–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –æ —Ü–µ–Ω–µ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–¥–∞–∂–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞ –≤–∞–º–∏.*")

        return "\n".join(md)

    def export_multiple_properties(self, logs: List[PropertyLog]) -> str:
        """–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –æ–¥–∏–Ω Markdown —Ñ–∞–π–ª"""
        md = []

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ
        md.append("# –û—Ç—á–µ—Ç –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏")
        md.append("")
        md.append(f"**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        md.append(f"**–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤:** {len(logs)}")
        md.append("")

        # –°–≤–æ–¥–∫–∞
        completed = sum(1 for log in logs if log.status == 'completed')
        failed = sum(1 for log in logs if log.status == 'failed')
        processing = sum(1 for log in logs if log.status == 'processing')

        md.append("## –°–≤–æ–¥–∫–∞")
        md.append("")
        md.append(f"- –£—Å–ø–µ—à–Ω–æ: {completed}")
        md.append(f"- –û—à–∏–±–∫–∏: {failed}")
        md.append(f"- –í –ø—Ä–æ—Ü–µ—Å—Å–µ: {processing}")
        md.append("")
        md.append("---")
        md.append("")

        # –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
        md.append("## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ")
        md.append("")
        for i, log in enumerate(logs, 1):
            status_mark = {'completed': 'OK', 'failed': 'FAIL', 'processing': 'WIP'}.get(log.status, '?')
            md.append(f"{i}. [{status_mark}] [{log.property_id}](#{log.property_id})")

        md.append("")
        md.append("---")
        md.append("")

        # –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
        for log in logs:
            md.append(f'<a name="{log.property_id}"></a>')
            md.append("")
            md.append(self.export_single_property(log))
            md.append("")
            md.append("---")
            md.append("")

        return "\n".join(md)

    def export_tracker_summary(self, tracker: PropertyTracker) -> str:
        """–≠–∫—Å–ø–æ—Ä—Ç –∫—Ä–∞—Ç–∫–æ–π —Å–≤–æ–¥–∫–∏ –ø–æ –≤—Å–µ–º –æ–±—ä–µ–∫—Ç–∞–º"""
        summary = tracker.get_summary()
        logs = tracker.get_all_logs()

        md = []

        md.append("# –°–≤–æ–¥–∫–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–∫—Ç–æ–≤")
        md.append("")
        md.append(f"**–î–∞—Ç–∞:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        md.append("")

        md.append("## –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        md.append("")
        md.append(f"- **–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤:** {summary['total']}")
        md.append(f"- **–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:** {summary['completed']} ({summary['success_rate']:.1f}%)")
        md.append(f"- **–û—à–∏–±–∫–∏:** {summary['failed']}")
        md.append(f"- **–í –ø—Ä–æ—Ü–µ—Å—Å–µ:** {summary['processing']}")
        md.append("")

        # –¢–∞–±–ª–∏—Ü–∞ –æ–±—ä–µ–∫—Ç–æ–≤
        md.append("## –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤")
        md.append("")
        md.append("| ID | URL | –°—Ç–∞—Ç—É—Å | –ù–∞—á–∞–ª–æ | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ |")
        md.append("|----|-----|--------|--------|-----------|")

        for log in logs:
            status_mark = {'completed': 'OK', 'failed': 'FAIL', 'processing': 'WIP'}.get(log.status, '?')
            url_link = f"[—Å—Å—ã–ª–∫–∞]({log.url})" if log.url else "-"
            start_time = datetime.fromisoformat(log.started_at).strftime('%H:%M:%S')
            end_time = datetime.fromisoformat(log.completed_at).strftime('%H:%M:%S') if log.completed_at else "-"

            md.append(f"| {log.property_id} | {url_link} | {status_mark} | {start_time} | {end_time} |")

        md.append("")

        return "\n".join(md)

    def _get_event_emoji(self, event_type: EventType) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä–∫–µ—Ä –¥–ª—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è"""
        emoji_map = {
            EventType.PARSING_STARTED: "[PARSE]",
            EventType.PARSING_COMPLETED: "[OK]",
            EventType.PARSING_FAILED: "[FAIL]",
            EventType.DATA_EXTRACTED: "[DATA]",
            EventType.ANALYSIS_STARTED: "[ANALYZE]",
            EventType.ANALYSIS_COMPLETED: "[OK]",
            EventType.ANALYSIS_FAILED: "[FAIL]",
            EventType.MARKET_STATS_CALCULATED: "[STATS]",
            EventType.OUTLIERS_FILTERED: "[FILTER]",
            EventType.FAIR_PRICE_CALCULATED: "[PRICE]",
            EventType.ADJUSTMENT_APPLIED: "[ADJUST]",
            EventType.SCENARIOS_GENERATED: "[SCENARIOS]",
            EventType.WARNING: "[WARN]",
            EventType.ERROR: "[ERROR]"
        }
        return emoji_map.get(event_type, "[INFO]")
