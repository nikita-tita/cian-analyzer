#!/usr/bin/env python3
"""
Генератор статей для блога с рерайтом через Yandex GPT
Создает качественные статьи на основе актуальных тем недвижимости
"""

import os
from dotenv import load_dotenv
from pathlib import Path
from yandex_gpt import YandexGPT
from blog_database import BlogDatabase
import logging
from datetime import datetime, timedelta

# Load .env
env_path = Path(__file__).parent / '.env'
if env_path.exists():
    load_dotenv(env_path)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Темы статей для CIAN (актуальные тренды недвижимости)
CIAN_TOPICS = [
    {
        "title": "Льготная ипотека 2025: кто может получить и как оформить",
        "source_url": "https://spb.cian.ru/magazine/",
        "content": """Льготная ипотека остается одним из главных инструментов поддержки покупателей жилья в 2025 году. Ставки по семейной ипотеке составляют от 6% годовых, по IT-ипотеке — от 5%. Программы доступны для семей с детьми, IT-специалистов и молодых семей до 35 лет.\n\nОсновные требования: первоначальный взнос от 15%, подтвержденный доход, российское гражданство. Для семейной ипотеки необходим ребенок, рожденный с 2018 года. Максимальная сумма кредита в Санкт-Петербурге — до 12 млн рублей.\n\nВажно учитывать, что банки устанавливают дополнительные требования к заемщикам. Стаж работы должен составлять минимум 6 месяцев на последнем месте, общий трудовой стаж — от 1 года. Кредитная история проверяется особенно тщательно.\n\nДля оформления потребуются документы: паспорт, СНИЛС, свидетельство о рождении детей, справка о доходах по форме 2-НДФЛ или справка по форме банка. Срок рассмотрения заявки — от 2 до 5 рабочих дней."""
    },
    {
        "title": "Апартаменты vs квартира: что выгоднее купить в 2025",
        "source_url": "https://spb.cian.ru/magazine/",
        "content": """Выбор между апартаментами и квартирой — частый вопрос покупателей недвижимости. Апартаменты дешевле на 15-20%, но имеют статус нежилого помещения. Это влияет на коммунальные платежи и возможность прописки.\n\nПреимущества апартаментов: свободная планировка, возможность коммерческого использования, часто более выгодное расположение в центре города. Инфраструктура комплексов с апартаментами обычно более развита — консьерж, фитнес-зал, подземная парковка.\n\nНедостатки: высокие коммунальные платежи (как для коммерческой недвижимости), сложности с пропиской, не все банки дают ипотеку на апартаменты. При продаже апартаменты менее ликвидны.\n\nКвартира подходит для постоянного проживания и семей с детьми. Апартаменты — для инвестиций, сдачи в аренду или офиса. При выборе важно учитывать цели покупки и финансовые возможности."""
    },
    {
        "title": "Как проверить застройщика перед покупкой новостройки",
        "source_url": "https://spb.cian.ru/magazine/",
        "content": """Проверка застройщика — критически важный этап перед покупкой квартиры в новостройке. От надежности компании зависит, получите ли вы жилье вовремя и в заявленном качестве.\n\nПервый шаг — проверка в реестре проблемных объектов на сайте Единой информационной системы жилищного строительства (ЕИСЖС). Любой объект должен быть в реестре с проектной декларацией.\n\nВажно изучить финансовые показатели застройщика: выручку, прибыль, кредиторскую задолженность. Эти данные доступны в открытых источниках — СПАРК, Контур.Фокус. Количество одновременно строящихся объектов не должно превышать финансовые возможности компании.\n\nПроверьте репутацию: отзывы дольщиков, судебные дела, сроки сдачи предыдущих объектов. Осмотрите стройплощадку лично — темпы работ должны соответствовать графику. Изучите договор долевого участия — все условия должны быть прозрачны.\n\nОбратите внимание на проектную документацию: планировки, материалы, инфраструктуру. Надежный застройщик предоставляет полную информацию и открыт к диалогу."""
    },
]

# Темы для RBC (экономика и аналитика недвижимости)
RBC_TOPICS = [
    {
        "title": "Рынок недвижимости Петербурга: прогноз на 2025 год",
        "source_url": "https://realty.rbc.ru/",
        "content": """Эксперты прогнозируют рост цен на недвижимость в Санкт-Петербурге на 8-12% в 2025 году. Основные факторы: ограниченное предложение в центральных районах, высокий спрос за счет переезжающих из других регионов, инфляция.\n\nНаиболее перспективные районы для инвестиций — Приморский, Красносельский, Фрунзенский. Здесь активно развивается инфраструктура, строятся станции метро, открываются школы и детские сады.\n\nВторичный рынок показывает большую стабильность, чем первичный. Разрыв в ценах между новостройками и вторичным жильем сокращается. В премиум-сегменте спрос остается на уровне 2024 года.\n\nДля покупателей выгодный момент — начало года, когда застройщики предлагают акции и скидки. Эксперты рекомендуют покупать на этапе котлована при надежных застройщиках — экономия до 20%."""
    },
    {
        "title": "Коммерческая недвижимость: тренды и перспективы",
        "source_url": "https://realty.rbc.ru/",
        "content": """Рынок коммерческой недвижимости Петербурга трансформируется. Офисные помещения теряют популярность из-за удаленной работы, зато растет спрос на коворкинги и гибридные форматы.\n\nСтрит-ритейл восстанавливается после пандемии. Популярны помещения площадью 50-150 кв.м в жилых районах — под кафе, салоны красоты, магазины у дома. Доходность таких объектов — 8-10% годовых.\n\nСкладская недвижимость показывает рекордный рост. Развитие e-commerce требует новых логистических мощностей. Vacancy rate снижается, ставки аренды растут на 12-15% в год.\n\nИнвестиции в коммерческую недвижимость требуют большего опыта, чем в жилую. Важно учитывать локацию, целевую аудиторию, конкуренцию. Средний срок окупаемости — 7-10 лет при грамотном управлении."""
    },
]


def generate_and_save_articles(topics, source_name):
    """Генерирует статьи и сохраняет в базу"""
    gpt = YandexGPT()
    db = BlogDatabase()

    logger.info(f"Генерация статей из {source_name}...")
    published_count = 0

    for i, topic in enumerate(topics):
        try:
            logger.info(f"[{i+1}/{len(topics)}] {topic['title']}")

            # Создаем slug
            from blog_parser_playwright import CianMagazineParserPlaywright
            parser = CianMagazineParserPlaywright()
            slug = parser.create_slug(topic['title'])

            # Проверяем существование
            if db.post_exists(slug):
                logger.info(f"  Статья уже существует: {slug}")
                continue

            # Рерайт через Yandex GPT
            logger.info("  Рерайт через Yandex GPT...")
            rewritten = gpt.rewrite_article(
                original_title=topic['title'],
                original_content=topic['content'],
                original_excerpt=None
            )

            # Дата публикации (распределяем статьи по времени)
            pub_date = datetime.now() - timedelta(days=i*3)

            # Сохраняем
            post_id = db.create_post(
                slug=slug,
                title=rewritten['title'],
                content=rewritten['content'],
                excerpt=rewritten['excerpt'],
                original_url=topic['source_url'],
                original_title=topic['title'],
                published_at=pub_date.isoformat()
            )

            logger.info(f"  ✓ Опубликовано (ID: {post_id})")
            published_count += 1

        except Exception as e:
            logger.error(f"  ✗ Ошибка: {e}")
            continue

    logger.info(f"{source_name}: опубликовано {published_count}/{len(topics)} статей\n")
    return published_count


if __name__ == '__main__':
    logger.info("=" * 60)
    logger.info("Генерация статей для блога")
    logger.info("=" * 60)

    # CIAN статьи
    cian_count = generate_and_save_articles(CIAN_TOPICS, "CIAN Magazine")

    # RBC статьи
    rbc_count = generate_and_save_articles(RBC_TOPICS, "RBC Realty")

    logger.info("=" * 60)
    logger.info(f"ИТОГО: {cian_count + rbc_count} новых статей")
    logger.info("=" * 60)
